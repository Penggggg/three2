"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("./util/http");
var prodEnv = 'prod-b87b76';
App({
    globalData$: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true
    },
    globalData: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true
    },
    watchCallBack: {},
    watchingKeys: [],
    init: function () {
        var _this = this;
        var that = this;
        this.globalData$ = Object.assign({}, this.globalData);
        Object.keys(this.globalData).map(function (key) {
            Object.defineProperty(_this.globalData, key, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    var old = that.globalData$[key];
                    that.globalData$[key] = val;
                    if (Array.isArray(that.watchCallBack[key])) {
                        that.watchCallBack[key].map(function (func) { return func(val, old); });
                    }
                },
                get: function () {
                    return that.globalData$[key];
                }
            });
        });
        wx.getSetting({
            success: function (res) {
                var isUserAuth = res.authSetting['scope.userInfo'];
                _this.setGlobalData({
                    isUserAuth: isUserAuth === undefined ? false : isUserAuth
                });
            }
        });
    },
    initCloud: function () {
        return new Promise(function (resolve, reject) {
            wx.cloud.init({
                traceUser: true,
                env: prodEnv
            });
            resolve();
        });
    },
    getIsNewCustom: function () {
        var _this = this;
        http_1.http({
            url: 'common_is-new-customer',
            success: function (res) {
                _this.setGlobalData({
                    isNew: res.data
                });
            }
        });
    },
    getWxUserInfo: function (cb) {
        var _this = this;
        wx.getUserInfo({
            success: function (res) {
                http_1.http({
                    data: res.userInfo,
                    url: 'common_userEdit',
                    success: function (res2) {
                        if (res2 && res2.status === 200) {
                            _this.setGlobalData({
                                isUserAuth: true,
                                userInfo: res.userInfo
                            });
                            cb && cb();
                        }
                    }
                });
            }
        });
    },
    getUserInfo: function () {
        var _this = this;
        wx.cloud.callFunction({
            name: 'login'
        }).then(function (res) {
            _this.setGlobalData(res.result);
        });
    },
    setGlobalData: function (obj) {
        var _this = this;
        console.log('【---- Global Set ----】', obj);
        Object.keys(obj).map(function (key) {
            _this.globalData[key] = obj[key];
        });
    },
    watch$: function (key, cb) {
        var _this = this;
        var _a;
        this.watchCallBack = Object.assign({}, this.watchCallBack, (_a = {},
            _a[key] = this.watchCallBack[key] || [],
            _a));
        this.watchCallBack[key].push(cb);
        setTimeout(function () {
            var val = _this.globalData$[key];
            var old = _this.globalData[key];
            cb(val, old);
        }, 0);
        if (!this.watchingKeys.find(function (x) { return x === key; })) {
            var that = this;
            this.watchingKeys.push(key);
        }
    },
    onLaunch: function () {
        var _this = this;
        this.init();
        this.initCloud()
            .then(function () {
            _this.getUserInfo();
            _this.getIsNewCustom();
        })
            .catch(function (e) {
            wx.showToast({
                icon: 'none',
                duration: 2000,
                title: '数据库初始错误'
            });
        });
    }
});
var Role;
(function (Role) {
    Role[Role["normal"] = 0] = "normal";
    Role[Role["admin"] = 1] = "admin";
})(Role || (Role = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW1DO0FBRW5DLElBQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQztBQUU5QixHQUFHLENBQVE7SUFHUCxXQUFXLEVBQUU7UUFFVCxJQUFJLEVBQUUsQ0FBQztRQUVQLE1BQU0sRUFBRSxFQUFFO1FBRVYsVUFBVSxFQUFFLEtBQUs7UUFFakIsUUFBUSxFQUFFLElBQUk7UUFFZCxLQUFLLEVBQUUsSUFBSTtLQUNkO0lBR0QsVUFBVSxFQUFFO1FBQ1IsSUFBSSxFQUFFLENBQUM7UUFDUCxNQUFNLEVBQUUsRUFBRTtRQUNWLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLFFBQVEsRUFBRSxJQUFJO1FBQ2QsS0FBSyxFQUFFLElBQUk7S0FDZDtJQUdELGFBQWEsRUFBRSxFQUFHO0lBR2xCLFlBQVksRUFBRSxFQUFHO0lBR2pCLElBQUk7UUFBSixpQkFvQ0M7UUFsQ0csSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBR2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxDQUFDO1FBR3hELE1BQU0sQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxDQUFDLEdBQUcsQ0FBRSxVQUFBLEdBQUc7WUFDbkMsTUFBTSxDQUFDLGNBQWMsQ0FBRSxLQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtnQkFDekMsWUFBWSxFQUFFLElBQUk7Z0JBQ2xCLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixHQUFHLEVBQUUsVUFBVSxHQUFHO29CQUNkLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUUsR0FBRyxDQUFFLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUUsR0FBRyxDQUFFLEdBQUcsR0FBRyxDQUFDO29CQUM5QixJQUFLLEtBQUssQ0FBQyxPQUFP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QUFNO2dCQUNaLFFBQVEsRUFBRSxJQUFJO2dCQUNkLEtBQUssRUFBRSxTQUFTO2FBQ25CLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFBO0lBRVYsQ0FBQztDQUNKLENBQUMsQ0FBQztBQWtCSCxJQUFLLElBR0o7QUFIRCxXQUFLLElBQUk7SUFDTCxtQ0FBTSxDQUFBO0lBQ04saUNBQUssQ0FBQTtBQUNULENBQUMsRUFISSxJQUFJLEtBQUosSUFBSSxRQUdSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaHR0cCB9IGZyb20gJy4vdXRpbC9odHRwJztcblxuY29uc3QgcHJvZEVudiA9ICdwcm9kLWI4N2I3Nic7XG5cbkFwcDxNeUFwcD4oe1xuXG4gICAgLyoqIGZhZGUgZ2xvYmFsRGF0YSAqL1xuICAgIGdsb2JhbERhdGEkOiB7XG4gICAgICAgIC8vIOeZu+W9leS6uuadg+mZkFxuICAgICAgICByb2xlOiAwLFxuICAgICAgICAvLyDnmbvlvZXkurppZFxuICAgICAgICBvcGVuaWQ6ICcnLFxuICAgICAgICAvLyDmmK/lkKblt7Lnu4/mjojmnYPnlKjmiLfkv6Hmga9cbiAgICAgICAgaXNVc2VyQXV0aDogZmFsc2UsXG4gICAgICAgIC8vIOeUqOaIt+S/oeaBr1xuICAgICAgICB1c2VySW5mbzogbnVsbCxcbiAgICAgICAgLyoqIOaYr+WQpuaYr+aWsOWuouaItyAqL1xuICAgICAgICBpc05ldzogdHJ1ZVxuICAgIH0sXG5cbiAgICAvKiog5YWo5bGAc3RvcmUgKi9cbiAgICBnbG9iYWxEYXRhOiB7XG4gICAgICAgIHJvbGU6IDAsXG4gICAgICAgIG9wZW5pZDogJycsXG4gICAgICAgIGlzVXNlckF1dGg6IGZhbHNlLFxuICAgICAgICB1c2VySW5mbzogbnVsbCxcbiAgICAgICAgaXNOZXc6IHRydWVcbiAgICB9LFxuXG4gICAgLyoqIOebkeWQrOWHveaVsOeahOWvueixoeaVsOe7hCAqL1xuICAgIHdhdGNoQ2FsbEJhY2s6IHsgfSxcblxuICAgIC8qKiDnm5HlkKzliJfooaggKi9cbiAgICB3YXRjaGluZ0tleXM6IFsgXSxcblxuICAgIC8qKiDliJ3lp4vljJYgKi9cbiAgICBpbml0KCApIHtcblxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgIC8vIOWFqOWxgOaVsOaNrlxuICAgICAgICB0aGlzLmdsb2JhbERhdGEkID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMuZ2xvYmFsRGF0YSApO1xuXG4gICAgICAgIC8vIHdhdGNoXG4gICAgICAgIE9iamVjdC5rZXlzKCB0aGlzLmdsb2JhbERhdGEgKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMuZ2xvYmFsRGF0YSwga2V5LCB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiggdmFsICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGQgPSB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5nbG9iYWxEYXRhJFsga2V5IF0gPSB2YWw7XG4gICAgICAgICAgICAgICAgICAgIGlmICggQXJyYXkuaXNBcnJheSggdGhhdC53YXRjaENhbGxCYWNrWyBrZXkgXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0ubWFwKGZ1bmMgPT4gZnVuYyggdmFsLCBvbGQgKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIOeUqOaIt+S/oeaBr1xuICAgICAgICB3eC5nZXRTZXR0aW5nKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgLy8g5piv5ZCm5bey57uP5o6I5p2DXG4gICAgICAgICAgICAgICAgY29uc3QgaXNVc2VyQXV0aCA9IHJlcy5hdXRoU2V0dGluZ1snc2NvcGUudXNlckluZm8nXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc1VzZXJBdXRoOiBpc1VzZXJBdXRoID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IGlzVXNlckF1dGhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9LFxuXG4gICAgLyoqIOWIneWni+WMluS6keWHveaVsOaVsOaNruW6kyAqL1xuICAgIGluaXRDbG91ZCggKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoIHJlc29sdmUsIHJlamVjdCApID0+IHtcblxuICAgICAgICAgICAgLy8g5LqRXG4gICAgICAgICAgICB3eC5jbG91ZC5pbml0KHtcbiAgICAgICAgICAgICAgICB0cmFjZVVzZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgZW52OiBwcm9kRW52XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc29sdmUoICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog5piv5ZCm5Li65paw5a6iICovXG4gICAgZ2V0SXNOZXdDdXN0b20oICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIHVybDogJ2NvbW1vbl9pcy1uZXctY3VzdG9tZXInLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc05ldzogcmVzLmRhdGFcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKiog5YWo5bGA5pa55rOV77yM6I635Y+W5b6u5L+h55So5oi355m75b2V5L+h5oGv44CB5o6I5p2D44CB5LiK5Lyg5L+d5a2YICovXG4gICAgZ2V0V3hVc2VySW5mbyggY2IgKSB7XG4gICAgICAgIHd4LmdldFVzZXJJbmZvKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlcy51c2VySW5mbyxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAnY29tbW9uX3VzZXJFZGl0JyxcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogcmVzMiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlczIgJiYgcmVzMi5zdGF0dXMgPT09IDIwMCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1VzZXJBdXRoOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VySW5mbzogcmVzLnVzZXJJbmZvXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IgJiYgY2IoICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqIOiOt+WPlueUqOaIt+adg+mZkOS/oeaBryByb2xlLyBvcGVuaWQgKi9cbiAgICBnZXRVc2VySW5mbyggKSB7XG4gICAgICAgIHd4LmNsb3VkLmNhbGxGdW5jdGlvbih7XG4gICAgICAgICAgICBuYW1lOiAnbG9naW4nXG4gICAgICAgIH0pLnRoZW4oKCByZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKCByZXMucmVzdWx0ICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog6K6+572u5YWo5bGA5pWw5o2uICovXG4gICAgc2V0R2xvYmFsRGF0YSggb2JqICkge1xuICAgICAgICBjb25zb2xlLmxvZyggJ+OAkC0tLS0gR2xvYmFsIFNldCAtLS0t44CRJywgb2JqIClcbiAgICAgICAgT2JqZWN0LmtleXMoIG9iaiApLm1hcCgga2V5ID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2xvYmFsRGF0YVsga2V5IF0gPSBvYmpbIGtleSBdO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIHdhdGNo5Ye95pWwICovXG4gICAgd2F0Y2gkKCBrZXksIGNiICkge1xuICAgICAgICB0aGlzLndhdGNoQ2FsbEJhY2sgPSBPYmplY3QuYXNzaWduKHsgfSwgdGhpcy53YXRjaENhbGxCYWNrLCB7XG4gICAgICAgICAgICBbIGtleSBdOiB0aGlzLndhdGNoQ2FsbEJhY2tbIGtleSBdIHx8IFsgXVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy53YXRjaENhbGxCYWNrWyBrZXkgXS5wdXNoKCBjYiApO1xuICAgICAgICAvLyDnq4vpqazmiafooYzkuIDkuItjYlxuICAgICAgICBzZXRUaW1lb3V0KCggKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgIGNvbnN0IG9sZCA9IHRoaXMuZ2xvYmFsRGF0YVsga2V5IF07XG4gICAgICAgICAgICBjYiggdmFsLCBvbGQgKTtcbiAgICAgICAgfSwgMCApO1xuXG4gICAgICAgIC8vIOaJp+ihjHNldOeahOaXtuWAme+8jOWGjeaJp+ihjOS4gOS4i2NiXG4gICAgICAgIGlmICggIXRoaXMud2F0Y2hpbmdLZXlzLmZpbmQoIHggPT4geCA9PT0ga2V5ICkpIHtcbiAgICAgICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgdGhpcy53YXRjaGluZ0tleXMucHVzaCgga2V5ICk7XG4gICAgICAgICAgICAvLyBPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMuZ2xvYmFsRGF0YSwga2V5LCB7XG4gICAgICAgICAgICAvLyAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgLy8gICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAvLyAgICAgc2V0OiBmdW5jdGlvbiggdmFsICkge1xuICAgICAgICAgICAgLy8gICAgICAgICBjb25zb2xlLmxvZyhgJHtrZXl96KKrc2V0YCwgdmFsICk7XG4gICAgICAgICAgICAvLyAgICAgICAgIGNvbnN0IG9sZCA9IHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgLy8gICAgICAgICB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXSA9IHZhbDtcbiAgICAgICAgICAgIC8vICAgICAgICAgdGhhdC53YXRjaENhbGxCYWNrWyBrZXkgXS5tYXAoZnVuYyA9PiBmdW5jKCB2YWwsIG9sZCApKTtcbiAgICAgICAgICAgIC8vICAgICB9LFxuICAgICAgICAgICAgLy8gICAgIGdldDogZnVuY3Rpb24oICkge1xuICAgICAgICAgICAgLy8gICAgICAgICByZXR1cm4gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAvLyAgICAgfVxuICAgICAgICAgICAgLy8gfSk7XG4gICAgICAgIH1cbiAgICB9LFxuICBcbiAgICAvKiog55Sf5ZG95ZGo5pyfICovXG4gICAgb25MYXVuY2g6IGZ1bmN0aW9uKCApIHtcbiAgICAgICAgdGhpcy5pbml0KCApO1xuICAgICAgICB0aGlzLmluaXRDbG91ZCggKVxuICAgICAgICAgICAgLnRoZW4oKCApID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFVzZXJJbmZvKCApO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0SXNOZXdDdXN0b20oICk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKCBlID0+IHtcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgICBpY29uOiAnbm9uZScsXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ+aVsOaNruW6k+WIneWni+mUmeivrydcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIFxuICAgIH1cbn0pO1xuXG5leHBvcnQgaW50ZXJmYWNlIE15QXBwIHtcbiAgICBnbG9iYWxEYXRhOiBnbG9iYWxTdGF0ZSxcbiAgICBnbG9iYWxEYXRhJDogZ2xvYmFsU3RhdGUsXG4gICAgd2F0Y2hDYWxsQmFjazoge1xuICAgICAgICBbIGtleTogc3RyaW5nIF06ICgoIHZhbDE6IGFueSwgdmFsMjogYW55ICkgPT4gdm9pZClbIF1cbiAgICB9XG4gICAgd2F0Y2hpbmdLZXlzOiBzdHJpbmdbIF1cbiAgICBpbml0OiAoICkgPT4gdm9pZFxuICAgIGluaXRDbG91ZDogKCApID0+IFByb21pc2U8YW55PlxuICAgIGdldFVzZXJJbmZvOiAoICkgPT4gdm9pZCxcbiAgICBnZXRJc05ld0N1c3RvbTogICggKSA9PiB2b2lkLFxuICAgIGdldFd4VXNlckluZm86ICggY2I/OiAoICkgPT4gdm9pZCApID0+IHZvaWQsXG4gICAgc2V0R2xvYmFsRGF0YTogPEsgZXh0ZW5kcyBrZXlvZiBnbG9iYWxTdGF0ZT4oIGRhdGE6IGdsb2JhbFN0YXRlIHwgUGljazxnbG9iYWxTdGF0ZSwgSz4gKSA9PiB2b2lkLFxuICAgIHdhdGNoJDogKCBrZXk6IGtleW9mIGdsb2JhbFN0YXRlLCBhbnkgKSA9PiB2b2lkXG59XG5cbmVudW0gUm9sZSB7XG4gICAgbm9ybWFsLFxuICAgIGFkbWluXG59XG5cbnR5cGUgZ2xvYmFsU3RhdGUgPSB7XG4gICAgcm9sZTogUm9sZSxcbiAgICBvcGVuaWQ6IHN0cmluZyxcbiAgICBpc1VzZXJBdXRoOiBib29sZWFuLFxuICAgIHVzZXJJbmZvOiBhbnlcbiAgICBpc05ldzogYm9vbGVhblxufSJdfQ==