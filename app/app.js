"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("./util/http");
var cloudEnv = undefined;
App({
    globalData$: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: {},
        isNew: true,
        editingGood: {},
        appConfig: {}
    },
    globalData: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true,
        editingGood: null,
        appConfig: null
    },
    watchCallBack: {},
    watchingKeys: [],
    init: function () {
        var _this = this;
        var that = this;
        this.globalData$ = Object.assign({}, this.globalData);
        Object.keys(this.globalData).map(function (key) {
            Object.defineProperty(_this.globalData, key, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    var old = that.globalData$[key];
                    that.globalData$[key] = val;
                    if (Array.isArray(that.watchCallBack[key])) {
                        that.watchCallBack[key].map(function (func) { return func(val, old); });
                    }
                },
                get: function () {
                    return that.globalData$[key];
                }
            });
        });
        wx.getSetting({
            success: function (res) {
                var isUserAuth = res.authSetting['scope.userInfo'];
                _this.setGlobalData({
                    isUserAuth: isUserAuth === undefined ? false : isUserAuth
                });
            }
        });
    },
    initCloud: function () {
        return new Promise(function (resolve, reject) {
            wx.cloud.init({
                traceUser: true,
                env: cloudEnv
            });
            resolve();
        });
    },
    getIsNewCustom: function () {
        var _this = this;
        http_1.http({
            url: 'common_is-new-customer',
            success: function (res) {
                _this.setGlobalData({
                    isNew: res.data
                });
            }
        });
    },
    getAppConfig: function () {
        var _this = this;
        http_1.http({
            url: 'common_check-app-config',
            success: function (res) {
                if (res.status !== 200) {
                    return;
                }
                _this.setGlobalData({
                    appConfig: res.data
                });
            }
        });
    },
    getWxUserInfo: function (cb) {
        var _this = this;
        wx.getUserInfo({
            success: function (res) {
                http_1.http({
                    data: res.userInfo,
                    url: 'common_userEdit',
                    success: function (res2) {
                        if (res2 && res2.status === 200) {
                            _this.setGlobalData({
                                isUserAuth: true,
                                userInfo: res.userInfo
                            });
                            cb && cb();
                        }
                    }
                });
            }
        });
    },
    getUserInfo: function (cb) {
        var _this = this;
        wx.cloud.callFunction({
            name: 'login'
        }).then(function (res) {
            console.log('[LOGIN]', res.result);
            _this.setGlobalData(res.result);
            !!cb && cb();
        });
    },
    setGlobalData: function (obj) {
        var _this = this;
        console.log('【---- Global Set ----】', obj);
        Object.keys(obj).map(function (key) {
            _this.globalData[key] = obj[key];
        });
    },
    watch$: function (key, cb) {
        var _this = this;
        var _a;
        this.watchCallBack = Object.assign({}, this.watchCallBack, (_a = {},
            _a[key] = this.watchCallBack[key] || [],
            _a));
        this.watchCallBack[key].push(cb);
        setTimeout(function () {
            var val = _this.globalData$[key];
            var old = _this.globalData[key];
            cb(val, old);
        }, 0);
        if (!this.watchingKeys.find(function (x) { return x === key; })) {
            var that = this;
            this.watchingKeys.push(key);
        }
    },
    onLaunch: function () {
        var _this = this;
        this.init();
        this.initCloud()
            .then(function () {
            _this.getUserInfo();
            _this.getIsNewCustom();
            _this.getAppConfig();
        })
            .catch(function (e) {
            wx.showToast({
                icon: 'none',
                duration: 2000,
                title: '数据库初始错误'
            });
        });
    }
});
var Role;
(function (Role) {
    Role[Role["normal"] = 0] = "normal";
    Role[Role["admin"] = 1] = "admin";
})(Role || (Role = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW1DO0FBR25DLElBQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQztBQUUzQixHQUFHLENBQVE7SUFHUCxXQUFXLEVBQUU7UUFFVCxJQUFJLEVBQUUsQ0FBQztRQUVQLE1BQU0sRUFBRSxFQUFFO1FBRVYsVUFBVSxFQUFFLEtBQUs7UUFFakIsUUFBUSxFQUFFLEVBQUc7UUFFYixLQUFLLEVBQUUsSUFBSTtRQUVYLFdBQVcsRUFBRSxFQUFHO1FBRWhCLFNBQVMsRUFBRSxFQUFHO0tBQ2pCO0lBR0QsVUFBVSxFQUFFO1FBQ1IsSUFBSSxFQUFFLENBQUM7UUFDUCxNQUFNLEVBQUUsRUFBRTtRQUNWLFVBQVUsRUFBRSxLQUFLO1FBQ2pCLFFBQVEsRUFBRSxJQUFJO1FBQ2QsS0FBSyxFQUFFLElBQUk7UUFDWCxXQUFXLEVBQUUsSUFBSTtRQUNqQixTQUFTLEVBQUUsSUFBSTtLQUNsQjtJQUdELGFBQWEsRUFBRSxFQUFHO0lBR2xCLFlBQVksRUFBRSxFQUFHO0lBR2pCLElBQUk7UUFBSixpQkFvQ0M7UUFsQ0csSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBR2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxDQUFDO1FBR3hELE1BQU0sQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxDQUFDLEdBQUcsQ0FBRSxVQUFBLEdBQUc7WUFDbkMsTUFBTSxDQUFDLGNBQWMsQ0FBRSxLQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtnQkFDekMsWUFBWSxFQUFFLElBQUk7Z0JBQ2xCLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixHQUFHLEVBQUUsVUFBVSxHQUFHO29CQUNkLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUUsR0FBRyxDQUFF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LENBQUUsQ0FBQztRQUdQLElBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBRSxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsS0FBSyxHQUFHLEVBQVQsQ0FBUyxDQUFFLEVBQUU7WUFDNUMsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFFLEdBQUcsQ0FBRSxDQUFDO1NBY2pDO0lBQ0wsQ0FBQztJQUdELFFBQVEsRUFBRTtRQUFBLGlCQWdCVDtRQWZHLElBQUksQ0FBQyxJQUFJLEVBQUcsQ0FBQztRQUNiLElBQUksQ0FBQyxTQUFTLEVBQUc7YUFDWixJQUFJLENBQUM7WUFDRixLQUFJLENBQUMsV0FBVyxFQUFHLENBQUM7WUFDcEIsS0FBSSxDQUFDLGNBQWMsRUFBRyxDQUFDO1lBQ3ZCLEtBQUksQ0FBQyxZQUFZLEVBQUcsQ0FBQztRQUN6QixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUUsVUFBQSxDQUFDO1lBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDVCxJQUFJLEVBQUUsTUFBTTtnQkFDWixRQUFRLEVBQUUsSUFBSTtnQkFDZCxLQUFLLEVBQUUsU0FBUzthQUNuQixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQTtJQUVWLENBQUM7Q0FDSixDQUFDLENBQUM7QUFtQkgsSUFBSyxJQUdKO0FBSEQsV0FBSyxJQUFJO0lBQ0wsbUNBQU0sQ0FBQTtJQUNOLGlDQUFLLENBQUE7QUFDVCxDQUFDLEVBSEksSUFBSSxLQUFKLElBQUksUUFHUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGh0dHAgfSBmcm9tICcuL3V0aWwvaHR0cCc7XG5cbi8vIGNvbnN0IGNsb3VkRW52ID0gJ3Byb2QtYjg3Yjc2Jzs7XG5jb25zdCBjbG91ZEVudiA9IHVuZGVmaW5lZDtcblxuQXBwPE15QXBwPih7XG5cbiAgICAvKiogZmFkZSBnbG9iYWxEYXRhICovXG4gICAgZ2xvYmFsRGF0YSQ6IHtcbiAgICAgICAgLy8g55m75b2V5Lq65p2D6ZmQXG4gICAgICAgIHJvbGU6IDAsXG4gICAgICAgIC8vIOeZu+W9leS6umlkXG4gICAgICAgIG9wZW5pZDogJycsXG4gICAgICAgIC8vIOaYr+WQpuW3sue7j+aOiOadg+eUqOaIt+S/oeaBr1xuICAgICAgICBpc1VzZXJBdXRoOiBmYWxzZSxcbiAgICAgICAgLy8g55So5oi35L+h5oGvXG4gICAgICAgIHVzZXJJbmZvOiB7IH0sXG4gICAgICAgIC8qKiDmmK/lkKbmmK/mlrDlrqLmiLcgKi9cbiAgICAgICAgaXNOZXc6IHRydWUsXG4gICAgICAgIC8qKiDnvJbovpHkuK3nmoTllYblk4HmlbDmja4gKi9cbiAgICAgICAgZWRpdGluZ0dvb2Q6IHsgfSxcbiAgICAgICAgLyoqIGFwcOmFjee9riAqL1xuICAgICAgICBhcHBDb25maWc6IHsgfVxuICAgIH0sXG5cbiAgICAvKiog5YWo5bGAc3RvcmUgKi9cbiAgICBnbG9iYWxEYXRhOiB7XG4gICAgICAgIHJvbGU6IDAsXG4gICAgICAgIG9wZW5pZDogJycsXG4gICAgICAgIGlzVXNlckF1dGg6IGZhbHNlLFxuICAgICAgICB1c2VySW5mbzogbnVsbCxcbiAgICAgICAgaXNOZXc6IHRydWUsXG4gICAgICAgIGVkaXRpbmdHb29kOiBudWxsLFxuICAgICAgICBhcHBDb25maWc6IG51bGxcbiAgICB9LFxuXG4gICAgLyoqIOebkeWQrOWHveaVsOeahOWvueixoeaVsOe7hCAqL1xuICAgIHdhdGNoQ2FsbEJhY2s6IHsgfSxcblxuICAgIC8qKiDnm5HlkKzliJfooaggKi9cbiAgICB3YXRjaGluZ0tleXM6IFsgXSxcblxuICAgIC8qKiDliJ3lp4vljJYgKi9cbiAgICBpbml0KCApIHtcblxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgIC8vIOWFqOWxgOaVsOaNrlxuICAgICAgICB0aGlzLmdsb2JhbERhdGEkID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMuZ2xvYmFsRGF0YSApO1xuXG4gICAgICAgIC8vIHdhdGNoXG4gICAgICAgIE9iamVjdC5rZXlzKCB0aGlzLmdsb2JhbERhdGEgKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMuZ2xvYmFsRGF0YSwga2V5LCB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiggdmFsICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGQgPSB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5nbG9iYWxEYXRhJFsga2V5IF0gPSB2YWw7XG4gICAgICAgICAgICAgICAgICAgIGlmICggQXJyYXkuaXNBcnJheSggdGhhdC53YXRjaENhbGxCYWNrWyBrZXkgXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0ubWFwKGZ1bmMgPT4gZnVuYyggdmFsLCBvbGQgKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIOeUqOaIt+S/oeaBr1xuICAgICAgICB3eC5nZXRTZXR0aW5nKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgLy8g5piv5ZCm5bey57uP5o6I5p2DXG4gICAgICAgICAgICAgICAgY29uc3QgaXNVc2VyQXV0aCA9IHJlcy5hdXRoU2V0dGluZ1snc2NvcGUudXNlckluZm8nXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc1VzZXJBdXRoOiBpc1VzZXJBdXRoID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IGlzVXNlckF1dGhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9LFxuXG4gICAgLyoqIOWIneWni+WMluS6keWHveaVsOaVsOaNruW6kyAqL1xuICAgIGluaXRDbG91ZCggKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoIHJlc29sdmUsIHJlamVjdCApID0+IHtcblxuICAgICAgICAgICAgLy8g5LqRXG4gICAgICAgICAgICB3eC5jbG91ZC5pbml0KHtcbiAgICAgICAgICAgICAgICB0cmFjZVVzZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgZW52OiBjbG91ZEVudlxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXNvbHZlKCApO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOaYr+WQpuS4uuaWsOWuoiAqL1xuICAgIGdldElzTmV3Q3VzdG9tKCApIHtcbiAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICB1cmw6ICdjb21tb25faXMtbmV3LWN1c3RvbWVyJyxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgaXNOZXc6IHJlcy5kYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDojrflj5ZhcHDphY3nva4gKi9cbiAgICBnZXRBcHBDb25maWcoICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIHVybDogJ2NvbW1vbl9jaGVjay1hcHAtY29uZmlnJyxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCByZXMuc3RhdHVzICE9PSAyMDAgKSB7IHJldHVybjsgfVxuICAgICAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIGFwcENvbmZpZzogcmVzLmRhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqIOWFqOWxgOaWueazle+8jOiOt+WPluW+ruS/oeeUqOaIt+eZu+W9leS/oeaBr+OAgeaOiOadg+OAgeS4iuS8oOS/neWtmCAqL1xuICAgIGdldFd4VXNlckluZm8oIGNiICkge1xuICAgICAgICB3eC5nZXRVc2VySW5mbyh7XG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgIGh0dHAoe1xuICAgICAgICAgICAgICAgICAgICBkYXRhOiByZXMudXNlckluZm8sXG4gICAgICAgICAgICAgICAgICAgIHVybDogJ2NvbW1vbl91c2VyRWRpdCcsXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHJlczIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCByZXMyICYmIHJlczIuc3RhdHVzID09PSAyMDAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNVc2VyQXV0aDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlckluZm86IHJlcy51c2VySW5mb1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiICYmIGNiKCApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDojrflj5bnlKjmiLfmnYPpmZDkv6Hmga8gcm9sZS8gb3BlbmlkICovXG4gICAgZ2V0VXNlckluZm8oIGNiICkge1xuICAgICAgICB3eC5jbG91ZC5jYWxsRnVuY3Rpb24oe1xuICAgICAgICAgICAgbmFtZTogJ2xvZ2luJ1xuICAgICAgICB9KS50aGVuKCggcmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbTE9HSU5dJywgcmVzLnJlc3VsdCApO1xuICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKCByZXMucmVzdWx0ICk7XG4gICAgICAgICAgICAhIWNiICYmIGNiKCApO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOiuvue9ruWFqOWxgOaVsOaNriAqL1xuICAgIHNldEdsb2JhbERhdGEoIG9iaiApIHtcbiAgICAgICAgY29uc29sZS5sb2coICfjgJAtLS0tIEdsb2JhbCBTZXQgLS0tLeOAkScsIG9iaiApXG4gICAgICAgIE9iamVjdC5rZXlzKCBvYmogKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdsb2JhbERhdGFbIGtleSBdID0gb2JqWyBrZXkgXTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKiB3YXRjaOWHveaVsCAqL1xuICAgIHdhdGNoJCgga2V5LCBjYiApIHtcbiAgICAgICAgdGhpcy53YXRjaENhbGxCYWNrID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMud2F0Y2hDYWxsQmFjaywge1xuICAgICAgICAgICAgWyBrZXkgXTogdGhpcy53YXRjaENhbGxCYWNrWyBrZXkgXSB8fCBbIF1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2F0Y2hDYWxsQmFja1sga2V5IF0ucHVzaCggY2IgKTtcbiAgICAgICAgLy8g56uL6ams5omn6KGM5LiA5LiLY2JcbiAgICAgICAgc2V0VGltZW91dCgoICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICBjb25zdCBvbGQgPSB0aGlzLmdsb2JhbERhdGFbIGtleSBdO1xuICAgICAgICAgICAgY2IoIHZhbCwgb2xkICk7XG4gICAgICAgIH0sIDAgKTtcblxuICAgICAgICAvLyDmiafooYxzZXTnmoTml7blgJnvvIzlho3miafooYzkuIDkuItjYlxuICAgICAgICBpZiAoICF0aGlzLndhdGNoaW5nS2V5cy5maW5kKCB4ID0+IHggPT09IGtleSApKSB7XG4gICAgICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMud2F0Y2hpbmdLZXlzLnB1c2goIGtleSApO1xuICAgICAgICAgICAgLy8gT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLmdsb2JhbERhdGEsIGtleSwge1xuICAgICAgICAgICAgLy8gICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgLy8gICAgIHNldDogZnVuY3Rpb24oIHZhbCApIHtcbiAgICAgICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coYCR7a2V5feiiq3NldGAsIHZhbCApO1xuICAgICAgICAgICAgLy8gICAgICAgICBjb25zdCBvbGQgPSB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgIC8vICAgICAgICAgdGhhdC5nbG9iYWxEYXRhJFsga2V5IF0gPSB2YWw7XG4gICAgICAgICAgICAvLyAgICAgICAgIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0ubWFwKGZ1bmMgPT4gZnVuYyggdmFsLCBvbGQgKSk7XG4gICAgICAgICAgICAvLyAgICAgfSxcbiAgICAgICAgICAgIC8vICAgICBnZXQ6IGZ1bmN0aW9uKCApIHtcbiAgICAgICAgICAgIC8vICAgICAgICAgcmV0dXJuIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgLy8gICAgIH1cbiAgICAgICAgICAgIC8vIH0pO1xuICAgICAgICB9XG4gICAgfSxcbiAgXG4gICAgLyoqIOeUn+WRveWRqOacnyAqL1xuICAgIG9uTGF1bmNoOiBmdW5jdGlvbiggKSB7XG4gICAgICAgIHRoaXMuaW5pdCggKTtcbiAgICAgICAgdGhpcy5pbml0Q2xvdWQoIClcbiAgICAgICAgICAgIC50aGVuKCggKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5nZXRVc2VySW5mbyggKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldElzTmV3Q3VzdG9tKCApO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0QXBwQ29uZmlnKCApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCggZSA9PiB7XG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnLFxuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICfmlbDmja7lupPliJ3lp4vplJnor68nXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICBcbiAgICB9XG59KTtcblxuZXhwb3J0IGludGVyZmFjZSBNeUFwcCB7XG4gICAgZ2xvYmFsRGF0YTogZ2xvYmFsU3RhdGUsXG4gICAgZ2xvYmFsRGF0YSQ6IGdsb2JhbFN0YXRlLFxuICAgIHdhdGNoQ2FsbEJhY2s6IHtcbiAgICAgICAgWyBrZXk6IHN0cmluZyBdOiAoKCB2YWwxOiBhbnksIHZhbDI6IGFueSApID0+IHZvaWQpWyBdXG4gICAgfVxuICAgIHdhdGNoaW5nS2V5czogc3RyaW5nWyBdXG4gICAgaW5pdDogKCApID0+IHZvaWRcbiAgICBpbml0Q2xvdWQ6ICggKSA9PiBQcm9taXNlPGFueT5cbiAgICBnZXRBcHBDb25maWc6ICggKSA9PiB2b2lkXG4gICAgZ2V0VXNlckluZm86ICggY2I/OiAoKSA9PiB2b2lkICkgPT4gdm9pZCxcbiAgICBnZXRJc05ld0N1c3RvbTogICggKSA9PiB2b2lkLFxuICAgIGdldFd4VXNlckluZm86ICggY2I/OiAoICkgPT4gdm9pZCApID0+IHZvaWQsXG4gICAgc2V0R2xvYmFsRGF0YTogPEsgZXh0ZW5kcyBrZXlvZiBnbG9iYWxTdGF0ZT4oIGRhdGE6IGdsb2JhbFN0YXRlIHwgUGljazxnbG9iYWxTdGF0ZSwgSz4gKSA9PiB2b2lkLFxuICAgIHdhdGNoJDogKCBrZXk6IGtleW9mIGdsb2JhbFN0YXRlLCBhbnkgKSA9PiB2b2lkXG59XG5cbmVudW0gUm9sZSB7XG4gICAgbm9ybWFsLFxuICAgIGFkbWluXG59XG5cbnR5cGUgZ2xvYmFsU3RhdGUgPSB7XG4gICAgcm9sZTogUm9sZSxcbiAgICBvcGVuaWQ6IHN0cmluZyxcbiAgICBpc1VzZXJBdXRoOiBib29sZWFuLFxuICAgIHVzZXJJbmZvOiBhbnlcbiAgICBpc05ldzogYm9vbGVhblxuICAgIGFwcENvbmZpZzogYW55XG59Il19