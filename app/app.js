"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("./util/http");
var subscribe_1 = require("./util/subscribe");
var cloudEnv = 'prod-b87b76';
App({
    globalData$: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: {},
        isNew: true,
        editingGood: {},
        appConfig: {},
        showSubscribeTips: false,
        subscribeTpye: '',
        subscribeTemplates: [],
        pushIntegral: 0
    },
    globalData: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true,
        editingGood: null,
        appConfig: null,
        showSubscribeTips: false,
        subscribeTpye: '',
        subscribeTemplates: [],
        pushIntegral: 0
    },
    watchCallBack: {},
    watchingKeys: [],
    init: function () {
        var _this = this;
        var that = this;
        this.globalData$ = Object.assign({}, this.globalData);
        Object.keys(this.globalData).map(function (key) {
            Object.defineProperty(_this.globalData, key, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    var old = that.globalData$[key];
                    that.globalData$[key] = val;
                    if (Array.isArray(that.watchCallBack[key])) {
                        that.watchCallBack[key].map(function (func) { return func(val, old); });
                    }
                },
                get: function () {
                    return that.globalData$[key];
                }
            });
        });
        wx.getSetting({
            success: function (res) {
                var isUserAuth = res.authSetting['scope.userInfo'];
                _this.setGlobalData({
                    isUserAuth: isUserAuth === undefined ? false : isUserAuth
                });
            }
        });
    },
    initCloud: function () {
        return new Promise(function (resolve, reject) {
            wx.cloud.init({
                traceUser: true,
                env: cloudEnv
            });
            resolve();
        });
    },
    getIsNewCustom: function () {
        var _this = this;
        http_1.http({
            url: 'common_is-new-customer',
            success: function (res) {
                _this.setGlobalData({
                    isNew: res.data
                });
            }
        });
    },
    getPushIntegral: function () {
        var _this = this;
        http_1.http({
            data: {
                showMore: true,
            },
            loadingMsg: 'none',
            url: 'common_push-integral',
            success: function (res) {
                var status = res.status, data = res.data;
                if (status !== 200) {
                    return;
                }
                _this.setGlobalData({
                    pushIntegral: data.integral
                });
            }
        });
    },
    getSubscribeTemplated: function () {
        var _this = this;
        http_1.http({
            url: 'common_get-subscribe-templates',
            success: function (res) {
                _this.setGlobalData({
                    subscribeTemplates: res.data
                });
            }
        });
    },
    getAppConfig: function () {
        var _this = this;
        http_1.http({
            url: 'common_check-app-config',
            success: function (res) {
                if (res.status !== 200) {
                    return;
                }
                _this.setGlobalData({
                    appConfig: res.data
                });
            }
        });
    },
    getWxUserInfo: function (cb) {
        var _this = this;
        wx.getUserInfo({
            success: function (res) {
                http_1.http({
                    data: res.userInfo,
                    url: 'common_userEdit',
                    success: function (res2) {
                        if (res2 && res2.status === 200) {
                            _this.setGlobalData({
                                isUserAuth: true,
                                userInfo: res.userInfo
                            });
                            cb && cb();
                        }
                    }
                });
            }
        });
    },
    getUserInfo: function (cb) {
        var _this = this;
        wx.cloud.callFunction({
            name: 'login'
        }).then(function (res) {
            console.log('[LOGIN]', res.result);
            _this.setGlobalData(res.result);
            !!cb && cb();
        });
    },
    getSubscribe: function (types) {
        var hasShow = subscribe_1.checkSubscribeTips();
        if (!hasShow) {
            this.setGlobalData({
                subscribeTpye: types,
                showSubscribeTips: true
            });
        }
        else {
            subscribe_1.requestSubscribe(types, (this.globalData.subscribeTemplates || []));
        }
    },
    setGlobalData: function (obj) {
        var _this = this;
        console.log('【---- Global Set ----】', obj);
        Object.keys(obj).map(function (key) {
            _this.globalData[key] = obj[key];
        });
    },
    watch$: function (key, cb) {
        var _a;
        var _this = this;
        this.watchCallBack = Object.assign({}, this.watchCallBack, (_a = {},
            _a[key] = this.watchCallBack[key] || [],
            _a));
        this.watchCallBack[key].push(cb);
        setTimeout(function () {
            var val = _this.globalData$[key];
            var old = _this.globalData[key];
            cb(val, old);
        }, 0);
        if (!this.watchingKeys.find(function (x) { return x === key; })) {
            var that = this;
            this.watchingKeys.push(key);
        }
    },
    onLaunch: function () {
        var _this = this;
        this.init();
        this.initCloud()
            .then(function () {
            _this.getUserInfo();
            _this.getAppConfig();
            _this.getSubscribeTemplated();
            _this.getWxUserInfo();
        })
            .catch(function (e) {
            wx.showToast({
                icon: 'none',
                duration: 2000,
                title: '数据库初始错误'
            });
        });
    }
});
var Role;
(function (Role) {
    Role[Role["normal"] = 0] = "normal";
    Role[Role["admin"] = 1] = "admin";
})(Role || (Role = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW1DO0FBQ25DLDhDQUF3RTtBQUV4RSxJQUFNLFFBQVEsR0FBRyxhQUFhLENBQUM7QUFHL0IsR0FBRyxDQUFRO0lBR1AsV0FBVyxFQUFFO1FBRVQsSUFBSSxFQUFFLENBQUM7UUFFUCxNQUFNLEVBQUUsRUFBRTtRQUVWLFVBQVUsRUFBRSxLQUFLO1FBRWpCLFFBQVEsRUFBRSxFQUFHO1FBRWIsS0FBSyxFQUFFLElBQUk7UUFFWCxXQUFXLEVBQUUsRUFBRztRQUVoQixTQUFTLEVBQUUsRUFBRztRQUVkLGlCQUFpQixFQUFFLEtBQUs7UUFFeEIsYUFBYSxFQUFFLEVBQUU7UUFFakIsa0JBQWtCLEVBQUUsRUFBRztRQUV2QixZQUFZLEVBQUUsQ0FBQztLQUNsQjtJQUdELFVBQVUsRUFBRTtRQUNSLElBQUksRUFBRSxDQUFDO1FBQ1AsTUFBTSxFQUFFLEVBQUU7UUFDVixVQUFVLEVBQUUsS0FBSztRQUNqQixRQUFRLEVBQUUsSUFBSTtRQUNkLEtBQUssRUFBRSxJQUFJO1FBQ1gsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLElBQUk7UUFDZixpQkFBaUIsRUFBRSxLQUFLO1FBQ3hCLGFBQWEsRUFBRSxFQUFFO1FBQ2pCLGtCQUFrQixFQUFFLEVBQUc7UUFDdkIsWUFBWSxFQUFFLENBQUM7S0FDbEI7SUFHRCxhQUFhLEVBQUUsRUFBRztJQUdsQixZQUFZLEVBQUUsRUFBRztJQUdqQixJQUFJO1FBQUosaUJBb0NDO1FBbENHLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUdsQixJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQztRQUd4RCxNQUFNLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQyxHQUFHLENBQUUs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LEdBQUcsR0FBRyxLQUFJLENBQUMsVUFBVSxDQUFFLEdBQUcsQ0FBRSxDQUFDO1lBQ25DLEVBQUUsQ0FBRSxHQUFHLEVBQUUsR0FBRyxDQUFFLENBQUM7UUFDbkIsQ0FBQyxFQUFFLENBQUMsQ0FBRSxDQUFDO1FBR1AsSUFBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFFLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxLQUFLLEdBQUcsRUFBVCxDQUFTLENBQUUsRUFBRTtZQUM1QyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUM7WUFDbEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUUsR0FBRyxDQUFFLENBQUM7U0FjakM7SUFDTCxDQUFDO0lBR0QsUUFBUSxFQUFFO1FBQUEsaUJBbUJUO1FBbEJHLElBQUksQ0FBQyxJQUFJLEVBQUcsQ0FBQztRQUNiLElBQUksQ0FBQyxTQUFTLEVBQUc7YUFDWixJQUFJLENBQUM7WUFDRixLQUFJLENBQUMsV0FBVyxFQUFHLENBQUM7WUFDcEIsS0FBSSxDQUFDLFlBQVksRUFBRyxDQUFDO1lBR3JCLEtBQUksQ0FBQyxxQkFBcUIsRUFBRyxDQUFDO1lBQzlCLEtBQUksQ0FBQyxhQUFhLEVBQUcsQ0FBQztRQUMxQixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUUsVUFBQSxDQUFDO1lBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDVCxJQUFJLEVBQUUsTUFBTTtnQkFDWixRQUFRLEVBQUUsSUFBSTtnQkFDZCxLQUFLLEVBQUUsU0FBUzthQUNuQixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQTtJQUVWLENBQUM7Q0FDSixDQUFDLENBQUM7QUFzQkgsSUFBSyxJQUdKO0FBSEQsV0FBSyxJQUFJO0lBQ0wsbUNBQU0sQ0FBQTtJQUNOLGlDQUFLLENBQUE7QUFDVCxDQUFDLEVBSEksSUFBSSxLQUFKLElBQUksUUFHUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGh0dHAgfSBmcm9tICcuL3V0aWwvaHR0cCc7XG5pbXBvcnQgeyBjaGVja1N1YnNjcmliZVRpcHMsIHJlcXVlc3RTdWJzY3JpYmUgfSBmcm9tICcuL3V0aWwvc3Vic2NyaWJlJztcblxuY29uc3QgY2xvdWRFbnYgPSAncHJvZC1iODdiNzYnO1xuLy8gY29uc3QgY2xvdWRFbnYgPSB1bmRlZmluZWQ7XG5cbkFwcDxNeUFwcD4oe1xuXG4gICAgLyoqIGZhZGUgZ2xvYmFsRGF0YSAqL1xuICAgIGdsb2JhbERhdGEkOiB7XG4gICAgICAgIC8vIOeZu+W9leS6uuadg+mZkFxuICAgICAgICByb2xlOiAwLFxuICAgICAgICAvLyDnmbvlvZXkurppZFxuICAgICAgICBvcGVuaWQ6ICcnLFxuICAgICAgICAvLyDmmK/lkKblt7Lnu4/mjojmnYPnlKjmiLfkv6Hmga9cbiAgICAgICAgaXNVc2VyQXV0aDogZmFsc2UsXG4gICAgICAgIC8vIOeUqOaIt+S/oeaBr1xuICAgICAgICB1c2VySW5mbzogeyB9LFxuICAgICAgICAvKiog5piv5ZCm5piv5paw5a6i5oi3ICovXG4gICAgICAgIGlzTmV3OiB0cnVlLFxuICAgICAgICAvKiog57yW6L6R5Lit55qE5ZWG5ZOB5pWw5o2uICovXG4gICAgICAgIGVkaXRpbmdHb29kOiB7IH0sXG4gICAgICAgIC8qKiBhcHDphY3nva4gKi9cbiAgICAgICAgYXBwQ29uZmlnOiB7IH0sXG4gICAgICAgIC8qKiDlsZXnpLrlhajlsYDnmoTorqLpmIXmj5DnpLrkv6Hmga8gKi9cbiAgICAgICAgc2hvd1N1YnNjcmliZVRpcHM6IGZhbHNlLFxuICAgICAgICAvKiog6K6i6ZiF57G75Z6LICovXG4gICAgICAgIHN1YnNjcmliZVRweWU6ICcnLFxuICAgICAgICAvKiog6K6i6ZiF5qih5p2/ICovXG4gICAgICAgIHN1YnNjcmliZVRlbXBsYXRlczogWyBdLFxuICAgICAgICAvKiog5q2k6LSm5Y+35Y+v55So5oq1546w6YeRICovXG4gICAgICAgIHB1c2hJbnRlZ3JhbDogMFxuICAgIH0sXG5cbiAgICAvKiog5YWo5bGAc3RvcmUgKi9cbiAgICBnbG9iYWxEYXRhOiB7XG4gICAgICAgIHJvbGU6IDAsXG4gICAgICAgIG9wZW5pZDogJycsXG4gICAgICAgIGlzVXNlckF1dGg6IGZhbHNlLFxuICAgICAgICB1c2VySW5mbzogbnVsbCxcbiAgICAgICAgaXNOZXc6IHRydWUsXG4gICAgICAgIGVkaXRpbmdHb29kOiBudWxsLFxuICAgICAgICBhcHBDb25maWc6IG51bGwsXG4gICAgICAgIHNob3dTdWJzY3JpYmVUaXBzOiBmYWxzZSxcbiAgICAgICAgc3Vic2NyaWJlVHB5ZTogJycsXG4gICAgICAgIHN1YnNjcmliZVRlbXBsYXRlczogWyBdLFxuICAgICAgICBwdXNoSW50ZWdyYWw6IDBcbiAgICB9LFxuXG4gICAgLyoqIOebkeWQrOWHveaVsOeahOWvueixoeaVsOe7hCAqL1xuICAgIHdhdGNoQ2FsbEJhY2s6IHsgfSxcblxuICAgIC8qKiDnm5HlkKzliJfooaggKi9cbiAgICB3YXRjaGluZ0tleXM6IFsgXSxcblxuICAgIC8qKiDliJ3lp4vljJYgKi9cbiAgICBpbml0KCApIHtcblxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgIC8vIOWFqOWxgOaVsOaNrlxuICAgICAgICB0aGlzLmdsb2JhbERhdGEkID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMuZ2xvYmFsRGF0YSApO1xuXG4gICAgICAgIC8vIHdhdGNoXG4gICAgICAgIE9iamVjdC5rZXlzKCB0aGlzLmdsb2JhbERhdGEgKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMuZ2xvYmFsRGF0YSwga2V5LCB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiggdmFsICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGQgPSB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5nbG9iYWxEYXRhJFsga2V5IF0gPSB2YWw7XG4gICAgICAgICAgICAgICAgICAgIGlmICggQXJyYXkuaXNBcnJheSggdGhhdC53YXRjaENhbGxCYWNrWyBrZXkgXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0ubWFwKGZ1bmMgPT4gZnVuYyggdmFsLCBvbGQgKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIOeUqOaIt+S/oeaBr1xuICAgICAgICB3eC5nZXRTZXR0aW5nKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgLy8g5piv5ZCm5bey57uP5o6I5p2DXG4gICAgICAgICAgICAgICAgY29uc3QgaXNVc2VyQXV0aCA9IHJlcy5hdXRoU2V0dGluZ1snc2NvcGUudXNlckluZm8nXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc1VzZXJBdXRoOiBpc1VzZXJBdXRoID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IGlzVXNlckF1dGhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9LFxuXG4gICAgLyoqIOWIneWni+WMluS6keWHveaVsOaVsOaNruW6kyAqL1xuICAgIGluaXRDbG91ZCggKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoIHJlc29sdmUsIHJlamVjdCApID0+IHtcblxuICAgICAgICAgICAgLy8g5LqRXG4gICAgICAgICAgICB3eC5jbG91ZC5pbml0KHtcbiAgICAgICAgICAgICAgICB0cmFjZVVzZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgZW52OiBjbG91ZEVudlxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXNvbHZlKCApO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOaYr+WQpuS4uuaWsOWuoiAqL1xuICAgIGdldElzTmV3Q3VzdG9tKCApIHtcbiAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICB1cmw6ICdjb21tb25faXMtbmV3LWN1c3RvbWVyJyxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgaXNOZXc6IHJlcy5kYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDojrflj5blvZPliY3otKblj7fnmoTmirXnjrDph5HjgIHnrb7liLDnu4/pqowgKi9cbiAgICBnZXRQdXNoSW50ZWdyYWwoICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBzaG93TW9yZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBsb2FkaW5nTXNnOiAnbm9uZScsXG4gICAgICAgICAgICB1cmw6ICdjb21tb25fcHVzaC1pbnRlZ3JhbCcsXG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgc3RhdHVzLCBkYXRhIH0gPSByZXM7XG4gICAgICAgICAgICAgICAgaWYgKCBzdGF0dXMgIT09IDIwMCApIHsgcmV0dXJuOyB9XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgcHVzaEludGVncmFsOiBkYXRhLmludGVncmFsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDojrflj5borqLpmIXmqKHmnb8gKi9cbiAgICBnZXRTdWJzY3JpYmVUZW1wbGF0ZWQoICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIHVybDogJ2NvbW1vbl9nZXQtc3Vic2NyaWJlLXRlbXBsYXRlcycsXG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZVRlbXBsYXRlczogcmVzLmRhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqIOiOt+WPlmFwcOmFjee9riAqL1xuICAgIGdldEFwcENvbmZpZyggKSB7XG4gICAgICAgIGh0dHAoe1xuICAgICAgICAgICAgdXJsOiAnY29tbW9uX2NoZWNrLWFwcC1jb25maWcnLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIHJlcy5zdGF0dXMgIT09IDIwMCApIHsgcmV0dXJuOyB9XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgYXBwQ29uZmlnOiByZXMuZGF0YVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKiog5YWo5bGA5pa55rOV77yM6I635Y+W5b6u5L+h55So5oi355m75b2V5L+h5oGv44CB5o6I5p2D44CB5LiK5Lyg5L+d5a2YICovXG4gICAgZ2V0V3hVc2VySW5mbyggY2IgKSB7XG4gICAgICAgIHd4LmdldFVzZXJJbmZvKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlcy51c2VySW5mbyxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAnY29tbW9uX3VzZXJFZGl0JyxcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogcmVzMiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlczIgJiYgcmVzMi5zdGF0dXMgPT09IDIwMCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1VzZXJBdXRoOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VySW5mbzogcmVzLnVzZXJJbmZvXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IgJiYgY2IoICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqIOiOt+WPlueUqOaIt+adg+mZkOS/oeaBryByb2xlLyBvcGVuaWQgKi9cbiAgICBnZXRVc2VySW5mbyggY2IgKSB7XG4gICAgICAgIHd4LmNsb3VkLmNhbGxGdW5jdGlvbih7XG4gICAgICAgICAgICBuYW1lOiAnbG9naW4nXG4gICAgICAgIH0pLnRoZW4oKCByZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tMT0dJTl0nLCByZXMucmVzdWx0ICk7XG4gICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoIHJlcy5yZXN1bHQgKTtcbiAgICAgICAgICAgICEhY2IgJiYgY2IoICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog6I635Y+W6K6i6ZiF5o6I5p2DICovXG4gICAgZ2V0U3Vic2NyaWJlKCB0eXBlcyApIHtcbiAgICAgICAgY29uc3QgaGFzU2hvdyA9IGNoZWNrU3Vic2NyaWJlVGlwcyggKTtcbiAgICAgICAgaWYgKCAhaGFzU2hvdyApIHtcbiAgICAgICAgICAgIC8vIOW8ueahhlxuICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICBzdWJzY3JpYmVUcHllOiB0eXBlcyxcbiAgICAgICAgICAgICAgICBzaG93U3Vic2NyaWJlVGlwczogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7ICAgIFxuICAgICAgICAgICAgLy8g6K6i6ZiF6K+35rGCXG4gICAgICAgICAgICByZXF1ZXN0U3Vic2NyaWJlKCB0eXBlcywgKCB0aGlzLmdsb2JhbERhdGEuc3Vic2NyaWJlVGVtcGxhdGVzIHx8IFsgXSkpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKiDorr7nva7lhajlsYDmlbDmja4gKi9cbiAgICBzZXRHbG9iYWxEYXRhKCBvYmogKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCAn44CQLS0tLSBHbG9iYWwgU2V0IC0tLS3jgJEnLCBvYmogKVxuICAgICAgICBPYmplY3Qua2V5cyggb2JqICkubWFwKCBrZXkgPT4ge1xuICAgICAgICAgICAgdGhpcy5nbG9iYWxEYXRhWyBrZXkgXSA9IG9ialsga2V5IF07XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiogd2F0Y2jlh73mlbAgKi9cbiAgICB3YXRjaCQoIGtleSwgY2IgKSB7XG4gICAgICAgIHRoaXMud2F0Y2hDYWxsQmFjayA9IE9iamVjdC5hc3NpZ24oeyB9LCB0aGlzLndhdGNoQ2FsbEJhY2ssIHtcbiAgICAgICAgICAgIFsga2V5IF06IHRoaXMud2F0Y2hDYWxsQmFja1sga2V5IF0gfHwgWyBdXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLndhdGNoQ2FsbEJhY2tbIGtleSBdLnB1c2goIGNiICk7XG4gICAgICAgIC8vIOeri+mprOaJp+ihjOS4gOS4i2NiXG4gICAgICAgIHNldFRpbWVvdXQoKCApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgY29uc3Qgb2xkID0gdGhpcy5nbG9iYWxEYXRhWyBrZXkgXTtcbiAgICAgICAgICAgIGNiKCB2YWwsIG9sZCApO1xuICAgICAgICB9LCAwICk7XG5cbiAgICAgICAgLy8g5omn6KGMc2V055qE5pe25YCZ77yM5YaN5omn6KGM5LiA5LiLY2JcbiAgICAgICAgaWYgKCAhdGhpcy53YXRjaGluZ0tleXMuZmluZCggeCA9PiB4ID09PSBrZXkgKSkge1xuICAgICAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICB0aGlzLndhdGNoaW5nS2V5cy5wdXNoKCBrZXkgKTtcbiAgICAgICAgICAgIC8vIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcy5nbG9iYWxEYXRhLCBrZXksIHtcbiAgICAgICAgICAgIC8vICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAvLyAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICBzZXQ6IGZ1bmN0aW9uKCB2YWwgKSB7XG4gICAgICAgICAgICAvLyAgICAgICAgIGNvbnNvbGUubG9nKGAke2tleX3ooqtzZXRgLCB2YWwgKTtcbiAgICAgICAgICAgIC8vICAgICAgICAgY29uc3Qgb2xkID0gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAvLyAgICAgICAgIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdID0gdmFsO1xuICAgICAgICAgICAgLy8gICAgICAgICB0aGF0LndhdGNoQ2FsbEJhY2tbIGtleSBdLm1hcChmdW5jID0+IGZ1bmMoIHZhbCwgb2xkICkpO1xuICAgICAgICAgICAgLy8gICAgIH0sXG4gICAgICAgICAgICAvLyAgICAgZ2V0OiBmdW5jdGlvbiggKSB7XG4gICAgICAgICAgICAvLyAgICAgICAgIHJldHVybiB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgIC8vICAgICB9XG4gICAgICAgICAgICAvLyB9KTtcbiAgICAgICAgfVxuICAgIH0sXG4gIFxuICAgIC8qKiDnlJ/lkb3lkajmnJ8gKi9cbiAgICBvbkxhdW5jaDogZnVuY3Rpb24oICkge1xuICAgICAgICB0aGlzLmluaXQoICk7XG4gICAgICAgIHRoaXMuaW5pdENsb3VkKCApXG4gICAgICAgICAgICAudGhlbigoICkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0VXNlckluZm8oICk7XG4gICAgICAgICAgICAgICAgdGhpcy5nZXRBcHBDb25maWcoICk7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy5nZXRQdXNoSW50ZWdyYWwoICk7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy5nZXRJc05ld0N1c3RvbSggKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFN1YnNjcmliZVRlbXBsYXRlZCggKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFd4VXNlckluZm8oICk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKCBlID0+IHtcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgICBpY29uOiAnbm9uZScsXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ+aVsOaNruW6k+WIneWni+mUmeivrydcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIFxuICAgIH1cbn0pO1xuXG5leHBvcnQgaW50ZXJmYWNlIE15QXBwIHtcbiAgICBnbG9iYWxEYXRhOiBnbG9iYWxTdGF0ZSxcbiAgICBnbG9iYWxEYXRhJDogZ2xvYmFsU3RhdGUsXG4gICAgd2F0Y2hDYWxsQmFjazoge1xuICAgICAgICBbIGtleTogc3RyaW5nIF06ICgoIHZhbDE6IGFueSwgdmFsMjogYW55ICkgPT4gdm9pZClbIF1cbiAgICB9XG4gICAgd2F0Y2hpbmdLZXlzOiBzdHJpbmdbIF1cbiAgICBpbml0OiAoICkgPT4gdm9pZFxuICAgIGluaXRDbG91ZDogKCApID0+IFByb21pc2U8YW55PlxuICAgIGdldEFwcENvbmZpZzogKCApID0+IHZvaWRcbiAgICBnZXRVc2VySW5mbzogKCBjYj86ICgpID0+IHZvaWQgKSA9PiB2b2lkLFxuICAgIGdldElzTmV3Q3VzdG9tOiAgKCApID0+IHZvaWQsXG4gICAgZ2V0UHVzaEludGVncmFsOiAoICkgPT4gdm9pZCxcbiAgICBnZXRTdWJzY3JpYmVUZW1wbGF0ZWQ6ICggKSA9PiB2b2lkLFxuICAgIGdldFd4VXNlckluZm86ICggY2I/OiAoICkgPT4gdm9pZCApID0+IHZvaWQsXG4gICAgZ2V0U3Vic2NyaWJlOiAoIHR5cGU/OiBhbnkgKSA9PiB2b2lkLFxuICAgIHNldEdsb2JhbERhdGE6IDxLIGV4dGVuZHMga2V5b2YgZ2xvYmFsU3RhdGU+KCBkYXRhOiBnbG9iYWxTdGF0ZSB8IFBpY2s8Z2xvYmFsU3RhdGUsIEs+ICkgPT4gdm9pZCxcbiAgICB3YXRjaCQ6ICgga2V5OiBrZXlvZiBnbG9iYWxTdGF0ZSwgYW55ICkgPT4gdm9pZFxufVxuXG5lbnVtIFJvbGUge1xuICAgIG5vcm1hbCxcbiAgICBhZG1pblxufVxuXG50eXBlIGdsb2JhbFN0YXRlID0ge1xuICAgIHJvbGU6IFJvbGUsXG4gICAgb3BlbmlkOiBzdHJpbmcsXG4gICAgZWRpdGluZ0dvb2Q6IGFueSxcbiAgICBpc1VzZXJBdXRoOiBib29sZWFuLFxuICAgIHVzZXJJbmZvOiBhbnlcbiAgICBpc05ldzogYm9vbGVhblxuICAgIGFwcENvbmZpZzogYW55LFxuICAgIHNob3dTdWJzY3JpYmVUaXBzOiBib29sZWFuXG4gICAgc3Vic2NyaWJlVHB5ZTogYW55LFxuICAgIHN1YnNjcmliZVRlbXBsYXRlczogYW55W11cbiAgICBwdXNoSW50ZWdyYWw6IG51bWJlclxufSJdfQ==