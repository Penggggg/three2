"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("./util/http");
var subscribe_1 = require("./util/subscribe");
var cloudEnv = 'prod-b87b76';
App({
    globalData$: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: {},
        isNew: true,
        editingGood: {},
        appConfig: {},
        showSubscribeTips: false,
        subscribeTpye: '',
        subscribeTemplates: []
    },
    globalData: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true,
        editingGood: null,
        appConfig: null,
        showSubscribeTips: false,
        subscribeTpye: '',
        subscribeTemplates: []
    },
    watchCallBack: {},
    watchingKeys: [],
    init: function () {
        var _this = this;
        var that = this;
        this.globalData$ = Object.assign({}, this.globalData);
        Object.keys(this.globalData).map(function (key) {
            Object.defineProperty(_this.globalData, key, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    var old = that.globalData$[key];
                    that.globalData$[key] = val;
                    if (Array.isArray(that.watchCallBack[key])) {
                        that.watchCallBack[key].map(function (func) { return func(val, old); });
                    }
                },
                get: function () {
                    return that.globalData$[key];
                }
            });
        });
        wx.getSetting({
            success: function (res) {
                var isUserAuth = res.authSetting['scope.userInfo'];
                _this.setGlobalData({
                    isUserAuth: isUserAuth === undefined ? false : isUserAuth
                });
            }
        });
    },
    initCloud: function () {
        return new Promise(function (resolve, reject) {
            wx.cloud.init({
                traceUser: true,
                env: cloudEnv
            });
            resolve();
        });
    },
    getIsNewCustom: function () {
        var _this = this;
        http_1.http({
            url: 'common_is-new-customer',
            success: function (res) {
                _this.setGlobalData({
                    isNew: res.data
                });
            }
        });
    },
    getSubscribeTemplated: function () {
        var _this = this;
        http_1.http({
            url: 'common_get-subscribe-templates',
            success: function (res) {
                _this.setGlobalData({
                    subscribeTemplates: res.data
                });
            }
        });
    },
    getAppConfig: function () {
        var _this = this;
        http_1.http({
            url: 'common_check-app-config',
            success: function (res) {
                if (res.status !== 200) {
                    return;
                }
                _this.setGlobalData({
                    appConfig: res.data
                });
            }
        });
    },
    getWxUserInfo: function (cb) {
        var _this = this;
        wx.getUserInfo({
            success: function (res) {
                http_1.http({
                    data: res.userInfo,
                    url: 'common_userEdit',
                    success: function (res2) {
                        if (res2 && res2.status === 200) {
                            _this.setGlobalData({
                                isUserAuth: true,
                                userInfo: res.userInfo
                            });
                            cb && cb();
                        }
                    }
                });
            }
        });
    },
    getUserInfo: function (cb) {
        var _this = this;
        wx.cloud.callFunction({
            name: 'login'
        }).then(function (res) {
            console.log('[LOGIN]', res.result);
            _this.setGlobalData(res.result);
            !!cb && cb();
        });
    },
    getSubscribe: function (types) {
        var hasShow = subscribe_1.checkSubscribeTips();
        if (!hasShow) {
            this.setGlobalData({
                subscribeTpye: types,
                showSubscribeTips: true
            });
        }
        else {
            subscribe_1.requestSubscribe(types, (this.globalData.subscribeTemplates || []));
        }
    },
    setGlobalData: function (obj) {
        var _this = this;
        console.log('【---- Global Set ----】', obj);
        Object.keys(obj).map(function (key) {
            _this.globalData[key] = obj[key];
        });
    },
    watch$: function (key, cb) {
        var _this = this;
        var _a;
        this.watchCallBack = Object.assign({}, this.watchCallBack, (_a = {},
            _a[key] = this.watchCallBack[key] || [],
            _a));
        this.watchCallBack[key].push(cb);
        setTimeout(function () {
            var val = _this.globalData$[key];
            var old = _this.globalData[key];
            cb(val, old);
        }, 0);
        if (!this.watchingKeys.find(function (x) { return x === key; })) {
            var that = this;
            this.watchingKeys.push(key);
        }
    },
    onLaunch: function () {
        var _this = this;
        this.init();
        this.initCloud()
            .then(function () {
            _this.getUserInfo();
            _this.getAppConfig();
            _this.getIsNewCustom();
            _this.getSubscribeTemplated();
        })
            .catch(function (e) {
            wx.showToast({
                icon: 'none',
                duration: 2000,
                title: '数据库初始错误'
            });
        });
    }
});
var Role;
(function (Role) {
    Role[Role["normal"] = 0] = "normal";
    Role[Role["admin"] = 1] = "admin";
})(Role || (Role = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW1DO0FBQ25DLDhDQUF3RTtBQUV4RSxJQUFNLFFBQVEsR0FBRyxhQUFhLENBQUM7QUFHL0IsR0FBRyxDQUFRO0lBR1AsV0FBVyxFQUFFO1FBRVQsSUFBSSxFQUFFLENBQUM7UUFFUCxNQUFNLEVBQUUsRUFBRTtRQUVWLFVBQVUsRUFBRSxLQUFLO1FBRWpCLFFBQVEsRUFBRSxFQUFHO1FBRWIsS0FBSyxFQUFFLElBQUk7UUFFWCxXQUFXLEVBQUUsRUFBRztRQUVoQixTQUFTLEVBQUUsRUFBRztRQUVkLGlCQUFpQixFQUFFLEtBQUs7UUFFeEIsYUFBYSxFQUFFLEVBQUU7UUFFakIsa0JBQWtCLEVBQUUsRUFBRztLQUMxQjtJQUdELFVBQVUsRUFBRTtRQUNSLElBQUksRUFBRSxDQUFDO1FBQ1AsTUFBTSxFQUFFLEVBQUU7UUFDVixVQUFVLEVBQUUsS0FBSztRQUNqQixRQUFRLEVBQUUsSUFBSTtRQUNkLEtBQUssRUFBRSxJQUFJO1FBQ1gsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLElBQUk7UUFDZixpQkFBaUIsRUFBRSxLQUFLO1FBQ3hCLGFBQWEsRUFBRSxFQUFFO1FBQ2pCLGtCQUFrQixFQUFFLEVBQUc7S0FDMUI7SUFHRCxhQUFhLEVBQUUsRUFBRztJQUdsQixZQUFZLEVBQUUsRUFBRztJQUdqQixJQUFJO1FBQUosaUJBb0NDO1FBbENHLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUdsQixJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQztRQUd4RCxNQUFNLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQyxHQUFHLENBQUUsVUFBQSxHQUFHO1lBQ25DLE1BQU0sQ0FBQyxjQUFjLENBQUUsS0FBSSxD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QUFDLFNBQVMsRUFBRzthQUNaLElBQUksQ0FBQztZQUNGLEtBQUksQ0FBQyxXQUFXLEVBQUcsQ0FBQztZQUNwQixLQUFJLENBQUMsWUFBWSxFQUFHLENBQUM7WUFDckIsS0FBSSxDQUFDLGNBQWMsRUFBRyxDQUFDO1lBQ3ZCLEtBQUksQ0FBQyxxQkFBcUIsRUFBRyxDQUFDO1FBQ2xDLENBQUMsQ0FBQzthQUNELEtBQUssQ0FBRSxVQUFBLENBQUM7WUFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNULElBQUksRUFBRSxNQUFNO2dCQUNaLFFBQVEsRUFBRSxJQUFJO2dCQUNkLEtBQUssRUFBRSxTQUFTO2FBQ25CLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFBO0lBRVYsQ0FBQztDQUNKLENBQUMsQ0FBQztBQXFCSCxJQUFLLElBR0o7QUFIRCxXQUFLLElBQUk7SUFDTCxtQ0FBTSxDQUFBO0lBQ04saUNBQUssQ0FBQTtBQUNULENBQUMsRUFISSxJQUFJLEtBQUosSUFBSSxRQUdSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaHR0cCB9IGZyb20gJy4vdXRpbC9odHRwJztcbmltcG9ydCB7IGNoZWNrU3Vic2NyaWJlVGlwcywgcmVxdWVzdFN1YnNjcmliZSB9IGZyb20gJy4vdXRpbC9zdWJzY3JpYmUnO1xuXG5jb25zdCBjbG91ZEVudiA9ICdwcm9kLWI4N2I3Nic7XG4vLyBjb25zdCBjbG91ZEVudiA9IHVuZGVmaW5lZDtcblxuQXBwPE15QXBwPih7XG5cbiAgICAvKiogZmFkZSBnbG9iYWxEYXRhICovXG4gICAgZ2xvYmFsRGF0YSQ6IHtcbiAgICAgICAgLy8g55m75b2V5Lq65p2D6ZmQXG4gICAgICAgIHJvbGU6IDAsXG4gICAgICAgIC8vIOeZu+W9leS6umlkXG4gICAgICAgIG9wZW5pZDogJycsXG4gICAgICAgIC8vIOaYr+WQpuW3sue7j+aOiOadg+eUqOaIt+S/oeaBr1xuICAgICAgICBpc1VzZXJBdXRoOiBmYWxzZSxcbiAgICAgICAgLy8g55So5oi35L+h5oGvXG4gICAgICAgIHVzZXJJbmZvOiB7IH0sXG4gICAgICAgIC8qKiDmmK/lkKbmmK/mlrDlrqLmiLcgKi9cbiAgICAgICAgaXNOZXc6IHRydWUsXG4gICAgICAgIC8qKiDnvJbovpHkuK3nmoTllYblk4HmlbDmja4gKi9cbiAgICAgICAgZWRpdGluZ0dvb2Q6IHsgfSxcbiAgICAgICAgLyoqIGFwcOmFjee9riAqL1xuICAgICAgICBhcHBDb25maWc6IHsgfSxcbiAgICAgICAgLyoqIOWxleekuuWFqOWxgOeahOiuoumYheaPkOekuuS/oeaBryAqL1xuICAgICAgICBzaG93U3Vic2NyaWJlVGlwczogZmFsc2UsXG4gICAgICAgIC8qKiDorqLpmIXnsbvlnosgKi9cbiAgICAgICAgc3Vic2NyaWJlVHB5ZTogJycsXG4gICAgICAgIC8qKiDorqLpmIXmqKHmnb8gKi9cbiAgICAgICAgc3Vic2NyaWJlVGVtcGxhdGVzOiBbIF1cbiAgICB9LFxuXG4gICAgLyoqIOWFqOWxgHN0b3JlICovXG4gICAgZ2xvYmFsRGF0YToge1xuICAgICAgICByb2xlOiAwLFxuICAgICAgICBvcGVuaWQ6ICcnLFxuICAgICAgICBpc1VzZXJBdXRoOiBmYWxzZSxcbiAgICAgICAgdXNlckluZm86IG51bGwsXG4gICAgICAgIGlzTmV3OiB0cnVlLFxuICAgICAgICBlZGl0aW5nR29vZDogbnVsbCxcbiAgICAgICAgYXBwQ29uZmlnOiBudWxsLFxuICAgICAgICBzaG93U3Vic2NyaWJlVGlwczogZmFsc2UsXG4gICAgICAgIHN1YnNjcmliZVRweWU6ICcnLFxuICAgICAgICBzdWJzY3JpYmVUZW1wbGF0ZXM6IFsgXVxuICAgIH0sXG5cbiAgICAvKiog55uR5ZCs5Ye95pWw55qE5a+56LGh5pWw57uEICovXG4gICAgd2F0Y2hDYWxsQmFjazogeyB9LFxuXG4gICAgLyoqIOebkeWQrOWIl+ihqCAqL1xuICAgIHdhdGNoaW5nS2V5czogWyBdLFxuXG4gICAgLyoqIOWIneWni+WMliAqL1xuICAgIGluaXQoICkge1xuXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgLy8g5YWo5bGA5pWw5o2uXG4gICAgICAgIHRoaXMuZ2xvYmFsRGF0YSQgPSBPYmplY3QuYXNzaWduKHsgfSwgdGhpcy5nbG9iYWxEYXRhICk7XG5cbiAgICAgICAgLy8gd2F0Y2hcbiAgICAgICAgT2JqZWN0LmtleXMoIHRoaXMuZ2xvYmFsRGF0YSApLm1hcCgga2V5ID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcy5nbG9iYWxEYXRhLCBrZXksIHtcbiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCB2YWwgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZCA9IHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgICAgICAgICB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXSA9IHZhbDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBBcnJheS5pc0FycmF5KCB0aGF0LndhdGNoQ2FsbEJhY2tbIGtleSBdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC53YXRjaENhbGxCYWNrWyBrZXkgXS5tYXAoZnVuYyA9PiBmdW5jKCB2YWwsIG9sZCApKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiggKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8g55So5oi35L+h5oGvXG4gICAgICAgIHd4LmdldFNldHRpbmcoe1xuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICAvLyDmmK/lkKblt7Lnu4/mjojmnYNcbiAgICAgICAgICAgICAgICBjb25zdCBpc1VzZXJBdXRoID0gcmVzLmF1dGhTZXR0aW5nWydzY29wZS51c2VySW5mbyddO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIGlzVXNlckF1dGg6IGlzVXNlckF1dGggPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogaXNVc2VyQXV0aFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgIH0sXG5cbiAgICAvKiog5Yid5aeL5YyW5LqR5Ye95pWw5pWw5o2u5bqTICovXG4gICAgaW5pdENsb3VkKCApIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCggcmVzb2x2ZSwgcmVqZWN0ICkgPT4ge1xuXG4gICAgICAgICAgICAvLyDkupFcbiAgICAgICAgICAgIHd4LmNsb3VkLmluaXQoe1xuICAgICAgICAgICAgICAgIHRyYWNlVXNlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBlbnY6IGNsb3VkRW52XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc29sdmUoICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog5piv5ZCm5Li65paw5a6iICovXG4gICAgZ2V0SXNOZXdDdXN0b20oICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIHVybDogJ2NvbW1vbl9pcy1uZXctY3VzdG9tZXInLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc05ldzogcmVzLmRhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqIOiOt+WPluiuoumYheaooeadvyAqL1xuICAgIGdldFN1YnNjcmliZVRlbXBsYXRlZCggKSB7XG4gICAgICAgIGh0dHAoe1xuICAgICAgICAgICAgdXJsOiAnY29tbW9uX2dldC1zdWJzY3JpYmUtdGVtcGxhdGVzJyxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJlVGVtcGxhdGVzOiByZXMuZGF0YVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKiog6I635Y+WYXBw6YWN572uICovXG4gICAgZ2V0QXBwQ29uZmlnKCApIHtcbiAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICB1cmw6ICdjb21tb25fY2hlY2stYXBwLWNvbmZpZycsXG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgIGlmICggcmVzLnN0YXR1cyAhPT0gMjAwICkgeyByZXR1cm47IH1cbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBhcHBDb25maWc6IHJlcy5kYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDlhajlsYDmlrnms5XvvIzojrflj5blvq7kv6HnlKjmiLfnmbvlvZXkv6Hmga/jgIHmjojmnYPjgIHkuIrkvKDkv53lrZggKi9cbiAgICBnZXRXeFVzZXJJbmZvKCBjYiApIHtcbiAgICAgICAgd3guZ2V0VXNlckluZm8oe1xuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICBodHRwKHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzLnVzZXJJbmZvLFxuICAgICAgICAgICAgICAgICAgICB1cmw6ICdjb21tb25fdXNlckVkaXQnLFxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiByZXMyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggcmVzMiAmJiByZXMyLnN0YXR1cyA9PT0gMjAwICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVXNlckF1dGg6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJJbmZvOiByZXMudXNlckluZm9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYiAmJiBjYiggKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKiog6I635Y+W55So5oi35p2D6ZmQ5L+h5oGvIHJvbGUvIG9wZW5pZCAqL1xuICAgIGdldFVzZXJJbmZvKCBjYiApIHtcbiAgICAgICAgd3guY2xvdWQuY2FsbEZ1bmN0aW9uKHtcbiAgICAgICAgICAgIG5hbWU6ICdsb2dpbidcbiAgICAgICAgfSkudGhlbigoIHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW0xPR0lOXScsIHJlcy5yZXN1bHQgKTtcbiAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSggcmVzLnJlc3VsdCApO1xuICAgICAgICAgICAgISFjYiAmJiBjYiggKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKiDojrflj5borqLpmIXmjojmnYMgKi9cbiAgICBnZXRTdWJzY3JpYmUoIHR5cGVzICkge1xuICAgICAgICBjb25zdCBoYXNTaG93ID0gY2hlY2tTdWJzY3JpYmVUaXBzKCApO1xuICAgICAgICBpZiAoICFoYXNTaG93ICkge1xuICAgICAgICAgICAgLy8g5by55qGGXG4gICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgIHN1YnNjcmliZVRweWU6IHR5cGVzLFxuICAgICAgICAgICAgICAgIHNob3dTdWJzY3JpYmVUaXBzOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHsgICAgXG4gICAgICAgICAgICAvLyDorqLpmIXor7fmsYJcbiAgICAgICAgICAgIHJlcXVlc3RTdWJzY3JpYmUoIHR5cGVzLCAoIHRoaXMuZ2xvYmFsRGF0YS5zdWJzY3JpYmVUZW1wbGF0ZXMgfHwgWyBdKSk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqIOiuvue9ruWFqOWxgOaVsOaNriAqL1xuICAgIHNldEdsb2JhbERhdGEoIG9iaiApIHtcbiAgICAgICAgY29uc29sZS5sb2coICfjgJAtLS0tIEdsb2JhbCBTZXQgLS0tLeOAkScsIG9iaiApXG4gICAgICAgIE9iamVjdC5rZXlzKCBvYmogKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdsb2JhbERhdGFbIGtleSBdID0gb2JqWyBrZXkgXTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKiB3YXRjaOWHveaVsCAqL1xuICAgIHdhdGNoJCgga2V5LCBjYiApIHtcbiAgICAgICAgdGhpcy53YXRjaENhbGxCYWNrID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMud2F0Y2hDYWxsQmFjaywge1xuICAgICAgICAgICAgWyBrZXkgXTogdGhpcy53YXRjaENhbGxCYWNrWyBrZXkgXSB8fCBbIF1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2F0Y2hDYWxsQmFja1sga2V5IF0ucHVzaCggY2IgKTtcbiAgICAgICAgLy8g56uL6ams5omn6KGM5LiA5LiLY2JcbiAgICAgICAgc2V0VGltZW91dCgoICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICBjb25zdCBvbGQgPSB0aGlzLmdsb2JhbERhdGFbIGtleSBdO1xuICAgICAgICAgICAgY2IoIHZhbCwgb2xkICk7XG4gICAgICAgIH0sIDAgKTtcblxuICAgICAgICAvLyDmiafooYxzZXTnmoTml7blgJnvvIzlho3miafooYzkuIDkuItjYlxuICAgICAgICBpZiAoICF0aGlzLndhdGNoaW5nS2V5cy5maW5kKCB4ID0+IHggPT09IGtleSApKSB7XG4gICAgICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMud2F0Y2hpbmdLZXlzLnB1c2goIGtleSApO1xuICAgICAgICAgICAgLy8gT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLmdsb2JhbERhdGEsIGtleSwge1xuICAgICAgICAgICAgLy8gICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgLy8gICAgIHNldDogZnVuY3Rpb24oIHZhbCApIHtcbiAgICAgICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coYCR7a2V5feiiq3NldGAsIHZhbCApO1xuICAgICAgICAgICAgLy8gICAgICAgICBjb25zdCBvbGQgPSB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgIC8vICAgICAgICAgdGhhdC5nbG9iYWxEYXRhJFsga2V5IF0gPSB2YWw7XG4gICAgICAgICAgICAvLyAgICAgICAgIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0ubWFwKGZ1bmMgPT4gZnVuYyggdmFsLCBvbGQgKSk7XG4gICAgICAgICAgICAvLyAgICAgfSxcbiAgICAgICAgICAgIC8vICAgICBnZXQ6IGZ1bmN0aW9uKCApIHtcbiAgICAgICAgICAgIC8vICAgICAgICAgcmV0dXJuIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgLy8gICAgIH1cbiAgICAgICAgICAgIC8vIH0pO1xuICAgICAgICB9XG4gICAgfSxcbiAgXG4gICAgLyoqIOeUn+WRveWRqOacnyAqL1xuICAgIG9uTGF1bmNoOiBmdW5jdGlvbiggKSB7XG4gICAgICAgIHRoaXMuaW5pdCggKTtcbiAgICAgICAgdGhpcy5pbml0Q2xvdWQoIClcbiAgICAgICAgICAgIC50aGVuKCggKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5nZXRVc2VySW5mbyggKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldEFwcENvbmZpZyggKTtcbiAgICAgICAgICAgICAgICB0aGlzLmdldElzTmV3Q3VzdG9tKCApO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3Vic2NyaWJlVGVtcGxhdGVkKCApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCggZSA9PiB7XG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnLFxuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICfmlbDmja7lupPliJ3lp4vplJnor68nXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICBcbiAgICB9XG59KTtcblxuZXhwb3J0IGludGVyZmFjZSBNeUFwcCB7XG4gICAgZ2xvYmFsRGF0YTogZ2xvYmFsU3RhdGUsXG4gICAgZ2xvYmFsRGF0YSQ6IGdsb2JhbFN0YXRlLFxuICAgIHdhdGNoQ2FsbEJhY2s6IHtcbiAgICAgICAgWyBrZXk6IHN0cmluZyBdOiAoKCB2YWwxOiBhbnksIHZhbDI6IGFueSApID0+IHZvaWQpWyBdXG4gICAgfVxuICAgIHdhdGNoaW5nS2V5czogc3RyaW5nWyBdXG4gICAgaW5pdDogKCApID0+IHZvaWRcbiAgICBpbml0Q2xvdWQ6ICggKSA9PiBQcm9taXNlPGFueT5cbiAgICBnZXRBcHBDb25maWc6ICggKSA9PiB2b2lkXG4gICAgZ2V0VXNlckluZm86ICggY2I/OiAoKSA9PiB2b2lkICkgPT4gdm9pZCxcbiAgICBnZXRJc05ld0N1c3RvbTogICggKSA9PiB2b2lkLFxuICAgIGdldFN1YnNjcmliZVRlbXBsYXRlZDogKCApID0+IHZvaWQsXG4gICAgZ2V0V3hVc2VySW5mbzogKCBjYj86ICggKSA9PiB2b2lkICkgPT4gdm9pZCxcbiAgICBnZXRTdWJzY3JpYmU6ICggdHlwZT86IGFueSApID0+IHZvaWQsXG4gICAgc2V0R2xvYmFsRGF0YTogPEsgZXh0ZW5kcyBrZXlvZiBnbG9iYWxTdGF0ZT4oIGRhdGE6IGdsb2JhbFN0YXRlIHwgUGljazxnbG9iYWxTdGF0ZSwgSz4gKSA9PiB2b2lkLFxuICAgIHdhdGNoJDogKCBrZXk6IGtleW9mIGdsb2JhbFN0YXRlLCBhbnkgKSA9PiB2b2lkXG59XG5cbmVudW0gUm9sZSB7XG4gICAgbm9ybWFsLFxuICAgIGFkbWluXG59XG5cbnR5cGUgZ2xvYmFsU3RhdGUgPSB7XG4gICAgcm9sZTogUm9sZSxcbiAgICBvcGVuaWQ6IHN0cmluZyxcbiAgICBpc1VzZXJBdXRoOiBib29sZWFuLFxuICAgIHVzZXJJbmZvOiBhbnlcbiAgICBpc05ldzogYm9vbGVhblxuICAgIGFwcENvbmZpZzogYW55LFxuICAgIHNob3dTdWJzY3JpYmVUaXBzOiBib29sZWFuXG4gICAgc3Vic2NyaWJlVHB5ZTogYW55LFxuICAgIHN1YnNjcmliZVRlbXBsYXRlczogYW55W11cbn0iXX0=