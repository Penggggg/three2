"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("./util/http");
App({
    globalData$: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true
    },
    globalData: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true
    },
    watchCallBack: {},
    watchingKeys: [],
    init: function () {
        var _this = this;
        var that = this;
        this.globalData$ = Object.assign({}, this.globalData);
        Object.keys(this.globalData).map(function (key) {
            Object.defineProperty(_this.globalData, key, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    var old = that.globalData$[key];
                    that.globalData$[key] = val;
                    if (Array.isArray(that.watchCallBack[key])) {
                        that.watchCallBack[key].map(function (func) { return func(val, old); });
                    }
                },
                get: function () {
                    return that.globalData$[key];
                }
            });
        });
        wx.getSetting({
            success: function (res) {
                var isUserAuth = res.authSetting['scope.userInfo'];
                _this.setGlobalData({
                    isUserAuth: isUserAuth === undefined ? false : isUserAuth
                });
            }
        });
    },
    initCloud: function () {
        return new Promise(function (resolve, reject) {
            wx.cloud.init({
                traceUser: true
            });
            resolve();
        });
    },
    getIsNewCustom: function () {
        var _this = this;
        http_1.http({
            url: 'common_is-new-customer',
            success: function (res) {
                _this.setGlobalData({
                    isNew: res.data
                });
            }
        });
    },
    getWxUserInfo: function (cb) {
        var _this = this;
        wx.getUserInfo({
            success: function (res) {
                console.log('333');
                http_1.http({
                    data: res.userInfo,
                    url: 'common_userEdit',
                    success: function (res2) {
                        if (res2 && res2.status === 200) {
                            _this.setGlobalData({
                                isUserAuth: true,
                                userInfo: res.userInfo
                            });
                            cb && cb();
                        }
                    }
                });
            }
        });
    },
    getUserInfo: function () {
        var _this = this;
        wx.cloud.callFunction({
            name: 'login'
        }).then(function (res) {
            _this.setGlobalData(res.result);
        });
    },
    setGlobalData: function (obj) {
        var _this = this;
        console.log('【---- Global Set ----】', obj);
        Object.keys(obj).map(function (key) {
            _this.globalData[key] = obj[key];
        });
    },
    watch$: function (key, cb) {
        var _this = this;
        var _a;
        this.watchCallBack = Object.assign({}, this.watchCallBack, (_a = {},
            _a[key] = this.watchCallBack[key] || [],
            _a));
        this.watchCallBack[key].push(cb);
        console.log('watch$....', key);
        setTimeout(function () {
            var val = _this.globalData$[key];
            var old = _this.globalData[key];
            cb(val, old);
        }, 0);
        if (!this.watchingKeys.find(function (x) { return x === key; })) {
            var that = this;
            this.watchingKeys.push(key);
        }
    },
    onLaunch: function () {
        var _this = this;
        this.init();
        this.initCloud()
            .then(function () {
            _this.getUserInfo();
            _this.getIsNewCustom();
        })
            .catch(function (e) {
            wx.showToast({
                icon: 'none',
                duration: 2000,
                title: '数据库初始错误'
            });
        });
    }
});
var Role;
(function (Role) {
    Role[Role["normal"] = 0] = "normal";
    Role[Role["admin"] = 1] = "admin";
})(Role || (Role = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW1DO0FBRW5DLEdBQUcsQ0FBUTtJQUdQLFdBQVcsRUFBRTtRQUVULElBQUksRUFBRSxDQUFDO1FBRVAsTUFBTSxFQUFFLEVBQUU7UUFFVixVQUFVLEVBQUUsS0FBSztRQUVqQixRQUFRLEVBQUUsSUFBSTtRQUVkLEtBQUssRUFBRSxJQUFJO0tBQ2Q7SUFHRCxVQUFVLEVBQUU7UUFDUixJQUFJLEVBQUUsQ0FBQztRQUNQLE1BQU0sRUFBRSxFQUFFO1FBQ1YsVUFBVSxFQUFFLEtBQUs7UUFDakIsUUFBUSxFQUFFLElBQUk7UUFDZCxLQUFLLEVBQUUsSUFBSTtLQUNkO0lBR0QsYUFBYSxFQUFFLEVBQUc7SUFHbEIsWUFBWSxFQUFFLEVBQUc7SUFHakIsSUFBSTtRQUFKLGlCQXFDQztRQW5DRyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFHbEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUcsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFFLENBQUM7UUFHeEQsTUFBTSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUMsVUFBVSxDQUFFLENBQUMsR0FBRyxDQUFFLFVBQUEsR0FBRztZQUNuQyxNQUFNLENBQUMsY0FBYyxDQUFFLEtBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO2dCQUN6QyxZQUFZLEVBQUUsSUFBSTtnQkFDbEIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLEdBQUcsRUFBRSxVQUFVLEdBQUc7b0JBRWQsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBRSxHQUFHLENBQUUsQ0FBQztvQkFDcEMsSUFBSSxDQUFDLFdBQVcsQ0FBRSxHQUFHLENBQUUsR0FBRyxHQUFHLENBQUM7b0JBQzlCLElBQUssS0FBSyxDQUFDLE9BQU8sQ0FBRSxJQUFJLENBQUMsYUFBYSxDQUFFLEdBQUcs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WUFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNULElBQUksRUFBRSxNQUFNO2dCQUNaLFFBQVEsRUFBRSxJQUFJO2dCQUNkLEtBQUssRUFBRSxTQUFTO2FBQ25CLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFBO0lBRVYsQ0FBQztDQUNKLENBQUMsQ0FBQztBQWtCSCxJQUFLLElBR0o7QUFIRCxXQUFLLElBQUk7SUFDTCxtQ0FBTSxDQUFBO0lBQ04saUNBQUssQ0FBQTtBQUNULENBQUMsRUFISSxJQUFJLEtBQUosSUFBSSxRQUdSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaHR0cCB9IGZyb20gJy4vdXRpbC9odHRwJztcblxuQXBwPE15QXBwPih7XG5cbiAgICAvKiogZmFkZSBnbG9iYWxEYXRhICovXG4gICAgZ2xvYmFsRGF0YSQ6IHtcbiAgICAgICAgLy8g55m75b2V5Lq65p2D6ZmQXG4gICAgICAgIHJvbGU6IDAsXG4gICAgICAgIC8vIOeZu+W9leS6umlkXG4gICAgICAgIG9wZW5pZDogJycsXG4gICAgICAgIC8vIOaYr+WQpuW3sue7j+aOiOadg+eUqOaIt+S/oeaBr1xuICAgICAgICBpc1VzZXJBdXRoOiBmYWxzZSxcbiAgICAgICAgLy8g55So5oi35L+h5oGvXG4gICAgICAgIHVzZXJJbmZvOiBudWxsLFxuICAgICAgICAvKiog5piv5ZCm5piv5paw5a6i5oi3ICovXG4gICAgICAgIGlzTmV3OiB0cnVlXG4gICAgfSxcblxuICAgIC8qKiDlhajlsYBzdG9yZSAqL1xuICAgIGdsb2JhbERhdGE6IHtcbiAgICAgICAgcm9sZTogMCxcbiAgICAgICAgb3BlbmlkOiAnJyxcbiAgICAgICAgaXNVc2VyQXV0aDogZmFsc2UsXG4gICAgICAgIHVzZXJJbmZvOiBudWxsLFxuICAgICAgICBpc05ldzogdHJ1ZVxuICAgIH0sXG5cbiAgICAvKiog55uR5ZCs5Ye95pWw55qE5a+56LGh5pWw57uEICovXG4gICAgd2F0Y2hDYWxsQmFjazogeyB9LFxuXG4gICAgLyoqIOebkeWQrOWIl+ihqCAqL1xuICAgIHdhdGNoaW5nS2V5czogWyBdLFxuXG4gICAgLyoqIOWIneWni+WMliAqL1xuICAgIGluaXQoICkge1xuXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgLy8g5YWo5bGA5pWw5o2uXG4gICAgICAgIHRoaXMuZ2xvYmFsRGF0YSQgPSBPYmplY3QuYXNzaWduKHsgfSwgdGhpcy5nbG9iYWxEYXRhICk7XG5cbiAgICAgICAgLy8gd2F0Y2hcbiAgICAgICAgT2JqZWN0LmtleXMoIHRoaXMuZ2xvYmFsRGF0YSApLm1hcCgga2V5ID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcy5nbG9iYWxEYXRhLCBrZXksIHtcbiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCB2YWwgKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGAke2tleX3ooqtzZXRgLCB2YWwgKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkID0gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAgICAgICAgIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdID0gdmFsO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIEFycmF5LmlzQXJyYXkoIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LndhdGNoQ2FsbEJhY2tbIGtleSBdLm1hcChmdW5jID0+IGZ1bmMoIHZhbCwgb2xkICkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyDnlKjmiLfkv6Hmga9cbiAgICAgICAgd3guZ2V0U2V0dGluZyh7XG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgIC8vIOaYr+WQpuW3sue7j+aOiOadg1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzVXNlckF1dGggPSByZXMuYXV0aFNldHRpbmdbJ3Njb3BlLnVzZXJJbmZvJ107XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgaXNVc2VyQXV0aDogaXNVc2VyQXV0aCA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBpc1VzZXJBdXRoXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgfSxcblxuICAgIC8qKiDliJ3lp4vljJbkupHlh73mlbDmlbDmja7lupMgKi9cbiAgICBpbml0Q2xvdWQoICkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKCByZXNvbHZlLCByZWplY3QgKSA9PiB7XG5cbiAgICAgICAgICAgIC8vIOS6kVxuICAgICAgICAgICAgd3guY2xvdWQuaW5pdCh7XG4gICAgICAgICAgICAgICAgdHJhY2VVc2VyOiB0cnVlXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiDov5nph4zlj6/og73opoHlnKjmjIflrprpobXpnaLljrvlj5HotbfigJzmv4DmtLvigJ1cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgLy8gaHR0cCh7XG4gICAgICAgICAgICAvLyAgICAgdXJsOiAnY29tbW9uX2luaXQnLFxuICAgICAgICAgICAgLy8gICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAvLyAgICAgICAgIGlmICggcmVzLnN0YXR1cyAhPT0gMjAwICkge1xuICAgICAgICAgICAgLy8gICAgICAgICAgICAgcmV0dXJuIHJlamVjdCggKTtcbiAgICAgICAgICAgIC8vICAgICAgICAgfVxuICAgICAgICAgICAgLy8gICAgICAgICByZXNvbHZlKCApO1xuICAgICAgICAgICAgLy8gICAgIH1cbiAgICAgICAgICAgIC8vIH0pXG5cbiAgICAgICAgICAgIHJlc29sdmUoICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog5piv5ZCm5Li65paw5a6iICovXG4gICAgZ2V0SXNOZXdDdXN0b20oICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIHVybDogJ2NvbW1vbl9pcy1uZXctY3VzdG9tZXInLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc05ldzogcmVzLmRhdGFcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKiog5YWo5bGA5pa55rOV77yM6I635Y+W5b6u5L+h55So5oi355m75b2V5L+h5oGv44CB5o6I5p2D44CB5LiK5Lyg5L+d5a2YICovXG4gICAgZ2V0V3hVc2VySW5mbyggY2IgKSB7XG4gICAgICAgIHd4LmdldFVzZXJJbmZvKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJzMzMycpO1xuICAgICAgICAgICAgICAgIGh0dHAoe1xuICAgICAgICAgICAgICAgICAgICBkYXRhOiByZXMudXNlckluZm8sXG4gICAgICAgICAgICAgICAgICAgIHVybDogJ2NvbW1vbl91c2VyRWRpdCcsXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHJlczIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCByZXMyICYmIHJlczIuc3RhdHVzID09PSAyMDAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNVc2VyQXV0aDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlckluZm86IHJlcy51c2VySW5mb1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiICYmIGNiKCApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDojrflj5bnlKjmiLfmnYPpmZDkv6Hmga8gcm9sZS8gb3BlbmlkICovXG4gICAgZ2V0VXNlckluZm8oICkge1xuICAgICAgICB3eC5jbG91ZC5jYWxsRnVuY3Rpb24oe1xuICAgICAgICAgICAgbmFtZTogJ2xvZ2luJ1xuICAgICAgICB9KS50aGVuKCggcmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSggcmVzLnJlc3VsdCApO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOiuvue9ruWFqOWxgOaVsOaNriAqL1xuICAgIHNldEdsb2JhbERhdGEoIG9iaiApIHtcbiAgICAgICAgY29uc29sZS5sb2coICfjgJAtLS0tIEdsb2JhbCBTZXQgLS0tLeOAkScsIG9iaiApXG4gICAgICAgIE9iamVjdC5rZXlzKCBvYmogKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdsb2JhbERhdGFbIGtleSBdID0gb2JqWyBrZXkgXTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKiB3YXRjaOWHveaVsCAqL1xuICAgIHdhdGNoJCgga2V5LCBjYiApIHtcbiAgICAgICAgdGhpcy53YXRjaENhbGxCYWNrID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMud2F0Y2hDYWxsQmFjaywge1xuICAgICAgICAgICAgWyBrZXkgXTogdGhpcy53YXRjaENhbGxCYWNrWyBrZXkgXSB8fCBbIF1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2F0Y2hDYWxsQmFja1sga2V5IF0ucHVzaCggY2IgKTtcbiAgICAgICAgY29uc29sZS5sb2coICd3YXRjaCQuLi4uJywga2V5ICk7XG4gICAgICAgIC8vIOeri+mprOaJp+ihjOS4gOS4i2NiXG4gICAgICAgIHNldFRpbWVvdXQoKCApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgY29uc3Qgb2xkID0gdGhpcy5nbG9iYWxEYXRhWyBrZXkgXTtcbiAgICAgICAgICAgIGNiKCB2YWwsIG9sZCApO1xuICAgICAgICB9LCAwICk7XG5cbiAgICAgICAgLy8g5omn6KGMc2V055qE5pe25YCZ77yM5YaN5omn6KGM5LiA5LiLY2JcbiAgICAgICAgaWYgKCAhdGhpcy53YXRjaGluZ0tleXMuZmluZCggeCA9PiB4ID09PSBrZXkgKSkge1xuICAgICAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICB0aGlzLndhdGNoaW5nS2V5cy5wdXNoKCBrZXkgKTtcbiAgICAgICAgICAgIC8vIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcy5nbG9iYWxEYXRhLCBrZXksIHtcbiAgICAgICAgICAgIC8vICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAvLyAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICBzZXQ6IGZ1bmN0aW9uKCB2YWwgKSB7XG4gICAgICAgICAgICAvLyAgICAgICAgIGNvbnNvbGUubG9nKGAke2tleX3ooqtzZXRgLCB2YWwgKTtcbiAgICAgICAgICAgIC8vICAgICAgICAgY29uc3Qgb2xkID0gdGhhdC5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICAvLyAgICAgICAgIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdID0gdmFsO1xuICAgICAgICAgICAgLy8gICAgICAgICB0aGF0LndhdGNoQ2FsbEJhY2tbIGtleSBdLm1hcChmdW5jID0+IGZ1bmMoIHZhbCwgb2xkICkpO1xuICAgICAgICAgICAgLy8gICAgIH0sXG4gICAgICAgICAgICAvLyAgICAgZ2V0OiBmdW5jdGlvbiggKSB7XG4gICAgICAgICAgICAvLyAgICAgICAgIHJldHVybiB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgIC8vICAgICB9XG4gICAgICAgICAgICAvLyB9KTtcbiAgICAgICAgfVxuICAgIH0sXG4gIFxuICAgIC8qKiDnlJ/lkb3lkajmnJ8gKi9cbiAgICBvbkxhdW5jaDogZnVuY3Rpb24oICkge1xuICAgICAgICB0aGlzLmluaXQoICk7XG4gICAgICAgIHRoaXMuaW5pdENsb3VkKCApXG4gICAgICAgICAgICAudGhlbigoICkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0VXNlckluZm8oICk7XG4gICAgICAgICAgICAgICAgdGhpcy5nZXRJc05ld0N1c3RvbSggKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goIGUgPT4ge1xuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgICAgICAgIGljb246ICdub25lJyxcbiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIwMDAsXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAn5pWw5o2u5bqT5Yid5aeL6ZSZ6K+vJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgXG4gICAgfVxufSk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTXlBcHAge1xuICAgIGdsb2JhbERhdGE6IGdsb2JhbFN0YXRlLFxuICAgIGdsb2JhbERhdGEkOiBnbG9iYWxTdGF0ZSxcbiAgICB3YXRjaENhbGxCYWNrOiB7XG4gICAgICAgIFsga2V5OiBzdHJpbmcgXTogKCggdmFsMTogYW55LCB2YWwyOiBhbnkgKSA9PiB2b2lkKVsgXVxuICAgIH1cbiAgICB3YXRjaGluZ0tleXM6IHN0cmluZ1sgXVxuICAgIGluaXQ6ICggKSA9PiB2b2lkXG4gICAgaW5pdENsb3VkOiAoICkgPT4gUHJvbWlzZTxhbnk+XG4gICAgZ2V0VXNlckluZm86ICggKSA9PiB2b2lkLFxuICAgIGdldElzTmV3Q3VzdG9tOiAgKCApID0+IHZvaWQsXG4gICAgZ2V0V3hVc2VySW5mbzogKCBjYj86ICggKSA9PiB2b2lkICkgPT4gdm9pZCxcbiAgICBzZXRHbG9iYWxEYXRhOiA8SyBleHRlbmRzIGtleW9mIGdsb2JhbFN0YXRlPiggZGF0YTogZ2xvYmFsU3RhdGUgfCBQaWNrPGdsb2JhbFN0YXRlLCBLPiApID0+IHZvaWQsXG4gICAgd2F0Y2gkOiAoIGtleToga2V5b2YgZ2xvYmFsU3RhdGUsIGFueSApID0+IHZvaWRcbn1cblxuZW51bSBSb2xlIHtcbiAgICBub3JtYWwsXG4gICAgYWRtaW5cbn1cblxudHlwZSBnbG9iYWxTdGF0ZSA9IHtcbiAgICByb2xlOiBSb2xlLFxuICAgIG9wZW5pZDogc3RyaW5nLFxuICAgIGlzVXNlckF1dGg6IGJvb2xlYW4sXG4gICAgdXNlckluZm86IGFueVxuICAgIGlzTmV3OiBib29sZWFuXG59Il19