"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("./util/http");
App({
    globalData$: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true
    },
    globalData: {
        role: 0,
        openid: '',
        isUserAuth: false,
        userInfo: null,
        isNew: true
    },
    watchCallBack: {},
    watchingKeys: [],
    init: function () {
        var _this = this;
        var that = this;
        wx.cloud.init({
            traceUser: true
        });
        this.globalData$ = Object.assign({}, this.globalData);
        Object.keys(this.globalData).map(function (key) {
            Object.defineProperty(_this.globalData, key, {
                configurable: true,
                enumerable: true,
                set: function (val) {
                    console.log(key + "\u88ABset", val);
                    var old = that.globalData$[key];
                    that.globalData$[key] = val;
                    if (Array.isArray(that.watchCallBack[key])) {
                        that.watchCallBack[key].map(function (func) { return func(val, old); });
                    }
                },
                get: function () {
                    return that.globalData$[key];
                }
            });
        });
        wx.getSetting({
            success: function (res) {
                var isUserAuth = res.authSetting['scope.userInfo'];
                _this.setGlobalData({
                    isUserAuth: isUserAuth === undefined ? false : isUserAuth
                });
            }
        });
    },
    getIsNewCustom: function () {
        var _this = this;
        http_1.http({
            url: 'common_is-new-customer',
            success: function (res) {
                _this.setGlobalData({
                    isNew: res.data
                });
            }
        });
    },
    getWxUserInfo: function (cb) {
        var _this = this;
        wx.getUserInfo({
            success: function (res) {
                http_1.http({
                    data: res.userInfo,
                    url: 'common_userEdit',
                    success: function (res2) {
                        if (res2 && res2.status === 200) {
                            _this.setGlobalData({
                                isUserAuth: true,
                                userInfo: res.userInfo
                            });
                            cb && cb();
                        }
                    }
                });
            }
        });
    },
    getUserInfo: function () {
        var _this = this;
        wx.cloud.callFunction({
            name: 'login'
        }).then(function (res) {
            _this.setGlobalData(res.result);
        });
    },
    setGlobalData: function (obj) {
        var _this = this;
        console.log('【---- Global Set ----】', obj);
        Object.keys(obj).map(function (key) {
            _this.globalData[key] = obj[key];
        });
    },
    watch$: function (key, cb) {
        var _this = this;
        var _a;
        this.watchCallBack = Object.assign({}, this.watchCallBack, (_a = {},
            _a[key] = this.watchCallBack[key] || [],
            _a));
        this.watchCallBack[key].push(cb);
        console.log('watch$....', key);
        setTimeout(function () {
            var val = _this.globalData$[key];
            var old = _this.globalData[key];
            cb(val, old);
        }, 0);
        if (!this.watchingKeys.find(function (x) { return x === key; })) {
            var that = this;
            this.watchingKeys.push(key);
        }
    },
    onLaunch: function () {
        this.init();
        this.getUserInfo();
        this.getIsNewCustom();
    }
});
var Role;
(function (Role) {
    Role[Role["normal"] = 0] = "normal";
    Role[Role["admin"] = 1] = "admin";
})(Role || (Role = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW1DO0FBRW5DLEdBQUcsQ0FBUTtJQUdQLFdBQVcsRUFBRTtRQUVULElBQUksRUFBRSxDQUFDO1FBRVAsTUFBTSxFQUFFLEVBQUU7UUFFVixVQUFVLEVBQUUsS0FBSztRQUVqQixRQUFRLEVBQUUsSUFBSTtRQUVkLEtBQUssRUFBRSxJQUFJO0tBQ2Q7SUFHRCxVQUFVLEVBQUU7UUFDUixJQUFJLEVBQUUsQ0FBQztRQUNQLE1BQU0sRUFBRSxFQUFFO1FBQ1YsVUFBVSxFQUFFLEtBQUs7UUFDakIsUUFBUSxFQUFFLElBQUk7UUFDZCxLQUFLLEVBQUUsSUFBSTtLQUNkO0lBR0QsYUFBYSxFQUFFLEVBQUc7SUFHbEIsWUFBWSxFQUFFLEVBQUc7SUFHakIsSUFBSTtRQUFKLGlCQXlDQztRQXZDRyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFFbEIsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7WUFDVixTQUFTLEVBQUUsSUFBSTtTQUNsQixDQUFDLENBQUM7UUFHSCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQztRQUd4RCxNQUFNLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQyxHQUFHLENBQUUsVUFBQSxHQUFHO1lBQ25DLE1BQU0sQ0FBQyxjQUFjLENBQUUsS0FBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7Z0JBQ3pDLFlBQVksRUFBRSxJQUFJO2dCQUNsQixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsR0FBRyxFQUFFLFVBQVUsR0FBRztvQkFDZCxPQUFPLENBQUMsR0FBRyxDQUFJLEdBQUcsY0FBTSxFQUFFLEdBQUcsQ0FBRSxDQUFDO29CQUNoQyxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxD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cHA8TXlBcHA+KHtcblxuICAgIC8qKiBmYWRlIGdsb2JhbERhdGEgKi9cbiAgICBnbG9iYWxEYXRhJDoge1xuICAgICAgICAvLyDnmbvlvZXkurrmnYPpmZBcbiAgICAgICAgcm9sZTogMCxcbiAgICAgICAgLy8g55m75b2V5Lq6aWRcbiAgICAgICAgb3BlbmlkOiAnJyxcbiAgICAgICAgLy8g5piv5ZCm5bey57uP5o6I5p2D55So5oi35L+h5oGvXG4gICAgICAgIGlzVXNlckF1dGg6IGZhbHNlLFxuICAgICAgICAvLyDnlKjmiLfkv6Hmga9cbiAgICAgICAgdXNlckluZm86IG51bGwsXG4gICAgICAgIC8qKiDmmK/lkKbmmK/mlrDlrqLmiLcgKi9cbiAgICAgICAgaXNOZXc6IHRydWVcbiAgICB9LFxuXG4gICAgLyoqIOWFqOWxgHN0b3JlICovXG4gICAgZ2xvYmFsRGF0YToge1xuICAgICAgICByb2xlOiAwLFxuICAgICAgICBvcGVuaWQ6ICcnLFxuICAgICAgICBpc1VzZXJBdXRoOiBmYWxzZSxcbiAgICAgICAgdXNlckluZm86IG51bGwsXG4gICAgICAgIGlzTmV3OiB0cnVlXG4gICAgfSxcblxuICAgIC8qKiDnm5HlkKzlh73mlbDnmoTlr7nosaHmlbDnu4QgKi9cbiAgICB3YXRjaENhbGxCYWNrOiB7IH0sXG5cbiAgICAvKiog55uR5ZCs5YiX6KGoICovXG4gICAgd2F0Y2hpbmdLZXlzOiBbIF0sXG5cbiAgICAvKiog5Yid5aeL5YyWICovXG4gICAgaW5pdCggKSB7XG5cbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgIC8vIOS6kVxuICAgICAgICB3eC5jbG91ZC5pbml0KHtcbiAgICAgICAgICAgIHRyYWNlVXNlcjogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIOWFqOWxgOaVsOaNrlxuICAgICAgICB0aGlzLmdsb2JhbERhdGEkID0gT2JqZWN0LmFzc2lnbih7IH0sIHRoaXMuZ2xvYmFsRGF0YSApO1xuXG4gICAgICAgIC8vIHdhdGNoXG4gICAgICAgIE9iamVjdC5rZXlzKCB0aGlzLmdsb2JhbERhdGEgKS5tYXAoIGtleSA9PiB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMuZ2xvYmFsRGF0YSwga2V5LCB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiggdmFsICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtrZXl96KKrc2V0YCwgdmFsICk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZCA9IHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgICAgICAgICB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXSA9IHZhbDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBBcnJheS5pc0FycmF5KCB0aGF0LndhdGNoQ2FsbEJhY2tbIGtleSBdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC53YXRjaENhbGxCYWNrWyBrZXkgXS5tYXAoZnVuYyA9PiBmdW5jKCB2YWwsIG9sZCApKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiggKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8g55So5oi35L+h5oGvXG4gICAgICAgIHd4LmdldFNldHRpbmcoe1xuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICAvLyDmmK/lkKblt7Lnu4/mjojmnYNcbiAgICAgICAgICAgICAgICBjb25zdCBpc1VzZXJBdXRoID0gcmVzLmF1dGhTZXR0aW5nWydzY29wZS51c2VySW5mbyddO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0R2xvYmFsRGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIGlzVXNlckF1dGg6IGlzVXNlckF1dGggPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogaXNVc2VyQXV0aFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgIH0sXG5cbiAgICAvKiog5piv5ZCm5Li65paw5a6iICovXG4gICAgZ2V0SXNOZXdDdXN0b20oICkge1xuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIHVybDogJ2NvbW1vbl9pcy1uZXctY3VzdG9tZXInLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBpc05ldzogcmVzLmRhdGFcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKiog6I635Y+W5b6u5L+h55So5oi355m75b2V5L+h5oGv44CB5o6I5p2D44CB5LiK5Lyg5L+d5a2YICovXG4gICAgZ2V0V3hVc2VySW5mbyggY2IgKSB7XG4gICAgICAgIHd4LmdldFVzZXJJbmZvKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlcy51c2VySW5mbyxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAnY29tbW9uX3VzZXJFZGl0JyxcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogcmVzMiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlczIgJiYgcmVzMi5zdGF0dXMgPT09IDIwMCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEdsb2JhbERhdGEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1VzZXJBdXRoOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VySW5mbzogcmVzLnVzZXJJbmZvXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IgJiYgY2IoICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqIOiOt+WPlueUqOaIt+adg+mZkOS/oeaBryByb2xlLyBvcGVuaWQgKi9cbiAgICBnZXRVc2VySW5mbyggKSB7XG4gICAgICAgIHd4LmNsb3VkLmNhbGxGdW5jdGlvbih7XG4gICAgICAgICAgICBuYW1lOiAnbG9naW4nXG4gICAgICAgIH0pLnRoZW4oKCByZXM6IGFueSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRHbG9iYWxEYXRhKCByZXMucmVzdWx0ICk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog6K6+572u5YWo5bGA5pWw5o2uICovXG4gICAgc2V0R2xvYmFsRGF0YSggb2JqICkge1xuICAgICAgICBjb25zb2xlLmxvZyggJ+OAkC0tLS0gR2xvYmFsIFNldCAtLS0t44CRJywgb2JqIClcbiAgICAgICAgT2JqZWN0LmtleXMoIG9iaiApLm1hcCgga2V5ID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2xvYmFsRGF0YVsga2V5IF0gPSBvYmpbIGtleSBdO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIHdhdGNo5Ye95pWwICovXG4gICAgd2F0Y2gkKCBrZXksIGNiICkge1xuICAgICAgICB0aGlzLndhdGNoQ2FsbEJhY2sgPSBPYmplY3QuYXNzaWduKHsgfSwgdGhpcy53YXRjaENhbGxCYWNrLCB7XG4gICAgICAgICAgICBbIGtleSBdOiB0aGlzLndhdGNoQ2FsbEJhY2tbIGtleSBdIHx8IFsgXVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy53YXRjaENhbGxCYWNrWyBrZXkgXS5wdXNoKCBjYiApO1xuICAgICAgICBjb25zb2xlLmxvZyggJ3dhdGNoJC4uLi4nLCBrZXkgKTtcbiAgICAgICAgLy8g56uL6ams5omn6KGM5LiA5LiLY2JcbiAgICAgICAgc2V0VGltZW91dCgoICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5nbG9iYWxEYXRhJFsga2V5IF07XG4gICAgICAgICAgICBjb25zdCBvbGQgPSB0aGlzLmdsb2JhbERhdGFbIGtleSBdO1xuICAgICAgICAgICAgY2IoIHZhbCwgb2xkICk7XG4gICAgICAgIH0sIDAgKTtcblxuICAgICAgICAvLyDmiafooYxzZXTnmoTml7blgJnvvIzlho3miafooYzkuIDkuItjYlxuICAgICAgICBpZiAoICF0aGlzLndhdGNoaW5nS2V5cy5maW5kKCB4ID0+IHggPT09IGtleSApKSB7XG4gICAgICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMud2F0Y2hpbmdLZXlzLnB1c2goIGtleSApO1xuICAgICAgICAgICAgLy8gT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLmdsb2JhbERhdGEsIGtleSwge1xuICAgICAgICAgICAgLy8gICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgLy8gICAgIHNldDogZnVuY3Rpb24oIHZhbCApIHtcbiAgICAgICAgICAgIC8vICAgICAgICAgY29uc29sZS5sb2coYCR7a2V5feiiq3NldGAsIHZhbCApO1xuICAgICAgICAgICAgLy8gICAgICAgICBjb25zdCBvbGQgPSB0aGF0Lmdsb2JhbERhdGEkWyBrZXkgXTtcbiAgICAgICAgICAgIC8vICAgICAgICAgdGhhdC5nbG9iYWxEYXRhJFsga2V5IF0gPSB2YWw7XG4gICAgICAgICAgICAvLyAgICAgICAgIHRoYXQud2F0Y2hDYWxsQmFja1sga2V5IF0ubWFwKGZ1bmMgPT4gZnVuYyggdmFsLCBvbGQgKSk7XG4gICAgICAgICAgICAvLyAgICAgfSxcbiAgICAgICAgICAgIC8vICAgICBnZXQ6IGZ1bmN0aW9uKCApIHtcbiAgICAgICAgICAgIC8vICAgICAgICAgcmV0dXJuIHRoYXQuZ2xvYmFsRGF0YSRbIGtleSBdO1xuICAgICAgICAgICAgLy8gICAgIH1cbiAgICAgICAgICAgIC8vIH0pO1xuICAgICAgICB9XG4gICAgfSxcbiAgXG4gICAgLyoqIOeUn+WRveWRqOacnyAqL1xuICAgIG9uTGF1bmNoOiBmdW5jdGlvbiggKSB7XG4gICAgICAgIHRoaXMuaW5pdCggKTtcbiAgICAgICAgdGhpcy5nZXRVc2VySW5mbyggKTtcbiAgICAgICAgdGhpcy5nZXRJc05ld0N1c3RvbSggKTtcbiAgICB9XG59KTtcblxuZXhwb3J0IGludGVyZmFjZSBNeUFwcCB7XG4gICAgZ2xvYmFsRGF0YTogZ2xvYmFsU3RhdGUsXG4gICAgZ2xvYmFsRGF0YSQ6IGdsb2JhbFN0YXRlLFxuICAgIHdhdGNoQ2FsbEJhY2s6IHtcbiAgICAgICAgWyBrZXk6IHN0cmluZyBdOiAoKCB2YWwxOiBhbnksIHZhbDI6IGFueSApID0+IHZvaWQpWyBdXG4gICAgfVxuICAgIHdhdGNoaW5nS2V5czogc3RyaW5nWyBdXG4gICAgaW5pdDogKCApID0+IHZvaWRcbiAgICBnZXRVc2VySW5mbzogKCApID0+IHZvaWQsXG4gICAgZ2V0SXNOZXdDdXN0b206ICAoICkgPT4gdm9pZCxcbiAgICBnZXRXeFVzZXJJbmZvOiAoIGNiPzogKCApID0+IHZvaWQgKSA9PiB2b2lkLFxuICAgIHNldEdsb2JhbERhdGE6IDxLIGV4dGVuZHMga2V5b2YgZ2xvYmFsU3RhdGU+KCBkYXRhOiBnbG9iYWxTdGF0ZSB8IFBpY2s8Z2xvYmFsU3RhdGUsIEs+ICkgPT4gdm9pZCxcbiAgICB3YXRjaCQ6ICgga2V5OiBrZXlvZiBnbG9iYWxTdGF0ZSwgYW55ICkgPT4gdm9pZFxufVxuXG5lbnVtIFJvbGUge1xuICAgIG5vcm1hbCxcbiAgICBhZG1pblxufVxuXG50eXBlIGdsb2JhbFN0YXRlID0ge1xuICAgIHJvbGU6IFJvbGUsXG4gICAgb3BlbmlkOiBzdHJpbmcsXG4gICAgaXNVc2VyQXV0aDogYm9vbGVhbixcbiAgICB1c2VySW5mbzogYW55XG4gICAgaXNOZXc6IGJvb2xlYW5cbn0iXX0=