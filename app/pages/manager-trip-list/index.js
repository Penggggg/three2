"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("../../util/http");
var route_js_1 = require("../../util/route.js");
var form_id_1 = require("../../util/form-id");
Page({
    data: {
        page: 0,
        totalPage: 1,
        search: '',
        list: [],
        loadingList: false,
        canLoadMore: true,
        lastSearch: '',
        isNotAvailableTrip: false,
        bgs: [
            'background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);',
            'background-image: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);',
            'background-image: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);',
            'background-image: linear-gradient(to top, #37ecba 0%, #72afd3 100%);',
            'background-image: linear-gradient(-45deg, #FFC796 0%, #FF6B95 100%);',
            'background-image: linear-gradient(-225deg, #20E2D7 0%, #F9FEA5 100%);',
            'background-image: linear-gradient(-225deg, #9EFBD3 0%, #57E9F2 48%, #45D4FB 100%);',
        ]
    },
    navigate: function (e) {
        route_js_1.navTo('/pages/manager-trip-detail/index');
    },
    onConformSearch: function (_a) {
        var detail = _a.detail;
        this.setData({
            page: 0,
            totalPage: 0,
            search: detail,
            canLoadMore: true
        });
        this.fetchData();
    },
    fetchData: function () {
        var _this = this;
        var _a = this.data, canLoadMore = _a.canLoadMore, loadingList = _a.loadingList, lastSearch = _a.lastSearch, search = _a.search;
        if (loadingList || !canLoadMore) {
            return;
        }
        if (search.replace(/\s+/g, "") !== lastSearch) {
            this.setData({
                page: 0,
                totalPage: 1
            });
        }
        this.setData({
            loadingList: true
        });
        http_1.http({
            data: {
                page: this.data.page + 1,
                title: this.data.search
            },
            errMsg: '加载失败，请重试',
            loadingMsg: '加载中...',
            url: "trip_list",
            success: function (res) {
                var status = res.status, data = res.data;
                if (status === 200) {
                    var page = data.page, totalPage = data.totalPage, search_1 = data.search;
                    _this.setData({
                        page: page,
                        totalPage: totalPage,
                        lastSearch: search_1 || '',
                        canLoadMore: totalPage > page,
                        isNotAvailableTrip: !data.data.some(function (x) { return x.published === true && new Date().getTime() < x.start_date; })
                    });
                    if (data.data && data.data.length > 0) {
                        var meta = page === 1 ?
                            _this.dealListText(data.data) : _this.data.list.concat(_this.dealListText(data.data));
                        _this.setData({
                            list: meta
                        });
                    }
                    else {
                        _this.setData({
                            list: []
                        });
                    }
                }
                _this.setData({
                    loadingList: false
                });
            }
        });
    },
    dealListText: function (list) {
        var simpleTime = function (ts) {
            var time = new Date(Number(ts));
            return time.getMonth() + 1 + "\u6708" + time.getDate() + "\u65E5";
        };
        var simpleTime2 = function (ts) {
            var time = new Date(Number(ts));
            return time.getMonth() + 1 + "." + time.getDate();
        };
        var meta = list.map(function (x, k) {
            var _id = x._id, title = x.title, sales_volume = x.sales_volume, start_date = x.start_date, published = x.published, end_date = x.end_date, orders = x.orders, isClosed = x.isClosed;
            var state$ = !published ?
                '未发布' :
                isClosed ?
                    '已关闭' :
                    new Date().getTime() >= end_date ?
                        '已结束' :
                        new Date().getTime() >= start_date ?
                            '进行中' :
                            '即将开始';
            return {
                _id: _id,
                title: title,
                orders: orders,
                bg: k % 7,
                sales_volume: sales_volume,
                state: state$,
                ing: state$ === '进行中',
                endDate: simpleTime(end_date),
                startDate: simpleTime(start_date),
                endDate2: simpleTime2(end_date),
                startDate2: simpleTime2(start_date),
                red: state$ === '未发布' || state$ === '进行中' || state$ === '即将开始',
            };
        });
        return meta;
    },
    onInput: function (_a) {
        var detail = _a.detail;
        this.setData({
            search: detail.value,
            canLoadMore: detail.value.replace(/\s+/g, "") !== this.data.lastSearch
        });
    },
    onTab: function (_a) {
        var currentTarget = _a.currentTarget, detail = _a.detail;
        form_id_1.createFormId(detail.formId);
        var tid = currentTarget.dataset.tid;
        route_js_1.navTo("/pages/manager-trip-detail/index?id=" + tid);
    },
    goOrder: function (_a) {
        var currentTarget = _a.currentTarget, detail = _a.detail;
        var tid = currentTarget.dataset.tid;
        form_id_1.createFormId(detail.formId);
        route_js_1.navTo("/pages/manager-trip-order/index?id=" + tid);
    },
    onLoad: function () {
        wx.hideShareMenu({});
    },
    onReady: function () {
    },
    onShow: function () {
        this.setData({
            page: 0,
            canLoadMore: true
        });
        this.fetchData();
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHdDQUF1QztBQUN2QyxnREFBNEM7QUFDNUMsOENBQWtEO0FBR2xELElBQUksQ0FBQztJQU1ELElBQUksRUFBRTtRQUVGLElBQUksRUFBRSxDQUFDO1FBRVAsU0FBUyxFQUFFLENBQUM7UUFFWixNQUFNLEVBQUUsRUFBRTtRQUVWLElBQUksRUFBRSxFQUFHO1FBRVQsV0FBVyxFQUFFLEtBQUs7UUFFbEIsV0FBVyxFQUFFLElBQUk7UUFFakIsVUFBVSxFQUFFLEVBQUU7UUFFZCxrQkFBa0IsRUFBRSxLQUFLO1FBRXpCLEdBQUcsRUFBRTtZQUNELHNFQUFzRTtZQUN0RSxrRkFBa0Y7WUFDbEYsc0VBQXNFO1lBQ3RFLHNFQUFzRTtZQUN0RSxzRUFBc0U7WUFDdEUsdUVBQXVFO1lBQ3ZFLG9GQUFvRjtTQUN2RjtLQUNKO0lBR0QsUUFBUSxZQUFFLENBQUM7UUFDUCxnQkFBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUdELGVBQWUsWUFBQyxFQUFVO1lBQVIsa0JBQU07UUFDcEIsSUFBSSxDQUFDLE9BQVEsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1lBQ1AsU0FBUyxFQUFFLENBQUM7WUFDWixNQUFNLEVBQUUsTUFBTTtZQUNkLFdBQVcsRUFBRSxJQUFJO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxTQUFTLEVBQUcsQ0FBQztJQUN0QixDQUFDO0lBR0QsU0FBUztRQUFULGlCQTZEQztRQTNEUyxJQUFBLGNBQTRELEVBQTFELDRCQUFXLEVBQUUsNEJBQVcsRUFBRSwwQkFBVSxFQUFFLGtCQUFvQixDQUFDO1FBRW5FLElBQUssV0FBVyxJQUFJLENBQUMsV0FBVyxFQUFHO1lBQy9CLE9BQU87U0FDVjtRQUVELElBQUssTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEtBQUssVUFBVSxFQUFHO1lBQzdDLElBQUksQ0FBQyxPQUFRLENBQUM7Z0JBQ1YsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsU0FBUyxFQUFFLENBQUM7YUFDZixDQUFDLENBQUM7U0FDTjtRQUVELElBQUksQ0FBQyxPQUFRLENBQUM7WUFDVixXQUFXLEVBQUUsSUFBSTtTQUNwQixDQUFDLENBQUM7UUFFSCxXQUFJLENBQUM7WUFDRCxJQUFJLEVBQUU7Z0JBQ0YsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUM7Z0JBQ3hCLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU07YUFDMUI7WUFDRCxNQUFNLEVBQUUsVUFBVTtZQUNsQixVQUFVLEVBQUUsUUFBUTtZQUNwQixHQUFHLEVBQUUsV0FBVztZQUNoQixPQUFPLEVBQUUsVUFBQSxHQUFHO2dCQUNBLElBQUEsbUJBQU0sRUFBRSxlQUFJLENBQVM7Z0JBRTdCLElBQUssTUFBTSxLQUFLLEdBQUcsRUFBRztvQkFDVixJQUFBLGdCQUFJLEVBQUUsMEJBQVMsRUFBRSxzQkFBTSxDQUFVO29CQUV6QyxLQUFJLENBQUMsT0FBUSxDQUFDO3dCQUNWLElBQUksTUFBQTt3QkFDSixTQUFTLFdBQUE7d0JBQ1QsVUFBVSxFQUFFLFFBQU0sSUFBSSxFQUFFO3dCQUN4QixXQUFXLEVBQUUsU0FBUyxHQUFHLElBQUk7d0JBQzdCLGtCQUFrQixFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUUsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsU0FBUyxLQUFLLElBQUksSUFBSSxJQUFJLElBQUksRUFBRyxDQUFDLE9BQU8sRUFBRyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQTdELENBQTZELENBQUU7cUJBQzVHLENBQUMsQ0FBQztvQkFFSCxJQUFLLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFHO3dCQUNyQyxJQUFNLElBQUksR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUM7NEJBQ2pCLEtBQUksQ0FBQyxZQUFZLENBQUUsSUFBSSxDQUFDLElBQUksQ0FBRSxDQUFBLENBQUMsQ0FDOUIsS0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLFFBQUssS0FBSSxDQUFDLFlBQVksQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFFLENBQUMsQ0FBQzt3QkFFNUQsS0FBSSxDQUFDLE9BQVEsQ0FBQzs0QkFDVixJQUFJLEVBQUUsSUFBSTt5QkFDYixDQUFDLENBQUM7cUJBQ047eUJBQU07d0JBQ0gsS0FBSSxDQUFDLE9BQVEsQ0FBQzs0QkFDVixJQUFJLEVBQUUsRUFBRzt5QkFDWixDQUFDLENBQUM7cUJBQ047aUJBQ0o7Z0JBRUQsS0FBSSxDQUFDLE9BQVEsQ0FBQztvQkFDVixXQUFXLEVBQUUsS0FBSztpQkFDckIsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHRCxZQUFZLFlBQUUsSUFBSTtRQUVkLElBQU0sVUFBVSxHQUFHLFVBQUMsRUFBVTtZQUMxQixJQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBRSxNQUFNLENBQUUsRUFBRSxDQUFFLENBQUMsQ0FBQztZQUNyQyxPQUFVLElBQUksQ0FBQyxRQUFRLEVBQUcsR0FBQyxDQUFDLGNBQUksSUFBSSxDQUFDLE9BQU8sRUFBRyxXQUFHLENBQUE7UUFDdEQsQ0FBQyxDQUFDO1FBRUYsSUFBTSxXQUFXLEdBQUcsVUFBQyxFQUFVO1lBQzNCLElBQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFFLE1BQU0sQ0FBRSxFQUFFLENBQUUsQ0FBQyxDQUFDO1lBQ3JDLE9BQVUsSUFBSSxDQUFDLFFBQVEsRUFBRyxHQUFDLENBQUMsU0FBSSxJQUFJLENBQUMsT0FBTyxFQUFLLENBQUE7UUFDckQsQ0FBQyxDQUFDO1FBS0YsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFFLENBQUMsRUFBRSxDQUFDO1lBQ2hCLElBQUEsV0FBRyxFQUFFLGVBQUssRUFBRSw2QkFBWSxFQUFFLHlCQUFVLEVBQUUsdUJBQVMsRUFBRSxxQkFBUSxFQUFFLGlCQUFNLEVBQUUscUJBQVEsQ0FBTztZQUUxRixJQUFNLE1BQU0sR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN2QixLQUFLLENBQUMsQ0FBQztnQkFDUCxRQUFRLENBQUMsQ0FBQztvQkFDTixLQUFLLENBQUMsQ0FBQztvQkFDUCxJQUFJLElBQUksRUFBRyxDQUFDLE9BQU8sRUFBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDO3dCQUNoQyxLQUFLLENBQUMsQ0FBQzt3QkFDUCxJQUFJLElBQUksRUFBRyxDQUFDLE9BQU8sRUFBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDOzRCQUNsQyxLQUFLLENBQUMsQ0FBQzs0QkFDUCxNQUFNLENBQUM7WUFFdkIsT0FBTztnQkFDSCxHQUFHLEtBQUE7Z0JBQ0gsS0FBSyxPQUFBO2dCQUNMLE1BQU0sUUFBQTtnQkFDTixFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUM7Z0JBQ1QsWUFBWSxjQUFBO2dCQUNaLEtBQUssRUFBRSxNQUFNO2dCQUNiLEdBQUcsRUFBRSxNQUFNLEtBQUssS0FBSztnQkFDckIsT0FBTyxFQUFFLFVBQVUsQ0FBRSxRQUFRLENBQUU7Z0JBQy9CLFNBQVMsRUFBRSxVQUFVLENBQUUsVUFBVSxDQUFFO2dCQUNuQyxRQUFRLEVBQUUsV0FBVyxDQUFFLFFBQVEsQ0FBRTtnQkFDakMsVUFBVSxFQUFFLFdBQVcsQ0FBRSxVQUFVLENBQUU7Z0JBQ3JDLEdBQUcsRUFBRSxNQUFNLEtBQUssS0FBSyxJQUFJLE1BQU0sS0FBSyxLQUFLLElBQUksTUFBTSxLQUFLLE1BQU07YUFDakUsQ0FBQTtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUdELE9BQU8sWUFBQyxFQUFVO1lBQVIsa0JBQU07UUFDWixJQUFJLENBQUMsT0FBUSxDQUFDO1lBQ1YsTUFBTSxFQUFFLE1BQU0sQ0FBQyxLQUFLO1lBQ3BCLFdBQVcsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVO1NBQ3pFLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHRCxLQUFLLFlBQUMsRUFBeUI7WUFBdkIsZ0NBQWEsRUFBRSxrQkFBTTtRQUN6QixzQkFBWSxDQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUUsQ0FBQztRQUN0QixJQUFBLCtCQUFHLENBQTJCO1FBQ3RDLGdCQUFLLENBQUMseUNBQXVDLEdBQUssQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFHRCxPQUFPLFlBQUMsRUFBeUI7WUFBdkIsZ0NBQWEsRUFBRSxrQkFBTTtRQUNuQixJQUFBLCtCQUFHLENBQTJCO1FBQ3RDLHNCQUFZLENBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBRSxDQUFDO1FBQzlCLGdCQUFLLENBQUMsd0NBQXNDLEdBQUssQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFLRCxNQUFNLEVBQUU7UUFDSixFQUFFLENBQUMsYUFBYSxDQUFDLEVBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFLRCxPQUFPLEVBQUU7SUFFVCxDQUFDO0lBS0QsTUFBTSxFQUFFO1FBQ0osSUFBSSxDQUFDLE9BQVEsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1lBQ1AsV0FBVyxFQUFFLElBQUk7U0FDcEIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsRUFBRyxDQUFDO0lBQ3RCLENBQUM7SUFLRCxNQUFNLEVBQUU7SUFFUixDQUFDO0lBS0QsUUFBUSxFQUFFO0lBRVYsQ0FBQztJQUtELGlCQUFpQixFQUFFO0lBRW5CLENBQUM7SUFLRCxhQUFhLEVBQUU7SUFFZixDQUFDO0NBUUosQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBodHRwIH0gZnJvbSAnLi4vLi4vdXRpbC9odHRwJztcbmltcG9ydCB7IG5hdlRvIH0gZnJvbSAnLi4vLi4vdXRpbC9yb3V0ZS5qcyc7XG5pbXBvcnQgeyBjcmVhdGVGb3JtSWQgfSBmcm9tICcuLi8uLi91dGlsL2Zvcm0taWQnO1xuXG4vLyBhcHAvcGFnZXMvbWFuYWdlci1nb29kcy1kZXRhaWwvaW5kZXguanNcblBhZ2Uoe1xuXG4gICAgLyoqXG4gICAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXG4gICAgICogISDliJfooajlsZXnpLrnu7TluqbvvJrlkI3np7DjgIHplIDllK7pop3jgIHorqLljZXmlbDjgIHnirbmgIHjgIHlvIDlp4vml7bpl7RcbiAgICAgKi9cbiAgICBkYXRhOiB7XG4gICAgICAgIC8vIOW9k+WJjemhteeggVxuICAgICAgICBwYWdlOiAwLFxuICAgICAgICAvLyDmgLvpobXmlbBcbiAgICAgICAgdG90YWxQYWdlOiAxLFxuICAgICAgICAvLyDmkJzntKJcbiAgICAgICAgc2VhcmNoOiAnJyxcbiAgICAgICAgLy8g5ZWG5ZOB5YiX6KGoXG4gICAgICAgIGxpc3Q6IFsgXSxcbiAgICAgICAgLy8g5Yqg6L295YiX6KGoaW5nXG4gICAgICAgIGxvYWRpbmdMaXN0OiBmYWxzZSxcbiAgICAgICAgLy8g6IO95ZCm57un57ut5Yqg6L29XG4gICAgICAgIGNhbkxvYWRNb3JlOiB0cnVlLFxuICAgICAgICAvLyDkuIrmrKHmkJzntKLnmoTmlofmnKxcbiAgICAgICAgbGFzdFNlYXJjaDogJycsXG4gICAgICAgIC8vIOaYr+WQpuW3sue7j+ayoeacieS4i+S4gOS4quWPr+eUqOihjOeoi1xuICAgICAgICBpc05vdEF2YWlsYWJsZVRyaXA6IGZhbHNlLFxuICAgICAgICAvLyDog4zmma/moLflvI9cbiAgICAgICAgYmdzOiBbXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KDEyMGRlZywgIzg0ZmFiMCAwJSwgIzhmZDNmNCAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCg0NWRlZywgI2ZmOWE5ZSAwJSwgI2ZhZDBjNCA5OSUsICNmYWQwYzQgMTAwJSk7JyxcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQoMTIwZGVnLCAjODlmN2ZlIDAlLCAjNjZhNmZmIDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRvIHRvcCwgIzM3ZWNiYSAwJSwgIzcyYWZkMyAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCgtNDVkZWcsICNGRkM3OTYgMCUsICNGRjZCOTUgMTAwJSk7JyxcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQoLTIyNWRlZywgIzIwRTJENyAwJSwgI0Y5RkVBNSAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCgtMjI1ZGVnLCAjOUVGQkQzIDAlLCAjNTdFOUYyIDQ4JSwgIzQ1RDRGQiAxMDAlKTsnLFxuICAgICAgICBdXG4gICAgfSxcblxuICAgIC8qKiDot7PpobUgKi9cbiAgICBuYXZpZ2F0ZSggZSApIHtcbiAgICAgICAgbmF2VG8oJy9wYWdlcy9tYW5hZ2VyLXRyaXAtZGV0YWlsL2luZGV4Jyk7XG4gICAgfSxcblxuICAgIC8qKiDovpPlhaXmoYbnoa7orqQgKi9cbiAgICBvbkNvbmZvcm1TZWFyY2goeyBkZXRhaWwgfSkge1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIHBhZ2U6IDAsXG4gICAgICAgICAgICB0b3RhbFBhZ2U6IDAsXG4gICAgICAgICAgICBzZWFyY2g6IGRldGFpbCxcbiAgICAgICAgICAgIGNhbkxvYWRNb3JlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmZldGNoRGF0YSggKTtcbiAgICB9LFxuXG4gICAgLyoqIOaLieWPluWIl+ihqCAqL1xuICAgIGZldGNoRGF0YSggKSB7XG5cbiAgICAgICAgY29uc3QgeyBjYW5Mb2FkTW9yZSwgbG9hZGluZ0xpc3QsIGxhc3RTZWFyY2gsIHNlYXJjaCB9ID0gdGhpcy5kYXRhO1xuXG4gICAgICAgIGlmICggbG9hZGluZ0xpc3QgfHwgIWNhbkxvYWRNb3JlICkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCBzZWFyY2gucmVwbGFjZSgvXFxzKy9nLCBcIlwiKSAhPT0gbGFzdFNlYXJjaCApIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgIHBhZ2U6IDAsXG4gICAgICAgICAgICAgICAgdG90YWxQYWdlOiAxXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgbG9hZGluZ0xpc3Q6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaHR0cCh7XG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgcGFnZTogdGhpcy5kYXRhLnBhZ2UgKyAxLFxuICAgICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmRhdGEuc2VhcmNoXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyTXNnOiAn5Yqg6L295aSx6LSl77yM6K+36YeN6K+VJyxcbiAgICAgICAgICAgIGxvYWRpbmdNc2c6ICfliqDovb3kuK0uLi4nLFxuICAgICAgICAgICAgdXJsOiBgdHJpcF9saXN0YCxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBzdGF0dXMsIGRhdGEgfSA9IHJlcztcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIHN0YXR1cyA9PT0gMjAwICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHBhZ2UsIHRvdGFsUGFnZSwgc2VhcmNoIH0gPSBkYXRhO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxQYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlYXJjaDogc2VhcmNoIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuTG9hZE1vcmU6IHRvdGFsUGFnZSA+IHBhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc05vdEF2YWlsYWJsZVRyaXA6ICFkYXRhLmRhdGEuc29tZSggeCA9PiB4LnB1Ymxpc2hlZCA9PT0gdHJ1ZSAmJiBuZXcgRGF0ZSggKS5nZXRUaW1lKCApIDwgeC5zdGFydF9kYXRlIClcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIGRhdGEuZGF0YSAmJiBkYXRhLmRhdGEubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1ldGEgPSBwYWdlID09PSAxID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWFsTGlzdFRleHQoIGRhdGEuZGF0YSApOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsgLi4udGhpcy5kYXRhLmxpc3QsIC4uLnRoaXMuZGVhbExpc3RUZXh0KCBkYXRhLmRhdGEgKV07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3Q6IG1ldGFcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdDogWyBdXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICAgICAgbG9hZGluZ0xpc3Q6IGZhbHNlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKiog57yW6L6R6KGM56iL5YiX6KGo5paH5a2XICovXG4gICAgZGVhbExpc3RUZXh0KCBsaXN0ICkge1xuXG4gICAgICAgIGNvbnN0IHNpbXBsZVRpbWUgPSAodHM6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGltZSA9IG5ldyBEYXRlKCBOdW1iZXIoIHRzICkpO1xuICAgICAgICAgICAgcmV0dXJuIGAke3RpbWUuZ2V0TW9udGgoICkrMX3mnIgke3RpbWUuZ2V0RGF0ZSggKX3ml6VgXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgc2ltcGxlVGltZTIgPSAodHM6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGltZSA9IG5ldyBEYXRlKCBOdW1iZXIoIHRzICkpO1xuICAgICAgICAgICAgcmV0dXJuIGAke3RpbWUuZ2V0TW9udGgoICkrMX0uJHt0aW1lLmdldERhdGUoICl9YFxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiAhIOazqOaEj++8jOaXtumXtOWvueavlOOAguW8gOWni+aXtumXtOaYryDmjIflrprml6XmnJ/nmoTml6nkuIo454K577yb57uT5p2f5pel5pyf5pivIOaMh+WumuaXpeacn+eahOaZmuS4ijI0OjAwXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBtZXRhID0gbGlzdC5tYXAoKCB4LCBrICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBfaWQsIHRpdGxlLCBzYWxlc192b2x1bWUsIHN0YXJ0X2RhdGUsIHB1Ymxpc2hlZCwgZW5kX2RhdGUsIG9yZGVycywgaXNDbG9zZWQgfSA9IHg7XG5cbiAgICAgICAgICAgIGNvbnN0IHN0YXRlJCA9ICFwdWJsaXNoZWQgP1xuICAgICAgICAgICAgICAgICfmnKrlj5HluIMnIDpcbiAgICAgICAgICAgICAgICBpc0Nsb3NlZCA/XG4gICAgICAgICAgICAgICAgICAgICflt7LlhbPpl60nIDpcbiAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUoICkuZ2V0VGltZSggKSA+PSBlbmRfZGF0ZSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAn5bey57uT5p2fJyA6XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgRGF0ZSggKS5nZXRUaW1lKCApID49IHN0YXJ0X2RhdGUgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICfov5vooYzkuK0nIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAn5Y2z5bCG5byA5aeLJztcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBfaWQsXG4gICAgICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICAgICAgb3JkZXJzLFxuICAgICAgICAgICAgICAgIGJnOiBrICUgNyxcbiAgICAgICAgICAgICAgICBzYWxlc192b2x1bWUsXG4gICAgICAgICAgICAgICAgc3RhdGU6IHN0YXRlJCxcbiAgICAgICAgICAgICAgICBpbmc6IHN0YXRlJCA9PT0gJ+i/m+ihjOS4rScsXG4gICAgICAgICAgICAgICAgZW5kRGF0ZTogc2ltcGxlVGltZSggZW5kX2RhdGUgKSxcbiAgICAgICAgICAgICAgICBzdGFydERhdGU6IHNpbXBsZVRpbWUoIHN0YXJ0X2RhdGUgKSxcbiAgICAgICAgICAgICAgICBlbmREYXRlMjogc2ltcGxlVGltZTIoIGVuZF9kYXRlICksXG4gICAgICAgICAgICAgICAgc3RhcnREYXRlMjogc2ltcGxlVGltZTIoIHN0YXJ0X2RhdGUgKSxcbiAgICAgICAgICAgICAgICByZWQ6IHN0YXRlJCA9PT0gJ+acquWPkeW4gycgfHwgc3RhdGUkID09PSAn6L+b6KGM5LitJyB8fCBzdGF0ZSQgPT09ICfljbPlsIblvIDlp4snLFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1ldGE7XG4gICAgfSxcblxuICAgIC8qKiDmkJzntKLovpPlhaUgKi9cbiAgICBvbklucHV0KHsgZGV0YWlsIH0pIHtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBzZWFyY2g6IGRldGFpbC52YWx1ZSxcbiAgICAgICAgICAgIGNhbkxvYWRNb3JlOiBkZXRhaWwudmFsdWUucmVwbGFjZSgvXFxzKy9nLCBcIlwiKSAhPT0gdGhpcy5kYXRhLmxhc3RTZWFyY2hcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKiDngrnlh7vor6bmg4UgKi9cbiAgICBvblRhYih7IGN1cnJlbnRUYXJnZXQsIGRldGFpbCB9KSB7XG4gICAgICAgIGNyZWF0ZUZvcm1JZCggZGV0YWlsLmZvcm1JZCApO1xuICAgICAgICBjb25zdCB7IHRpZCB9ID0gY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgICAgICBuYXZUbyhgL3BhZ2VzL21hbmFnZXItdHJpcC1kZXRhaWwvaW5kZXg/aWQ9JHt0aWR9YCk7XG4gICAgfSxcblxuICAgIC8qKiDot7Pliqjor6bmg4XnmoTorqLljZUgKi9cbiAgICBnb09yZGVyKHsgY3VycmVudFRhcmdldCwgZGV0YWlsIH0pIHtcbiAgICAgICAgY29uc3QgeyB0aWQgfSA9IGN1cnJlbnRUYXJnZXQuZGF0YXNldDtcbiAgICAgICAgY3JlYXRlRm9ybUlkKCBkZXRhaWwuZm9ybUlkICk7XG4gICAgICAgIG5hdlRvKGAvcGFnZXMvbWFuYWdlci10cmlwLW9yZGVyL2luZGV4P2lkPSR7dGlkfWApO1xuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XG4gICAgICovXG4gICAgb25Mb2FkOiBmdW5jdGlvbiAoICkge1xuICAgICAgICB3eC5oaWRlU2hhcmVNZW51KHsgfSk7XG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcbiAgICAgKi9cbiAgICBvblJlYWR5OiBmdW5jdGlvbiAoICkge1xuICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgICAqL1xuICAgIG9uU2hvdzogZnVuY3Rpb24gKCApIHtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBwYWdlOiAwLFxuICAgICAgICAgICAgY2FuTG9hZE1vcmU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZmV0Y2hEYXRhKCApO1xuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i6ZqQ6JePXG4gICAgICovXG4gICAgb25IaWRlOiBmdW5jdGlvbiAoICkge1xuICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWNuOi9vVxuICAgICAqL1xuICAgIG9uVW5sb2FkOiBmdW5jdGlvbiAoICkge1xuICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDpobXpnaLnm7jlhbPkuovku7blpITnkIblh73mlbAtLeebkeWQrOeUqOaIt+S4i+aLieWKqOS9nFxuICAgICAqL1xuICAgIG9uUHVsbERvd25SZWZyZXNoOiBmdW5jdGlvbiAoICkge1xuICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcbiAgICAgKi9cbiAgICBvblJlYWNoQm90dG9tOiBmdW5jdGlvbiAoICkge1xuICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlKjmiLfngrnlh7vlj7PkuIrop5LliIbkuqtcbiAgICAgKi9cbiAgICAvLyBvblNoYXJlQXBwTWVzc2FnZTogZnVuY3Rpb24gKCkge1xuICBcbiAgICAvLyB9XG59KSJdfQ==