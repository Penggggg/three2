"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var app = getApp();
var http_1 = require("../../util/http");
var route_js_1 = require("../../util/route.js");
Page({
    data: {
        page: 0,
        totalPage: 1,
        search: '',
        list: [],
        loadingList: false,
        canLoadMore: true,
        lastSearch: '',
        isNotAvailableTrip: false,
        bgs: [
            'background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);',
            'background-image: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);',
            'background-image: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);',
            'background-image: linear-gradient(to top, #37ecba 0%, #72afd3 100%);',
            'background-image: linear-gradient(-45deg, #FFC796 0%, #FF6B95 100%);',
            'background-image: linear-gradient(-225deg, #20E2D7 0%, #F9FEA5 100%);',
            'background-image: linear-gradient(-225deg, #9EFBD3 0%, #57E9F2 48%, #45D4FB 100%);',
        ],
        bg2s: [
            'https://global-1257764567.cos.ap-guangzhou.myqcloud.com/icon-bg-trip-manager-list-colorful.png',
            'https://global-1257764567.cos.ap-guangzhou.myqcloud.com/icon-bg2-trip-manager-list-colorful.png'
        ],
        showSuccess: false
    },
    navigate: function (e) {
        route_js_1.navTo('/pages/manager-trip-detail/index');
    },
    onConformSearch: function (_a) {
        var detail = _a.detail;
        this.setData({
            page: 0,
            totalPage: 0,
            search: detail,
            canLoadMore: true
        });
        this.fetchData();
    },
    fetchData: function () {
        var _this = this;
        var _a = this.data, canLoadMore = _a.canLoadMore, loadingList = _a.loadingList, lastSearch = _a.lastSearch, search = _a.search;
        if (loadingList || !canLoadMore) {
            return;
        }
        if (search.replace(/\s+/g, "") !== lastSearch) {
            this.setData({
                page: 0,
                totalPage: 1
            });
        }
        this.setData({
            loadingList: true
        });
        http_1.http({
            data: {
                page: this.data.page + 1,
                title: this.data.search
            },
            errMsg: '加载失败，请重试',
            loadingMsg: '加载中...',
            url: "trip_list",
            success: function (res) {
                var status = res.status, data = res.data;
                if (status === 200) {
                    var page = data.page, totalPage = data.totalPage, search_1 = data.search;
                    _this.setData({
                        page: page,
                        totalPage: totalPage,
                        lastSearch: search_1 || '',
                        canLoadMore: totalPage > page,
                        isNotAvailableTrip: !data.data.some(function (x) { return x.published === true && new Date().getTime() < x.start_date; })
                    });
                    if (data.data && data.data.length > 0) {
                        var meta = page === 1 ?
                            _this.dealListText(data.data) : _this.data.list.concat(_this.dealListText(data.data));
                        _this.setData({
                            list: meta
                        });
                    }
                    else {
                        _this.setData({
                            list: []
                        });
                    }
                }
                _this.setData({
                    loadingList: false
                });
            }
        });
    },
    dealListText: function (list) {
        var bg2s = this.data.bg2s;
        var simpleTime = function (ts) {
            var time = new Date(Number(ts));
            return time.getMonth() + 1 + "\u6708" + time.getDate() + "\u65E5";
        };
        var simpleTime2 = function (ts) {
            var time = new Date(Number(ts));
            return time.getMonth() + 1 + "." + time.getDate();
        };
        var meta = list.map(function (x, k) {
            var _id = x._id, type = x.type, selectedProductIds = x.selectedProductIds, title = x.title, sales_volume = x.sales_volume, start_date = x.start_date, published = x.published, end_date = x.end_date, orders = x.orders, isClosed = x.isClosed, clients = x.clients, notPayAllClients = x.notPayAllClients;
            var state$ = !published ?
                '未发布' :
                isClosed ?
                    '已结束' :
                    new Date().getTime() >= end_date ?
                        '已结束' :
                        new Date().getTime() >= start_date ?
                            '进行中' :
                            '即将开始';
            return {
                _id: _id,
                tid: _id,
                title: title,
                orders: orders,
                bg: k % 7,
                imgBg: k % 2 ? bg2s[1] : bg2s[0],
                sales_volume: sales_volume,
                state$: state$,
                isClosed: isClosed,
                clients: clients,
                notPayAllClients: notPayAllClients,
                ing: state$ === '进行中',
                endDate: simpleTime(end_date),
                startDate: simpleTime(start_date),
                endDate2: simpleTime2(end_date),
                startDate2: simpleTime2(start_date),
                hasProductIds: selectedProductIds.length > 0,
                red: state$ === '未发布' || state$ === '进行中' || state$ === '即将开始',
                label: type === 'sys' && state$ === '进行中' ? '自动创建' : ''
            };
        });
        return meta;
    },
    onInput: function (_a) {
        var detail = _a.detail;
        this.setData({
            search: detail.value,
            canLoadMore: detail.value.replace(/\s+/g, "") !== this.data.lastSearch
        });
    },
    onTab: function (_a) {
        var currentTarget = _a.currentTarget, detail = _a.detail;
        var tid = currentTarget.dataset.tid;
        if (!tid) {
            return;
        }
        this.onSubscribe();
        route_js_1.navTo("/pages/manager-trip-detail/index?id=" + tid);
    },
    goOrder: function (_a) {
        var currentTarget = _a.currentTarget, detail = _a.detail;
        this.onSubscribe();
        var tid = currentTarget.dataset.tid;
        return http_1.http({
            url: 'trip_close-trip-analyze',
            data: {
                tid: tid
            }
        });
        route_js_1.navTo("/pages/manager-trip-order/index?id=" + tid);
    },
    onSubscribe: function () {
        app.getSubscribe('newOrder,trip,waitPin');
    },
    onLoad: function (query) {
        wx.hideShareMenu({});
        this.setData({
            showSuccess: String(query.s) === '1'
        });
    },
    onReady: function () {
    },
    onShow: function () {
        this.setData({
            page: 0,
            canLoadMore: true
        });
        this.fetchData();
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
    onShareAppMessage: function () {
        this.setData({
            showSuccess: false
        });
        return {
            title: '超值群拼团～进来看看吧',
            path: '/pages/ground-pin/index',
            imageUrl: 'https://global-1257764567.cos.ap-guangzhou.myqcloud.com/bg-trip-reward-share-colorful.jpg'
        };
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQU0sR0FBRyxHQUFHLE1BQU0sRUFBUSxDQUFDO0FBQzNCLHdDQUF1QztBQUN2QyxnREFBNEM7QUFFNUMsSUFBSSxDQUFDO0lBTUQsSUFBSSxFQUFFO1FBRUYsSUFBSSxFQUFFLENBQUM7UUFFUCxTQUFTLEVBQUUsQ0FBQztRQUVaLE1BQU0sRUFBRSxFQUFFO1FBRVYsSUFBSSxFQUFFLEVBQUc7UUFFVCxXQUFXLEVBQUUsS0FBSztRQUVsQixXQUFXLEVBQUUsSUFBSTtRQUVqQixVQUFVLEVBQUUsRUFBRTtRQUVkLGtCQUFrQixFQUFFLEtBQUs7UUFFekIsR0FBRyxFQUFFO1lBQ0Qsc0VBQXNFO1lBQ3RFLGtGQUFrRjtZQUNsRixzRUFBc0U7WUFDdEUsc0VBQXNFO1lBQ3RFLHNFQUFzRTtZQUN0RSx1RUFBdUU7WUFDdkUsb0ZBQW9GO1NBQ3ZGO1FBQ0QsSUFBSSxFQUFFO1lBQ0YsZ0dBQWdHO1lBQ2hHLGlHQUFpRztTQUNwRztRQUVELFdBQVcsRUFBRSxLQUFLO0tBQ3JCO0lBR0QsUUFBUSxZQUFFLENBQUM7UUFDUCxnQkFBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUdELGVBQWUsWUFBQyxFQUFVO1lBQVIsa0JBQU07UUFDcEIsSUFBSSxDQUFDLE9BQVEsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1lBQ1AsU0FBUyxFQUFFLENBQUM7WUFDWixNQUFNLEVBQUUsTUFBTTtZQUNkLFdBQVcsRUFBRSxJQUFJO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxTQUFTLEVBQUcsQ0FBQztJQUN0QixDQUFDO0lBR0QsU0FBUztRQUFULGlCQTZEQztRQTNEUyxJQUFBLGNBQTRELEVBQTFELDRCQUFXLEVBQUUsNEJBQVcsRUFBRSwwQkFBVSxFQUFFLGtCQUFvQixDQUFDO1FBRW5FLElBQUssV0FBVyxJ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QTthQUNOO1NBQ0osQ0FBQyxDQUFBO1FBQ0YsZ0JBQUssQ0FBQyx3Q0FBc0MsR0FBSyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVELFdBQVc7UUFDUCxHQUFHLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFDOUMsQ0FBQztJQU9ELE1BQU0sRUFBRSxVQUFXLEtBQVU7UUFDekIsRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsT0FBUSxDQUFDO1lBQ1YsV0FBVyxFQUFFLE1BQU0sQ0FBRSxLQUFLLENBQUMsQ0FBQyxDQUFFLEtBQUssR0FBRztTQUN6QyxDQUFDLENBQUE7SUFDTixDQUFDO0lBS0QsT0FBTyxFQUFFO0lBRVQsQ0FBQztJQUtELE1BQU0sRUFBRTtRQUNKLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDVixJQUFJLEVBQUUsQ0FBQztZQUNQLFdBQVcsRUFBRSxJQUFJO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxTQUFTLEVBQUcsQ0FBQztJQUN0QixDQUFDO0lBS0QsTUFBTSxFQUFFO0lBRVIsQ0FBQztJQUtELFFBQVEsRUFBRTtJQUVWLENBQUM7SUFLRCxpQkFBaUIsRUFBRTtJQUVuQixDQUFDO0lBS0QsYUFBYSxFQUFFO0lBRWYsQ0FBQztJQUtELGlCQUFpQixFQUFFO1FBQ2YsSUFBSSxDQUFDLE9BQVEsQ0FBQztZQUNWLFdBQVcsRUFBRSxLQUFLO1NBQ3JCLENBQUMsQ0FBQztRQUNILE9BQU87WUFDSCxLQUFLLEVBQUUsYUFBYTtZQUNwQixJQUFJLEVBQUUseUJBQXlCO1lBQy9CLFFBQVEsRUFBRSwyRkFBMkY7U0FDeEcsQ0FBQTtJQUNMLENBQUM7Q0FDSixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBhcHAgPSBnZXRBcHA8YW55PiggKTtcbmltcG9ydCB7IGh0dHAgfSBmcm9tICcuLi8uLi91dGlsL2h0dHAnO1xuaW1wb3J0IHsgbmF2VG8gfSBmcm9tICcuLi8uLi91dGlsL3JvdXRlLmpzJztcblxuUGFnZSh7XG5cbiAgICAvKipcbiAgICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICAgKiAhIOWIl+ihqOWxleekuue7tOW6pu+8muWQjeensOOAgemUgOWUrumineOAgeiuouWNleaVsOOAgeeKtuaAgeOAgeW8gOWni+aXtumXtFxuICAgICAqL1xuICAgIGRhdGE6IHtcbiAgICAgICAgLy8g5b2T5YmN6aG156CBXG4gICAgICAgIHBhZ2U6IDAsXG4gICAgICAgIC8vIOaAu+mhteaVsFxuICAgICAgICB0b3RhbFBhZ2U6IDEsXG4gICAgICAgIC8vIOaQnOe0olxuICAgICAgICBzZWFyY2g6ICcnLFxuICAgICAgICAvLyDllYblk4HliJfooahcbiAgICAgICAgbGlzdDogWyBdLFxuICAgICAgICAvLyDliqDovb3liJfooahpbmdcbiAgICAgICAgbG9hZGluZ0xpc3Q6IGZhbHNlLFxuICAgICAgICAvLyDog73lkKbnu6fnu63liqDovb1cbiAgICAgICAgY2FuTG9hZE1vcmU6IHRydWUsXG4gICAgICAgIC8vIOS4iuasoeaQnOe0oueahOaWh+acrFxuICAgICAgICBsYXN0U2VhcmNoOiAnJyxcbiAgICAgICAgLy8g5piv5ZCm5bey57uP5rKh5pyJ5LiL5LiA5Liq5Y+v55So6KGM56iLXG4gICAgICAgIGlzTm90QXZhaWxhYmxlVHJpcDogZmFsc2UsXG4gICAgICAgIC8vIOiDjOaZr+agt+W8j1xuICAgICAgICBiZ3M6IFtcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQoMTIwZGVnLCAjODRmYWIwIDAlLCAjOGZkM2Y0IDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCAjZmY5YTllIDAlLCAjZmFkMGM0IDk5JSwgI2ZhZDBjNCAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCgxMjBkZWcsICM4OWY3ZmUgMCUsICM2NmE2ZmYgMTAwJSk7JyxcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodG8gdG9wLCAjMzdlY2JhIDAlLCAjNzJhZmQzIDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KC00NWRlZywgI0ZGQzc5NiAwJSwgI0ZGNkI5NSAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCgtMjI1ZGVnLCAjMjBFMkQ3IDAlLCAjRjlGRUE1IDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KC0yMjVkZWcsICM5RUZCRDMgMCUsICM1N0U5RjIgNDglLCAjNDVENEZCIDEwMCUpOycsXG4gICAgICAgIF0sXG4gICAgICAgIGJnMnM6IFtcbiAgICAgICAgICAgICdodHRwczovL2dsb2JhbC0xMjU3NzY0NTY3LmNvcy5hcC1ndWFuZ3pob3UubXlxY2xvdWQuY29tL2ljb24tYmctdHJpcC1tYW5hZ2VyLWxpc3QtY29sb3JmdWwucG5nJyxcbiAgICAgICAgICAgICdodHRwczovL2dsb2JhbC0xMjU3NzY0NTY3LmNvcy5hcC1ndWFuZ3pob3UubXlxY2xvdWQuY29tL2ljb24tYmcyLXRyaXAtbWFuYWdlci1saXN0LWNvbG9yZnVsLnBuZydcbiAgICAgICAgXSxcbiAgICAgICAgLy8g5bGV56S65Yib5bu65oiQ5Yqf5o+Q56S6XG4gICAgICAgIHNob3dTdWNjZXNzOiBmYWxzZVxuICAgIH0sXG5cbiAgICAvKiog6Lez6aG1ICovXG4gICAgbmF2aWdhdGUoIGUgKSB7XG4gICAgICAgIG5hdlRvKCcvcGFnZXMvbWFuYWdlci10cmlwLWRldGFpbC9pbmRleCcpO1xuICAgIH0sXG5cbiAgICAvKiog6L6T5YWl5qGG56Gu6K6kICovXG4gICAgb25Db25mb3JtU2VhcmNoKHsgZGV0YWlsIH0pIHtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBwYWdlOiAwLFxuICAgICAgICAgICAgdG90YWxQYWdlOiAwLFxuICAgICAgICAgICAgc2VhcmNoOiBkZXRhaWwsXG4gICAgICAgICAgICBjYW5Mb2FkTW9yZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5mZXRjaERhdGEoICk7XG4gICAgfSxcblxuICAgIC8qKiDmi4nlj5bliJfooaggKi9cbiAgICBmZXRjaERhdGEoICkge1xuXG4gICAgICAgIGNvbnN0IHsgY2FuTG9hZE1vcmUsIGxvYWRpbmdMaXN0LCBsYXN0U2VhcmNoLCBzZWFyY2ggfSA9IHRoaXMuZGF0YTtcblxuICAgICAgICBpZiAoIGxvYWRpbmdMaXN0IHx8ICFjYW5Mb2FkTW9yZSApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICggc2VhcmNoLnJlcGxhY2UoL1xccysvZywgXCJcIikgIT09IGxhc3RTZWFyY2ggKSB7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICBwYWdlOiAwLFxuICAgICAgICAgICAgICAgIHRvdGFsUGFnZTogMVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIGxvYWRpbmdMaXN0OiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGh0dHAoe1xuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIHBhZ2U6IHRoaXMuZGF0YS5wYWdlICsgMSxcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5kYXRhLnNlYXJjaFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVyck1zZzogJ+WKoOi9veWksei0pe+8jOivt+mHjeivlScsXG4gICAgICAgICAgICBsb2FkaW5nTXNnOiAn5Yqg6L295LitLi4uJyxcbiAgICAgICAgICAgIHVybDogYHRyaXBfbGlzdGAsXG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgc3RhdHVzLCBkYXRhIH0gPSByZXM7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCBzdGF0dXMgPT09IDIwMCApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBwYWdlLCB0b3RhbFBhZ2UsIHNlYXJjaCB9ID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsUGFnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWFyY2g6IHNlYXJjaCB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbkxvYWRNb3JlOiB0b3RhbFBhZ2UgPiBwYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNOb3RBdmFpbGFibGVUcmlwOiAhZGF0YS5kYXRhLnNvbWUoIHggPT4geC5wdWJsaXNoZWQgPT09IHRydWUgJiYgbmV3IERhdGUoICkuZ2V0VGltZSggKSA8IHguc3RhcnRfZGF0ZSApXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBkYXRhLmRhdGEgJiYgZGF0YS5kYXRhLmxlbmd0aCA+IDAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXRhID0gcGFnZSA9PT0gMSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVhbExpc3RUZXh0KCBkYXRhLmRhdGEgKTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbIC4uLnRoaXMuZGF0YS5saXN0LCAuLi50aGlzLmRlYWxMaXN0VGV4dCggZGF0YS5kYXRhICldO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0OiBtZXRhXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3Q6IFsgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRpbmdMaXN0OiBmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOe8lui+keihjOeoi+WIl+ihqOaWh+WtlyAqL1xuICAgIGRlYWxMaXN0VGV4dCggbGlzdCApIHtcblxuICAgICAgICBjb25zdCB7IGJnMnMgfSA9IHRoaXMuZGF0YVxuXG4gICAgICAgIGNvbnN0IHNpbXBsZVRpbWUgPSAodHM6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGltZSA9IG5ldyBEYXRlKCBOdW1iZXIoIHRzICkpO1xuICAgICAgICAgICAgcmV0dXJuIGAke3RpbWUuZ2V0TW9udGgoICkrMX3mnIgke3RpbWUuZ2V0RGF0ZSggKX3ml6VgXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgc2ltcGxlVGltZTIgPSAodHM6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGltZSA9IG5ldyBEYXRlKCBOdW1iZXIoIHRzICkpO1xuICAgICAgICAgICAgcmV0dXJuIGAke3RpbWUuZ2V0TW9udGgoICkrMX0uJHt0aW1lLmdldERhdGUoICl9YFxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiAhIOazqOaEj++8jOaXtumXtOWvueavlOOAguW8gOWni+aXtumXtOaYryDmjIflrprml6XmnJ/nmoTml6nkuIo454K577yb57uT5p2f5pel5pyf5pivIOaMh+WumuaXpeacn+eahOaZmuS4ijI0OjAwXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBtZXRhID0gbGlzdC5tYXAoKCB4LCBrICkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBfaWQsIHR5cGUsIHNlbGVjdGVkUHJvZHVjdElkcywgdGl0bGUsIHNhbGVzX3ZvbHVtZSwgc3RhcnRfZGF0ZSwgcHVibGlzaGVkLCBlbmRfZGF0ZSwgb3JkZXJzLCBpc0Nsb3NlZCwgY2xpZW50cywgbm90UGF5QWxsQ2xpZW50cyB9ID0geDtcblxuICAgICAgICAgICAgY29uc3Qgc3RhdGUkID0gIXB1Ymxpc2hlZCA/XG4gICAgICAgICAgICAgICAgJ+acquWPkeW4gycgOlxuICAgICAgICAgICAgICAgIGlzQ2xvc2VkID9cbiAgICAgICAgICAgICAgICAgICAgJ+W3sue7k+adnycgOlxuICAgICAgICAgICAgICAgICAgICBuZXcgRGF0ZSggKS5nZXRUaW1lKCApID49IGVuZF9kYXRlID9cbiAgICAgICAgICAgICAgICAgICAgICAgICflt7Lnu5PmnZ8nIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKCApLmdldFRpbWUoICkgPj0gc3RhcnRfZGF0ZSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ+i/m+ihjOS4rScgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICfljbPlsIblvIDlp4snO1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIF9pZCxcbiAgICAgICAgICAgICAgICB0aWQ6IF9pZCxcbiAgICAgICAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICAgICAgICBvcmRlcnMsXG4gICAgICAgICAgICAgICAgYmc6IGsgJSA3LFxuICAgICAgICAgICAgICAgIGltZ0JnOiBrICUgMiA/IGJnMnNbIDEgXSA6IGJnMnNbIDAgXSxcbiAgICAgICAgICAgICAgICBzYWxlc192b2x1bWUsXG4gICAgICAgICAgICAgICAgc3RhdGUkLFxuICAgICAgICAgICAgICAgIGlzQ2xvc2VkLFxuICAgICAgICAgICAgICAgIGNsaWVudHMsXG4gICAgICAgICAgICAgICAgbm90UGF5QWxsQ2xpZW50cyxcbiAgICAgICAgICAgICAgICBpbmc6IHN0YXRlJCA9PT0gJ+i/m+ihjOS4rScsXG4gICAgICAgICAgICAgICAgZW5kRGF0ZTogc2ltcGxlVGltZSggZW5kX2RhdGUgKSxcbiAgICAgICAgICAgICAgICBzdGFydERhdGU6IHNpbXBsZVRpbWUoIHN0YXJ0X2RhdGUgKSxcbiAgICAgICAgICAgICAgICBlbmREYXRlMjogc2ltcGxlVGltZTIoIGVuZF9kYXRlICksXG4gICAgICAgICAgICAgICAgc3RhcnREYXRlMjogc2ltcGxlVGltZTIoIHN0YXJ0X2RhdGUgKSxcbiAgICAgICAgICAgICAgICBoYXNQcm9kdWN0SWRzOiBzZWxlY3RlZFByb2R1Y3RJZHMubGVuZ3RoID4gMCxcbiAgICAgICAgICAgICAgICByZWQ6IHN0YXRlJCA9PT0gJ+acquWPkeW4gycgfHwgc3RhdGUkID09PSAn6L+b6KGM5LitJyB8fCBzdGF0ZSQgPT09ICfljbPlsIblvIDlp4snLFxuICAgICAgICAgICAgICAgIGxhYmVsOiB0eXBlID09PSAnc3lzJyAmJiBzdGF0ZSQgPT09ICfov5vooYzkuK0nID8gJ+iHquWKqOWIm+W7uicgOiAnJ1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1ldGE7XG4gICAgfSxcblxuICAgIC8qKiDmkJzntKLovpPlhaUgKi9cbiAgICBvbklucHV0KHsgZGV0YWlsIH0pIHtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBzZWFyY2g6IGRldGFpbC52YWx1ZSxcbiAgICAgICAgICAgIGNhbkxvYWRNb3JlOiBkZXRhaWwudmFsdWUucmVwbGFjZSgvXFxzKy9nLCBcIlwiKSAhPT0gdGhpcy5kYXRhLmxhc3RTZWFyY2hcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKiDngrnlh7vor6bmg4UgKi9cbiAgICBvblRhYih7IGN1cnJlbnRUYXJnZXQsIGRldGFpbCB9KSB7XG4gICAgICAgIGNvbnN0IHsgdGlkIH0gPSBjdXJyZW50VGFyZ2V0LmRhdGFzZXQ7XG4gICAgICAgIGlmICggIXRpZCApIHsgcmV0dXJuOyB9XG4gICAgICAgIHRoaXMub25TdWJzY3JpYmUoICk7XG4gICAgICAgIG5hdlRvKGAvcGFnZXMvbWFuYWdlci10cmlwLWRldGFpbC9pbmRleD9pZD0ke3RpZH1gKTtcbiAgICB9LFxuXG4gICAgLyoqIOi3s+iuouWNleWIl+ihqCAqL1xuICAgIGdvT3JkZXIoeyBjdXJyZW50VGFyZ2V0LCBkZXRhaWwgfSkge1xuICAgICAgICB0aGlzLm9uU3Vic2NyaWJlKCApO1xuICAgICAgICBjb25zdCB7IHRpZCB9ID0gY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgICAgICByZXR1cm4gaHR0cCh7XG4gICAgICAgICAgICB1cmw6ICd0cmlwX2Nsb3NlLXRyaXAtYW5hbHl6ZScsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgdGlkXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIG5hdlRvKGAvcGFnZXMvbWFuYWdlci10cmlwLW9yZGVyL2luZGV4P2lkPSR7dGlkfWApO1xuICAgIH0sXG5cbiAgICBvblN1YnNjcmliZSggKSB7XG4gICAgICAgIGFwcC5nZXRTdWJzY3JpYmUoJ25ld09yZGVyLHRyaXAsd2FpdFBpbicpO1xuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIHF1ZXJ5IHtcbiAgICAgKiAgIHM6IDEvMCDliJvlu7rmiJDlip/vvIzmnInlvLnmoYZcbiAgICAgKiB9XG4gICAgICovXG4gICAgb25Mb2FkOiBmdW5jdGlvbiAoIHF1ZXJ5OiBhbnkgKSB7XG4gICAgICAgIHd4LmhpZGVTaGFyZU1lbnUoeyB9KTtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBzaG93U3VjY2VzczogU3RyaW5nKCBxdWVyeS5zICkgPT09ICcxJ1xuICAgICAgICB9KVxuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yid5qyh5riy5p+T5a6M5oiQXG4gICAgICovXG4gICAgb25SZWFkeTogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLmmL7npLpcbiAgICAgKi9cbiAgICBvblNob3c6IGZ1bmN0aW9uICggKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgcGFnZTogMCxcbiAgICAgICAgICAgIGNhbkxvYWRNb3JlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmZldGNoRGF0YSggKTtcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdoumakOiXj1xuICAgICAqL1xuICAgIG9uSGlkZTogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cbiAgICAgKi9cbiAgICBvblVubG9hZDogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICAgKi9cbiAgICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog6aG16Z2i5LiK5ouJ6Kem5bqV5LqL5Lu255qE5aSE55CG5Ye95pWwXG4gICAgICovXG4gICAgb25SZWFjaEJvdHRvbTogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55So5oi354K55Ye75Y+z5LiK6KeS5YiG5LqrXG4gICAgICovXG4gICAgb25TaGFyZUFwcE1lc3NhZ2U6IGZ1bmN0aW9uICggKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgc2hvd1N1Y2Nlc3M6IGZhbHNlXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGl0bGU6ICfotoXlgLznvqTmi7zlm6LvvZ7ov5vmnaXnnIvnnIvlkKcnLFxuICAgICAgICAgICAgcGF0aDogJy9wYWdlcy9ncm91bmQtcGluL2luZGV4JyxcbiAgICAgICAgICAgIGltYWdlVXJsOiAnaHR0cHM6Ly9nbG9iYWwtMTI1Nzc2NDU2Ny5jb3MuYXAtZ3Vhbmd6aG91Lm15cWNsb3VkLmNvbS9iZy10cmlwLXJld2FyZC1zaGFyZS1jb2xvcmZ1bC5qcGcnXG4gICAgICAgIH1cbiAgICB9XG59KSJdfQ==