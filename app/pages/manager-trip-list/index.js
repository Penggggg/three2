"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var app = getApp();
var http_1 = require("../../util/http");
var route_js_1 = require("../../util/route.js");
Page({
    data: {
        page: 0,
        totalPage: 1,
        search: '',
        list: [],
        loadingList: false,
        canLoadMore: true,
        lastSearch: '',
        isNotAvailableTrip: false,
        bgs: [
            'background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);',
            'background-image: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);',
            'background-image: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);',
            'background-image: linear-gradient(to top, #37ecba 0%, #72afd3 100%);',
            'background-image: linear-gradient(-45deg, #FFC796 0%, #FF6B95 100%);',
            'background-image: linear-gradient(-225deg, #20E2D7 0%, #F9FEA5 100%);',
            'background-image: linear-gradient(-225deg, #9EFBD3 0%, #57E9F2 48%, #45D4FB 100%);',
        ]
    },
    navigate: function (e) {
        route_js_1.navTo('/pages/manager-trip-detail/index');
    },
    onConformSearch: function (_a) {
        var detail = _a.detail;
        this.setData({
            page: 0,
            totalPage: 0,
            search: detail,
            canLoadMore: true
        });
        this.fetchData();
    },
    fetchData: function () {
        var _this = this;
        var _a = this.data, canLoadMore = _a.canLoadMore, loadingList = _a.loadingList, lastSearch = _a.lastSearch, search = _a.search;
        if (loadingList || !canLoadMore) {
            return;
        }
        if (search.replace(/\s+/g, "") !== lastSearch) {
            this.setData({
                page: 0,
                totalPage: 1
            });
        }
        this.setData({
            loadingList: true
        });
        http_1.http({
            data: {
                page: this.data.page + 1,
                title: this.data.search
            },
            errMsg: '加载失败，请重试',
            loadingMsg: '加载中...',
            url: "trip_list",
            success: function (res) {
                var status = res.status, data = res.data;
                if (status === 200) {
                    var page = data.page, totalPage = data.totalPage, search_1 = data.search;
                    _this.setData({
                        page: page,
                        totalPage: totalPage,
                        lastSearch: search_1 || '',
                        canLoadMore: totalPage > page,
                        isNotAvailableTrip: !data.data.some(function (x) { return x.published === true && new Date().getTime() < x.start_date; })
                    });
                    if (data.data && data.data.length > 0) {
                        var meta = page === 1 ?
                            _this.dealListText(data.data) : _this.data.list.concat(_this.dealListText(data.data));
                        _this.setData({
                            list: meta
                        });
                    }
                    else {
                        _this.setData({
                            list: []
                        });
                    }
                }
                _this.setData({
                    loadingList: false
                });
            }
        });
    },
    dealListText: function (list) {
        var simpleTime = function (ts) {
            var time = new Date(Number(ts));
            return time.getMonth() + 1 + "\u6708" + time.getDate() + "\u65E5";
        };
        var simpleTime2 = function (ts) {
            var time = new Date(Number(ts));
            return time.getMonth() + 1 + "." + time.getDate();
        };
        var meta = list.map(function (x, k) {
            var _id = x._id, title = x.title, sales_volume = x.sales_volume, start_date = x.start_date, published = x.published, end_date = x.end_date, orders = x.orders, isClosed = x.isClosed, clients = x.clients, notPayAllClients = x.notPayAllClients;
            var state$ = !published ?
                '未发布' :
                isClosed ?
                    '已关闭' :
                    new Date().getTime() >= end_date ?
                        '已结束' :
                        new Date().getTime() >= start_date ?
                            '进行中' :
                            '即将开始';
            return {
                _id: _id,
                title: title,
                orders: orders,
                bg: k % 7,
                sales_volume: sales_volume,
                state: state$,
                isClosed: isClosed,
                clients: clients,
                notPayAllClients: notPayAllClients,
                ing: state$ === '进行中',
                endDate: simpleTime(end_date),
                startDate: simpleTime(start_date),
                endDate2: simpleTime2(end_date),
                startDate2: simpleTime2(start_date),
                red: state$ === '未发布' || state$ === '进行中' || state$ === '即将开始',
            };
        });
        return meta;
    },
    onInput: function (_a) {
        var detail = _a.detail;
        this.setData({
            search: detail.value,
            canLoadMore: detail.value.replace(/\s+/g, "") !== this.data.lastSearch
        });
    },
    onTab: function (_a) {
        var currentTarget = _a.currentTarget, detail = _a.detail;
        var tid = currentTarget.dataset.tid;
        if (!tid) {
            return;
        }
        route_js_1.navTo("/pages/manager-trip-detail/index?id=" + tid);
    },
    goOrder: function (_a) {
        var currentTarget = _a.currentTarget, detail = _a.detail;
        var tid = currentTarget.dataset.tid;
        route_js_1.navTo("/pages/manager-trip-order/index?id=" + tid);
    },
    onSubscribe: function () {
        app.getSubscribe('newOrder,trip');
    },
    onLoad: function () {
        wx.hideShareMenu({});
    },
    onReady: function () {
    },
    onShow: function () {
        this.setData({
            page: 0,
            canLoadMore: true
        });
        this.fetchData();
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQU0sR0FBRyxHQUFHLE1BQU0sRUFBUSxDQUFDO0FBQzNCLHdDQUF1QztBQUN2QyxnREFBNEM7QUFFNUMsSUFBSSxDQUFDO0lBTUQsSUFBSSxFQUFFO1FBRUYsSUFBSSxFQUFFLENBQUM7UUFFUCxTQUFTLEVBQUUsQ0FBQztRQUVaLE1BQU0sRUFBRSxFQUFFO1FBRVYsSUFBSSxFQUFFLEVBQUc7UUFFVCxXQUFXLEVBQUUsS0FBSztRQUVsQixXQUFXLEVBQUUsSUFBSTtRQUVqQixVQUFVLEVBQUUsRUFBRTtRQUVkLGtCQUFrQixFQUFFLEtBQUs7UUFFekIsR0FBRyxFQUFFO1lBQ0Qsc0VBQXNFO1lBQ3RFLGtGQUFrRjtZQUNsRixzRUFBc0U7WUFDdEUsc0VBQXNFO1lBQ3RFLHNFQUFzRTtZQUN0RSx1RUFBdUU7WUFDdkUsb0ZBQW9GO1NBQ3ZGO0tBQ0o7SUFHRCxRQUFRLFlBQUUsQ0FBQztRQUNQLGdCQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBR0QsZUFBZSxZQUFDLEVBQVU7WUFBUixrQkFBTTtRQUNwQixJQUFJLENBQUMsT0FBUSxDQUFDO1lBQ1YsSUFBSSxFQUFFLENBQUM7WUFDUCxTQUFTLEVBQUUsQ0FBQztZQUNaLE1BQU0sRUFBRSxNQUFNO1lBQ2QsV0FBVyxFQUFFLElBQUk7U0FDcEIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsRUFBRyxDQUFDO0lBQ3RCLENBQUM7SUFHRCxTQUFTO1FBQVQsaUJBOERDO1FBNURTLElBQUEsY0FBNEQsRUFBMUQsNEJBQVcsRUFBRSw0QkFBVyxFQUFFLDBCQUFVLEVBQUUsa0JBQW9CLENBQUM7UUFFbkUsSUFBSyxXQUFXLElBQUksQ0FBQyxXQUFXLEVBQUc7WUFDL0IsT0FBTztTQUNWO1FBRUQsSUFBSyxNQUFNLENBQUMsT0FBTyxDQUFDLE1B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PiggKTtcbmltcG9ydCB7IGh0dHAgfSBmcm9tICcuLi8uLi91dGlsL2h0dHAnO1xuaW1wb3J0IHsgbmF2VG8gfSBmcm9tICcuLi8uLi91dGlsL3JvdXRlLmpzJztcblxuUGFnZSh7XG5cbiAgICAvKipcbiAgICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICAgKiAhIOWIl+ihqOWxleekuue7tOW6pu+8muWQjeensOOAgemUgOWUrumineOAgeiuouWNleaVsOOAgeeKtuaAgeOAgeW8gOWni+aXtumXtFxuICAgICAqL1xuICAgIGRhdGE6IHtcbiAgICAgICAgLy8g5b2T5YmN6aG156CBXG4gICAgICAgIHBhZ2U6IDAsXG4gICAgICAgIC8vIOaAu+mhteaVsFxuICAgICAgICB0b3RhbFBhZ2U6IDEsXG4gICAgICAgIC8vIOaQnOe0olxuICAgICAgICBzZWFyY2g6ICcnLFxuICAgICAgICAvLyDllYblk4HliJfooahcbiAgICAgICAgbGlzdDogWyBdLFxuICAgICAgICAvLyDliqDovb3liJfooahpbmdcbiAgICAgICAgbG9hZGluZ0xpc3Q6IGZhbHNlLFxuICAgICAgICAvLyDog73lkKbnu6fnu63liqDovb1cbiAgICAgICAgY2FuTG9hZE1vcmU6IHRydWUsXG4gICAgICAgIC8vIOS4iuasoeaQnOe0oueahOaWh+acrFxuICAgICAgICBsYXN0U2VhcmNoOiAnJyxcbiAgICAgICAgLy8g5piv5ZCm5bey57uP5rKh5pyJ5LiL5LiA5Liq5Y+v55So6KGM56iLXG4gICAgICAgIGlzTm90QXZhaWxhYmxlVHJpcDogZmFsc2UsXG4gICAgICAgIC8vIOiDjOaZr+agt+W8j1xuICAgICAgICBiZ3M6IFtcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQoMTIwZGVnLCAjODRmYWIwIDAlLCAjOGZkM2Y0IDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KDQ1ZGVnLCAjZmY5YTllIDAlLCAjZmFkMGM0IDk5JSwgI2ZhZDBjNCAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCgxMjBkZWcsICM4OWY3ZmUgMCUsICM2NmE2ZmYgMTAwJSk7JyxcbiAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodG8gdG9wLCAjMzdlY2JhIDAlLCAjNzJhZmQzIDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KC00NWRlZywgI0ZGQzc5NiAwJSwgI0ZGNkI5NSAxMDAlKTsnLFxuICAgICAgICAgICAgJ2JhY2tncm91bmQtaW1hZ2U6IGxpbmVhci1ncmFkaWVudCgtMjI1ZGVnLCAjMjBFMkQ3IDAlLCAjRjlGRUE1IDEwMCUpOycsXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KC0yMjVkZWcsICM5RUZCRDMgMCUsICM1N0U5RjIgNDglLCAjNDVENEZCIDEwMCUpOycsXG4gICAgICAgIF1cbiAgICB9LFxuXG4gICAgLyoqIOi3s+mhtSAqL1xuICAgIG5hdmlnYXRlKCBlICkge1xuICAgICAgICBuYXZUbygnL3BhZ2VzL21hbmFnZXItdHJpcC1kZXRhaWwvaW5kZXgnKTtcbiAgICB9LFxuXG4gICAgLyoqIOi+k+WFpeahhuehruiupCAqL1xuICAgIG9uQ29uZm9ybVNlYXJjaCh7IGRldGFpbCB9KSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgcGFnZTogMCxcbiAgICAgICAgICAgIHRvdGFsUGFnZTogMCxcbiAgICAgICAgICAgIHNlYXJjaDogZGV0YWlsLFxuICAgICAgICAgICAgY2FuTG9hZE1vcmU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZmV0Y2hEYXRhKCApO1xuICAgIH0sXG5cbiAgICAvKiog5ouJ5Y+W5YiX6KGoICovXG4gICAgZmV0Y2hEYXRhKCApIHtcblxuICAgICAgICBjb25zdCB7IGNhbkxvYWRNb3JlLCBsb2FkaW5nTGlzdCwgbGFzdFNlYXJjaCwgc2VhcmNoIH0gPSB0aGlzLmRhdGE7XG5cbiAgICAgICAgaWYgKCBsb2FkaW5nTGlzdCB8fCAhY2FuTG9hZE1vcmUgKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIHNlYXJjaC5yZXBsYWNlKC9cXHMrL2csIFwiXCIpICE9PSBsYXN0U2VhcmNoICkge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgcGFnZTogMCxcbiAgICAgICAgICAgICAgICB0b3RhbFBhZ2U6IDFcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBsb2FkaW5nTGlzdDogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBodHRwKHtcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBwYWdlOiB0aGlzLmRhdGEucGFnZSArIDEsXG4gICAgICAgICAgICAgICAgdGl0bGU6IHRoaXMuZGF0YS5zZWFyY2hcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJNc2c6ICfliqDovb3lpLHotKXvvIzor7fph43or5UnLFxuICAgICAgICAgICAgbG9hZGluZ01zZzogJ+WKoOi9veS4rS4uLicsXG4gICAgICAgICAgICB1cmw6IGB0cmlwX2xpc3RgLFxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IHN0YXR1cywgZGF0YSB9ID0gcmVzO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICggc3RhdHVzID09PSAyMDAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgcGFnZSwgdG90YWxQYWdlLCBzZWFyY2ggfSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFBhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VhcmNoOiBzZWFyY2ggfHwgJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5Mb2FkTW9yZTogdG90YWxQYWdlID4gcGFnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzTm90QXZhaWxhYmxlVHJpcDogIWRhdGEuZGF0YS5zb21lKCB4ID0+IHgucHVibGlzaGVkID09PSB0cnVlICYmIG5ldyBEYXRlKCApLmdldFRpbWUoICkgPCB4LnN0YXJ0X2RhdGUgKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICggZGF0YS5kYXRhICYmIGRhdGEuZGF0YS5sZW5ndGggPiAwICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWV0YSA9IHBhZ2UgPT09IDEgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlYWxMaXN0VGV4dCggZGF0YS5kYXRhICk6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgWyAuLi50aGlzLmRhdGEubGlzdCwgLi4udGhpcy5kZWFsTGlzdFRleHQoIGRhdGEuZGF0YSApXTtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0OiBtZXRhXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3Q6IFsgXVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRpbmdMaXN0OiBmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOe8lui+keihjOeoi+WIl+ihqOaWh+WtlyAqL1xuICAgIGRlYWxMaXN0VGV4dCggbGlzdCApIHtcblxuICAgICAgICBjb25zdCBzaW1wbGVUaW1lID0gKHRzOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBuZXcgRGF0ZSggTnVtYmVyKCB0cyApKTtcbiAgICAgICAgICAgIHJldHVybiBgJHt0aW1lLmdldE1vbnRoKCApKzF95pyIJHt0aW1lLmdldERhdGUoICl95pelYFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHNpbXBsZVRpbWUyID0gKHRzOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRpbWUgPSBuZXcgRGF0ZSggTnVtYmVyKCB0cyApKTtcbiAgICAgICAgICAgIHJldHVybiBgJHt0aW1lLmdldE1vbnRoKCApKzF9LiR7dGltZS5nZXREYXRlKCApfWBcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogISDms6jmhI/vvIzml7bpl7Tlr7nmr5TjgILlvIDlp4vml7bpl7TmmK8g5oyH5a6a5pel5pyf55qE5pep5LiKOOeCue+8m+e7k+adn+aXpeacn+aYryDmjIflrprml6XmnJ/nmoTmmZrkuIoyNDowMFxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgbWV0YSA9IGxpc3QubWFwKCggeCwgayApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgX2lkLCB0aXRsZSwgc2FsZXNfdm9sdW1lLCBzdGFydF9kYXRlLCBwdWJsaXNoZWQsIGVuZF9kYXRlLCBvcmRlcnMsIGlzQ2xvc2VkLCBjbGllbnRzLCBub3RQYXlBbGxDbGllbnRzIH0gPSB4O1xuXG4gICAgICAgICAgICBjb25zdCBzdGF0ZSQgPSAhcHVibGlzaGVkID9cbiAgICAgICAgICAgICAgICAn5pyq5Y+R5biDJyA6XG4gICAgICAgICAgICAgICAgaXNDbG9zZWQgP1xuICAgICAgICAgICAgICAgICAgICAn5bey5YWz6ZetJyA6XG4gICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKCApLmdldFRpbWUoICkgPj0gZW5kX2RhdGUgP1xuICAgICAgICAgICAgICAgICAgICAgICAgJ+W3sue7k+adnycgOlxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUoICkuZ2V0VGltZSggKSA+PSBzdGFydF9kYXRlID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAn6L+b6KGM5LitJyA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ+WNs+WwhuW8gOWniyc7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgX2lkLFxuICAgICAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgICAgIG9yZGVycyxcbiAgICAgICAgICAgICAgICBiZzogayAlIDcsXG4gICAgICAgICAgICAgICAgc2FsZXNfdm9sdW1lLFxuICAgICAgICAgICAgICAgIHN0YXRlOiBzdGF0ZSQsXG4gICAgICAgICAgICAgICAgaXNDbG9zZWQsXG4gICAgICAgICAgICAgICAgY2xpZW50cyxcbiAgICAgICAgICAgICAgICBub3RQYXlBbGxDbGllbnRzLFxuICAgICAgICAgICAgICAgIGluZzogc3RhdGUkID09PSAn6L+b6KGM5LitJyxcbiAgICAgICAgICAgICAgICBlbmREYXRlOiBzaW1wbGVUaW1lKCBlbmRfZGF0ZSApLFxuICAgICAgICAgICAgICAgIHN0YXJ0RGF0ZTogc2ltcGxlVGltZSggc3RhcnRfZGF0ZSApLFxuICAgICAgICAgICAgICAgIGVuZERhdGUyOiBzaW1wbGVUaW1lMiggZW5kX2RhdGUgKSxcbiAgICAgICAgICAgICAgICBzdGFydERhdGUyOiBzaW1wbGVUaW1lMiggc3RhcnRfZGF0ZSApLFxuICAgICAgICAgICAgICAgIHJlZDogc3RhdGUkID09PSAn5pyq5Y+R5biDJyB8fCBzdGF0ZSQgPT09ICfov5vooYzkuK0nIHx8IHN0YXRlJCA9PT0gJ+WNs+WwhuW8gOWniycsXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbWV0YTtcbiAgICB9LFxuXG4gICAgLyoqIOaQnOe0oui+k+WFpSAqL1xuICAgIG9uSW5wdXQoeyBkZXRhaWwgfSkge1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIHNlYXJjaDogZGV0YWlsLnZhbHVlLFxuICAgICAgICAgICAgY2FuTG9hZE1vcmU6IGRldGFpbC52YWx1ZS5yZXBsYWNlKC9cXHMrL2csIFwiXCIpICE9PSB0aGlzLmRhdGEubGFzdFNlYXJjaFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOeCueWHu+ivpuaDhSAqL1xuICAgIG9uVGFiKHsgY3VycmVudFRhcmdldCwgZGV0YWlsIH0pIHtcbiAgICAgICAgY29uc3QgeyB0aWQgfSA9IGN1cnJlbnRUYXJnZXQuZGF0YXNldDtcbiAgICAgICAgaWYgKCAhdGlkICkgeyByZXR1cm47IH1cbiAgICAgICAgbmF2VG8oYC9wYWdlcy9tYW5hZ2VyLXRyaXAtZGV0YWlsL2luZGV4P2lkPSR7dGlkfWApO1xuICAgIH0sXG5cbiAgICAvKiog6Lez5Yqo6K+m5oOF55qE6K6i5Y2VICovXG4gICAgZ29PcmRlcih7IGN1cnJlbnRUYXJnZXQsIGRldGFpbCB9KSB7XG4gICAgICAgIGNvbnN0IHsgdGlkIH0gPSBjdXJyZW50VGFyZ2V0LmRhdGFzZXQ7XG4gICAgICAgIG5hdlRvKGAvcGFnZXMvbWFuYWdlci10cmlwLW9yZGVyL2luZGV4P2lkPSR7dGlkfWApO1xuICAgIH0sXG5cbiAgICBvblN1YnNjcmliZSggKSB7XG4gICAgICAgIGFwcC5nZXRTdWJzY3JpYmUoJ25ld09yZGVyLHRyaXAnKTtcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWKoOi9vVxuICAgICAqL1xuICAgIG9uTG9hZDogZnVuY3Rpb24gKCApIHtcbiAgICAgICAgd3guaGlkZVNoYXJlTWVudSh7IH0pO1xuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yid5qyh5riy5p+T5a6M5oiQXG4gICAgICovXG4gICAgb25SZWFkeTogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLmmL7npLpcbiAgICAgKi9cbiAgICBvblNob3c6IGZ1bmN0aW9uICggKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgICAgcGFnZTogMCxcbiAgICAgICAgICAgIGNhbkxvYWRNb3JlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmZldGNoRGF0YSggKTtcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdoumakOiXj1xuICAgICAqL1xuICAgIG9uSGlkZTogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cbiAgICAgKi9cbiAgICBvblVubG9hZDogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICAgKi9cbiAgICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog6aG16Z2i5LiK5ouJ6Kem5bqV5LqL5Lu255qE5aSE55CG5Ye95pWwXG4gICAgICovXG4gICAgb25SZWFjaEJvdHRvbTogZnVuY3Rpb24gKCApIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55So5oi354K55Ye75Y+z5LiK6KeS5YiG5LqrXG4gICAgICovXG4gICAgLy8gb25TaGFyZUFwcE1lc3NhZ2U6IGZ1bmN0aW9uICgpIHtcbiAgXG4gICAgLy8gfVxufSkiXX0=