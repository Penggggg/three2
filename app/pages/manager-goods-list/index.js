"use strict";
Page({
    data: {
        page: 0,
        totalPage: 1,
        search: '',
        list: [],
        stockNeed: [],
        loadingList: false,
        canLoadMore: true,
        lastSearch: ''
    },
    navigate: function (e) {
        wx.navigateTo({
            url: e.currentTarget.dataset.url || '/pages/manager-goods-detail/index',
        });
    },
    fetchData: function () {
        var that = this;
        var _a = this.data, canLoadMore = _a.canLoadMore, loadingList = _a.loadingList, lastSearch = _a.lastSearch, search = _a.search;
        if (loadingList || !canLoadMore) {
            return;
        }
        if (search.replace(/\s+/g, "") !== lastSearch) {
            this.setData({
                page: 0,
                totalPage: 1
            });
        }
        this.setData({
            loadingList: true
        });
        wx.showLoading({
            title: '加载中...',
        });
        wx.cloud.callFunction({
            name: 'api-goods-list',
            data: {
                page: this.data.page + 1,
                title: this.data.search
            },
            success: function (res) {
                var _a = res.result, status = _a.status, data = _a.data;
                if (status === 200) {
                    var page = data.page, totalPage = data.totalPage, search_1 = data.search;
                    that.setData({
                        page: page,
                        totalPage: totalPage,
                        lastSearch: search_1 || '',
                        canLoadMore: totalPage > page
                    });
                    if (data.data && data.data.length > 0) {
                        var meta = page === 1 ?
                            that.dealListText(data.data) : that.data.list.concat(that.dealListText(data.data));
                        that.setData({
                            list: meta
                        });
                    }
                    else {
                        that.setData({
                            list: []
                        });
                    }
                }
                wx.hideLoading({});
                that.setData({
                    loadingList: false
                });
            },
            fail: function () {
                wx.showToast({
                    icon: 'none',
                    title: '获取数据错误',
                });
                wx.hideLoading({});
                that.setData({
                    loadingList: false
                });
            }
        });
    },
    onInput: function (_a) {
        var detail = _a.detail;
        this.setData({
            search: detail.value,
            canLoadMore: detail.value.replace(/\s+/g, "") !== this.data.lastSearch
        });
    },
    dealListText: function (list) {
        var that = this;
        return list.map(function (x) {
            var stock = x.stock;
            var price = x.price;
            var origin = that.data.stockNeed.slice();
            if (x.standards.length === 0) {
                stock = x.stock;
                price = x.price;
                origin.push(stock !== undefined && stock < 10);
            }
            else if (x.standards.length === 1) {
                stock = x.standards[0].stock;
                price = x.standards[0].price;
                origin.push(stock !== undefined && stock < 10);
            }
            else if (x.standards.length > 1) {
                var sortedPrice = x.standards.sort(function (x, y) { return x.price - y.price; });
                if (sortedPrice[0].price === sortedPrice[sortedPrice.length - 1].price) {
                    price = sortedPrice[0].price;
                }
                else {
                    price = sortedPrice[0].price + "~" + sortedPrice[sortedPrice.length - 1].price;
                }
                var sortedStock = x.standards.filter(function (i) { return i.stock !== undefined && i.stock !== null; }).sort(function (x, y) { return x.stock - y.stock; });
                if (sortedStock.length === 1) {
                    stock = "" + sortedStock[0].stock;
                }
                else if (sortedStock.length > 1) {
                    if (sortedStock[0].stock === sortedStock[sortedStock.length - 1].stock) {
                        stock = "" + sortedStock[0].stock;
                    }
                    else {
                        stock = sortedStock[0].stock + "~" + sortedStock[sortedStock.length - 1].stock;
                    }
                }
                origin.push(((stock !== undefined) && (Number(String(stock).split('~')[0]) < 10)));
            }
            that.setData({
                stockNeed: origin
            });
            return Object.assign({}, x, {
                stock: stock,
                price: price
            });
        });
    },
    onTab: function (_a) {
        var currentTarget = _a.currentTarget;
        var pid = currentTarget.dataset.pid;
        wx.navigateTo({
            url: "/pages/goods-detail/index?id=" + pid
        });
    },
    onLoad: function (options) {
    },
    onReady: function () {
    },
    onShow: function () {
        this.fetchData();
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsSUFBSSxDQUFDO0lBS0QsSUFBSSxFQUFFO1FBRUYsSUFBSSxFQUFFLENBQUM7UUFFUCxTQUFTLEVBQUUsQ0FBQztRQUVaLE1BQU0sRUFBRSxFQUFFO1FBRVYsSUFBSSxFQUFFLEVBQUc7UUFFVCxTQUFTLEVBQUUsRUFBRztRQUVkLFdBQVcsRUFBRSxLQUFLO1FBRWxCLFdBQVcsRUFBRSxJQUFJO1FBRWpCLFVBQVUsRUFBRSxFQUFFO0tBQ2pCO0lBR0QsUUFBUSxZQUFFLENBQUM7UUFDUCxFQUFFLENBQUMsVUFBVSxDQUFDO1lBQ1YsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxtQ0FBbUM7U0FDMUUsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUdELFNBQVM7UUFDTCxJQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFDWixJQUFBLGNBQTRELEVBQTFELDRCQUFXLEVBQUUsNEJBQVcsRUFBRSwwQkFBVSxFQUFFLGtCQUFvQixDQUFDO1FBRW5FLElBQUssV0FBVyxJQUFJLENBQUMsV0FBVyxFQUFHO1lBQy9CLE9BQU87U0FDVjtRQUVELElBQUssTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEtBQUssVUFBVSxFQUFHO1lBQzdDLElBQUksQ0FBQyxPQUFRLENBQUM7Z0JBQ1YsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsU0FBUyxFQUFFLENBQUM7YUFDZixDQUFDLENBQUM7U0FDTjtRQUVELElBQUksQ0FBQyxPQUFRLENBQUM7WUFDVixXQUFXLEVBQUUsSUFBSTtTQUNwQixDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsV0FBVyxDQUFDO1lBQ1gsS0FBSyxFQUFFLFFBQVE7U0FDbEIsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7WUFDbEIs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QUdELEtBQUssWUFBQyxFQUFpQjtZQUFmLGdDQUFhO1FBQ1QsSUFBQSwrQkFBRyxDQUEyQjtRQUN0QyxFQUFFLENBQUMsVUFBVSxDQUFDO1lBQ1YsR0FBRyxFQUFFLGtDQUFnQyxHQUFLO1NBRTdDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFLRCxNQUFNLEVBQUUsVUFBVSxPQUFPO0lBRXpCLENBQUM7SUFLRCxPQUFPLEVBQUU7SUFFVCxDQUFDO0lBS0QsTUFBTSxFQUFFO1FBQ04sSUFBSSxDQUFDLFNBQVMsRUFBRyxDQUFDO0lBQ3BCLENBQUM7SUFLRCxNQUFNLEVBQUU7SUFFUixDQUFDO0lBS0QsUUFBUSxFQUFFO0lBRVYsQ0FBQztJQUtELGlCQUFpQixFQUFFO0lBRW5CLENBQUM7SUFLRCxhQUFhLEVBQUU7SUFFZixDQUFDO0NBUUYsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gYXBwL3BhZ2VzL21hbmFnZXItZ29vZHMtbGlzdC9pbmRleC5qc1xuUGFnZSh7XG5cbiAgICAvKipcbiAgICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICAgKi9cbiAgICBkYXRhOiB7XG4gICAgICAgIC8vIOW9k+WJjemhteeggVxuICAgICAgICBwYWdlOiAwLFxuICAgICAgICAvLyDmgLvpobXmlbBcbiAgICAgICAgdG90YWxQYWdlOiAxLFxuICAgICAgICAvLyDmkJzntKJcbiAgICAgICAgc2VhcmNoOiAnJyxcbiAgICAgICAgLy8g5ZWG5ZOB5YiX6KGoXG4gICAgICAgIGxpc3Q6IFsgXSxcbiAgICAgICAgLy8g5bqT5a2Y57Sn5oCl5YiX6KGoXG4gICAgICAgIHN0b2NrTmVlZDogWyBdLFxuICAgICAgICAvLyDliqDovb3liJfooahpbmdcbiAgICAgICAgbG9hZGluZ0xpc3Q6IGZhbHNlLFxuICAgICAgICAvLyDog73lkKbnu6fnu63liqDovb1cbiAgICAgICAgY2FuTG9hZE1vcmU6IHRydWUsXG4gICAgICAgIC8vIOS4iuasoeaQnOe0oueahOaWh+acrFxuICAgICAgICBsYXN0U2VhcmNoOiAnJ1xuICAgIH0sXG4gIFxuICAgIC8qKiDot7PpobUgKi9cbiAgICBuYXZpZ2F0ZSggZSApIHtcbiAgICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgICAgICB1cmw6IGUuY3VycmVudFRhcmdldC5kYXRhc2V0LnVybCB8fCAnL3BhZ2VzL21hbmFnZXItZ29vZHMtZGV0YWlsL2luZGV4JyxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgXG4gICAgLyoqIOaLieWPluWIl+ihqCAqL1xuICAgIGZldGNoRGF0YSggKSB7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgICBjb25zdCB7IGNhbkxvYWRNb3JlLCBsb2FkaW5nTGlzdCwgbGFzdFNlYXJjaCwgc2VhcmNoIH0gPSB0aGlzLmRhdGE7XG5cbiAgICAgICAgaWYgKCBsb2FkaW5nTGlzdCB8fCAhY2FuTG9hZE1vcmUgKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIHNlYXJjaC5yZXBsYWNlKC9cXHMrL2csIFwiXCIpICE9PSBsYXN0U2VhcmNoICkge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgcGFnZTogMCxcbiAgICAgICAgICAgICAgICB0b3RhbFBhZ2U6IDFcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICBsb2FkaW5nTGlzdDogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICB3eC5zaG93TG9hZGluZyh7XG4gICAgICAgICAgICB0aXRsZTogJ+WKoOi9veS4rS4uLicsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHd4LmNsb3VkLmNhbGxGdW5jdGlvbih7XG4gICAgICAgICAgICBuYW1lOiAnYXBpLWdvb2RzLWxpc3QnLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIHBhZ2U6IHRoaXMuZGF0YS5wYWdlICsgMSxcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5kYXRhLnNlYXJjaFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICggcmVzOiBhbnkgKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBzdGF0dXMsIGRhdGEgfSA9IHJlcy5yZXN1bHQ7XG4gICAgICAgICAgICAgICAgaWYgKCBzdGF0dXMgPT09IDIwMCApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBwYWdlLCB0b3RhbFBhZ2UsIHNlYXJjaCB9ID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxQYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlYXJjaDogc2VhcmNoIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuTG9hZE1vcmU6IHRvdGFsUGFnZSA+IHBhZ2VcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIGRhdGEuZGF0YSAmJiBkYXRhLmRhdGEubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1ldGEgPSBwYWdlID09PSAxID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmRlYWxMaXN0VGV4dCggZGF0YS5kYXRhICkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsgLi4udGhhdC5kYXRhLmxpc3QsIC4uLnRoYXQuZGVhbExpc3RUZXh0KCBkYXRhLmRhdGEgKV07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3Q6IG1ldGFcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdDogWyBdXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKHsgfSk7XG4gICAgICAgICAgICAgICAgdGhhdC5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRpbmdMaXN0OiBmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZhaWw6IGZ1bmN0aW9uKCApIHtcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgICBpY29uOiAnbm9uZScsXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAn6I635Y+W5pWw5o2u6ZSZ6K+vJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB3eC5oaWRlTG9hZGluZyh7IH0pO1xuICAgICAgICAgICAgICAgIHRoYXQuc2V0RGF0YSEoe1xuICAgICAgICAgICAgICAgICAgICBsb2FkaW5nTGlzdDogZmFsc2VcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgXG4gICAgLyoqIOaQnOe0oui+k+WFpSAqL1xuICAgIG9uSW5wdXQoeyBkZXRhaWwgfSkge1xuICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIHNlYXJjaDogZGV0YWlsLnZhbHVlLFxuICAgICAgICAgICAgY2FuTG9hZE1vcmU6IGRldGFpbC52YWx1ZS5yZXBsYWNlKC9cXHMrL2csIFwiXCIpICE9PSB0aGlzLmRhdGEubGFzdFNlYXJjaFxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqIOWkhOeQhuaVsOaNruWIsOWIl+ihqOeahOaWh+Wtl+aYvuekuiAqL1xuICAgIGRlYWxMaXN0VGV4dCggbGlzdCApIHtcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG5cbiAgICAgICAgcmV0dXJuIGxpc3QubWFwKCB4ID0+IHtcbiAgICAgICAgIFxuICAgICAgICAgICAgLy8g6K6+572u5Z6L5Y+344CB5bqT5a2Y55qE5Lu35qC8XG4gICAgICAgICAgICBsZXQgc3RvY2sgPSB4LnN0b2NrO1xuICAgICAgICAgICAgbGV0IHByaWNlID0geC5wcmljZTtcblxuICAgICAgICAgICAgLy8g5piv5ZCm6ZyA6KaB5pi+56S657qi6Imy5a2X5L2T55qE6LSn5a2YXG4gICAgICAgICAgICBjb25zdCBvcmlnaW46IGFueSA9IFsgLi4udGhhdC5kYXRhLnN0b2NrTmVlZCBdO1xuXG4gICAgICAgICAgICAvLyDmsqHmnInlnovlj7dcbiAgICAgICAgICAgIGlmICggeC5zdGFuZGFyZHMubGVuZ3RoID09PSAwICkge1xuICAgICAgICAgICAgICAgIHN0b2NrID0geC5zdG9jaztcbiAgICAgICAgICAgICAgICBwcmljZSA9IHgucHJpY2U7XG4gICAgICAgICAgICAgICAgb3JpZ2luLnB1c2goIHN0b2NrICE9PSB1bmRlZmluZWQgJiYgc3RvY2sgPCAxMCApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIGlmICggeC5zdGFuZGFyZHMubGVuZ3RoID09PSAxICkge1xuICAgICAgICAgICAgICAgIHN0b2NrID0geC5zdGFuZGFyZHNbMF0uc3RvY2s7XG4gICAgICAgICAgICAgICAgcHJpY2UgPSB4LnN0YW5kYXJkc1sgMCBdLnByaWNlO1xuICAgICAgICAgICAgICAgIG9yaWdpbi5wdXNoKCBzdG9jayAhPT0gdW5kZWZpbmVkICYmIHN0b2NrIDwgMTAgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8g5Z6L5Y+35aSn5LqOMeenjVxuICAgICAgICAgICAgfSBlbHNlIGlmICggeC5zdGFuZGFyZHMubGVuZ3RoID4gMSApIHtcblxuICAgICAgICAgICAgICAgIC8vIOWkhOeQhuS7t+agvFxuICAgICAgICAgICAgICAgIGNvbnN0IHNvcnRlZFByaWNlID0geC5zdGFuZGFyZHMuc29ydCgoIHgsIHkgKSA9PiB4LnByaWNlIC0geS5wcmljZSApO1xuICAgICAgICAgICAgICAgIGlmICggc29ydGVkUHJpY2VbMF0ucHJpY2UgPT09IHNvcnRlZFByaWNlW3NvcnRlZFByaWNlLmxlbmd0aCAtIDEgXS5wcmljZSApIHtcbiAgICAgICAgICAgICAgICAgICAgcHJpY2UgPSBzb3J0ZWRQcmljZVswXS5wcmljZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwcmljZSA9IGAke3NvcnRlZFByaWNlWzBdLnByaWNlfX4ke3NvcnRlZFByaWNlW3NvcnRlZFByaWNlLmxlbmd0aCAtIDEgXS5wcmljZX1gO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyDlpITnkIbotKflrZhcbiAgICAgICAgICAgICAgICBjb25zdCBzb3J0ZWRTdG9jayA9IHguc3RhbmRhcmRzLmZpbHRlcihpID0+IGkuc3RvY2sgIT09IHVuZGVmaW5lZCAmJiBpLnN0b2NrICE9PSBudWxsKS5zb3J0KCh4LCB5KSA9PiB4LnN0b2NrIC0geS5zdG9jayk7XG4gICAgICAgICAgICAgICAgLy8g5pyJ5bqT5a2Y5Z6L5Y+3XG4gICAgICAgICAgICAgICAgaWYgKCBzb3J0ZWRTdG9jay5sZW5ndGggPT09IDEgKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0b2NrID0gYCR7c29ydGVkU3RvY2tbMF0uc3RvY2t9YDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBzb3J0ZWRTdG9jay5sZW5ndGggPiAxICkge1xuICAgICAgICAgICAgICAgICAgaWYgKCBzb3J0ZWRTdG9ja1swXS5zdG9jayA9PT0gc29ydGVkU3RvY2tbc29ydGVkU3RvY2subGVuZ3RoIC0gMV0uc3RvY2sgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgc3RvY2sgPSBgJHtzb3J0ZWRTdG9ja1swXS5zdG9ja31gO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICBzdG9jayA9IGAke3NvcnRlZFN0b2NrWzBdLnN0b2NrfX4ke3NvcnRlZFN0b2NrW3NvcnRlZFN0b2NrLmxlbmd0aCAtIDFdLnN0b2NrfWA7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgb3JpZ2luLnB1c2goKChzdG9jayAhPT0gdW5kZWZpbmVkKSAmJiAoTnVtYmVyKFN0cmluZyhzdG9jaykuc3BsaXQoJ34nKVswXSkgPCAxMCkpKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgICAgdGhhdC5zZXREYXRhISh7XG4gICAgICAgICAgICAgICAgc3RvY2tOZWVkOiBvcmlnaW5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7IH0sIHgsIHtcbiAgICAgICAgICAgICAgICBzdG9jayxcbiAgICAgICAgICAgICAgICBwcmljZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKiDngrnlh7vor6bmg4UgKi9cbiAgICBvblRhYih7IGN1cnJlbnRUYXJnZXQgfSkge1xuICAgICAgICBjb25zdCB7IHBpZCB9ID0gY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICAgIHVybDogYC9wYWdlcy9nb29kcy1kZXRhaWwvaW5kZXg/aWQ9JHtwaWR9YFxuICAgICAgICAgICAgLy8gdXJsOiBgL3BhZ2VzL21hbmFnZXItZ29vZHMtZGV0YWlsL2luZGV4P2lkPSR7cGlkfWBcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICAgKi9cbiAgICBvbkxvYWQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWIneasoea4suafk+WujOaIkFxuICAgICAqL1xuICAgIG9uUmVhZHk6IGZ1bmN0aW9uICgpIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLmmL7npLpcbiAgICAgKi9cbiAgICBvblNob3c6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMuZmV0Y2hEYXRhKCApO1xuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i6ZqQ6JePXG4gICAgICovXG4gICAgb25IaWRlOiBmdW5jdGlvbiAoKSB7XG4gIFxuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XG4gICAgICovXG4gICAgb25VbmxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgXG4gICAgfSxcbiAgXG4gICAgLyoqXG4gICAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICAgKi9cbiAgICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCkge1xuICBcbiAgICB9LFxuICBcbiAgICAvKipcbiAgICAgKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcbiAgICAgKi9cbiAgICBvblJlYWNoQm90dG9tOiBmdW5jdGlvbiAoKSB7XG4gIFxuICAgIH0sXG4gIFxuICAgIC8qKlxuICAgICAqIOeUqOaIt+eCueWHu+WPs+S4iuinkuWIhuS6q1xuICAgICAqL1xuICAgIC8vIG9uU2hhcmVBcHBNZXNzYWdlOiBmdW5jdGlvbiAoKSB7XG4gIFxuICAgIC8vIH1cbiAgfSkiXX0=