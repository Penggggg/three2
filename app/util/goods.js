"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var pushIntegralRate = 0.05;
var delayeringGood = function (x, pushIntegralRate) {
    if (pushIntegralRate === void 0) { pushIntegralRate = 0; }
    if (!x || Object.keys(x).length === 0) {
        return {};
    }
    var lowest_pin_origin_price$ = x.price;
    var allPriceArr = [];
    var allStockArr = [];
    var decorateItem = function (good) {
        allPriceArr.push(good.price);
        if (good.stock) {
            allStockArr.push(good.stock);
        }
        if (good.groupPrice) {
            allPriceArr.push(good.groupPrice);
        }
    };
    var decorateItem2 = function (activities) {
        if (Array.isArray(activities)) {
            activities.map(function (ac) {
                allPriceArr.push(ac.ac_price);
                if (ac.ac_groupPrice) {
                    allPriceArr.push(ac.ac_groupPrice);
                }
            });
        }
    };
    decorateItem2(x.activities);
    if (!x.standards || x.standards.length === 0) {
        decorateItem(x);
        lowest_pin_origin_price$ = x.price;
    }
    else {
        x.standards.map(decorateItem);
        var standardSet_1 = null;
        var lowest_standard_price_1 = 0;
        x.standards.map(function (x) {
            if (x.groupPrice < lowest_standard_price_1 || lowest_standard_price_1 === 0) {
                standardSet_1 = x;
                lowest_standard_price_1 = x.groupPrice;
            }
        });
        if (!!standardSet_1) {
            lowest_pin_origin_price$ = standardSet_1.price;
        }
    }
    allPriceArr = allPriceArr.sort(function (x, y) { return x - y; });
    allStockArr = allStockArr.sort(function (x, y) { return x - y; });
    return Object.assign({}, x, {
        pid: x._id,
        hasPin: hasPin(x),
        stock$: allStockArr.length === 0 ?
            allStockArr[0] :
            allStockArr[0] === allStockArr[allStockArr.length - 1] ?
                allStockArr[0] :
                allStockArr[0] + " ~ " + allStockArr[allStockArr.length - 1],
        price$: allPriceArr.length === 0 ?
            allPriceArr[0] :
            allPriceArr[0] === allPriceArr[allPriceArr.length - 1] ?
                allPriceArr[0] :
                allPriceArr[0] + " ~ " + allPriceArr[allPriceArr.length - 1],
        integral$: allPriceArr.length === 0 ?
            (allPriceArr[0] * pushIntegralRate).toFixed(1) :
            allPriceArr[0] === allPriceArr[allPriceArr.length - 1] ?
                (allPriceArr[0] * pushIntegralRate).toFixed(1) :
                (allPriceArr[0] * pushIntegralRate).toFixed(1) + " ~ " + (allPriceArr[allPriceArr.length - 1] * pushIntegralRate).toFixed(1),
        integral2$: (allPriceArr[allPriceArr.length - 1] * pushIntegralRate).toFixed(1),
        priceGap: allPriceArr.length === 0 ?
            0 :
            "" + (allPriceArr[allPriceArr.length - 1] - allPriceArr[0]),
        lowest_price$: allPriceArr[0],
        lowest_pin_origin_price$: lowest_pin_origin_price$,
        hasActivity: !!x.activity || (Array.isArray(x.activities) && x.activities.length > 0),
        goodPins: dealGoodPin(x),
        tagText: x.tag.join('„ÄÅ'),
        outStock: allStockArr.some(function (x) { return x < 10; })
    });
};
exports.delayeringGood = delayeringGood;
var hasPin = function (good) {
    var activities = good.activities, standards = good.standards, groupPrice = good.groupPrice;
    var piningStandards = standards.filter(function (x) { return !!x.groupPrice; });
    var piningActivies = !!activities ? activities.filter(function (x) { return !!x.ac_groupPrice; }) : [];
    return !!groupPrice || piningStandards.length > 0 || piningActivies.length > 0;
};
var dealGoodPin = function (good) {
    var activities = good.activities, standards = good.standards, price = good.price, groupPrice = good.groupPrice;
    if (!standards || standards.length === 0) {
        var acTarget = !activities ?
            null :
            activities.find(function (ac) { return ac.pid === good.pid; });
        var p = acTarget ? acTarget.ac_price : price;
        var gp = acTarget ? acTarget.ac_groupPrice : groupPrice;
        return {
            list: [{
                    price: p,
                    groupPrice: gp
                }],
            eachPriceRound: gp ? (p - gp).toFixed(2) : 0
        };
    }
    else {
        var meta = standards.map(function (standard) {
            var acTarget = !activities ?
                null :
                activities.find(function (ac) { return ac.pid === standard.pid && ac.sid === standard._id; });
            if ((!!acTarget && !!acTarget.ac_groupPrice) || standard.groupPrice) {
                if (acTarget) {
                    return {
                        price: acTarget.ac_price,
                        groupPrice: acTarget.ac_groupPrice
                    };
                }
                else {
                    return {
                        price: standard.price,
                        groupPrice: standard.groupPrice
                    };
                }
            }
            return null;
        }).filter(function (x) { return !!x; });
        var deltas = meta.map(function (x) {
            return (x.price - (x.groupPrice || 0)).toFixed(2);
        }).sort(function (x, y) { return y - x; });
        return {
            list: meta,
            eachPriceRound: deltas[deltas.length - 1] !== deltas[0] ?
                deltas[deltas.length - 1] + " ~ " + deltas[0] :
                deltas[0]
        };
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnb29kcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBTzlCLElBQU0sY0FBYyxHQUFHLFVBQUUsQ0FBQyxFQUFFLGdCQUFvQjtJQUFwQixpQ0FBQSxFQUFBLG9CQUFvQjtJQUU1QyxJQUFLLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUUsQ0FBQyxDQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRztRQUN2QyxPQUFPLEVBQUcsQ0FBQztLQUNkO0lBR0QsSUFBSSx3QkFBd0IsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBR3ZDLElBQUksV0FBVyxHQUFXLEVBQUcsQ0FBQztJQUc5QixJQUFJLFdBQVcsR0FBWSxFQUFHLENBQUM7SUFHL0IsSUFBTSxZQUFZLEdBQUcsVUFBQSxJQUFJO1FBRXJCLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDO1FBRS9CLElBQUssSUFBSSxDQUFDLEtBQUssRUFBRztZQUNkLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDO1NBQ2xDO1FBRUQsSUFBSyxJQUFJLENBQUMsVUFBVSxFQUFHO1lBQ25CLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxDQUFDO1NBQ3ZDO0lBRUwsQ0FBQyxDQUFDO0lBR0YsSUFBTSxhQUFhLEdBQUcsVUFBQSxVQUFVO1FBQzVCLElBQUssS0FBSyxDQUFDLE9BQU8sQ0FBRSxVQUFVLENBQUUsRUFBRTtZQUM5QixVQUFVLENBQUMsR0FBRyxDQUFFLFVBQUEsRUFBRTtnQkFDZCxXQUFXLENBQUMsSUFBSSxDQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUUsQ0FBQztnQkFFaEMsSUFBSyxFQUFFLENBQUMsYUFBYSxFQUFHO29CQUNwQixXQUFXLENBQUMsSUFBSSxDQUFFLEVB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LENBQUM7WUFDdEIsT0FBQSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBRSxDQUFDLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBRSxDQUFDLENBQUMsT0FBTyxDQUFFLENBQUMsQ0FBRTtRQUE5QyxDQUE4QyxDQUNqRCxDQUFDLElBQUksQ0FBQyxVQUFFLENBQUMsRUFBRSxDQUFDLElBQU0sT0FBQSxDQUFDLEdBQUcsQ0FBQyxFQUFMLENBQUssQ0FBRSxDQUFDO1FBRTNCLE9BQU87WUFDSCxJQUFJLEVBQUUsSUFBSTtZQUVWLGNBQWMsRUFBRyxNQUFNLENBQUUsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUUsS0FBSyxNQUFNLENBQUUsQ0FBQyxDQUFFLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxDQUFFLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFFLFdBQU0sTUFBTSxDQUFFLENBQUMsQ0FBSSxDQUFDLENBQUM7Z0JBQ25ELE1BQU0sQ0FBRSxDQUFDLENBQUU7U0FDbkIsQ0FBQztLQUNMO0FBQ0wsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXG4vKiog56ev5YiG5o6o5bm/5q+U5L6LICovXG5jb25zdCBwdXNoSW50ZWdyYWxSYXRlID0gMC4wNTtcblxuLyoqIFxuICog5ZWG5ZOBIO+9niDku7fmoLzljLrpl7TjgIHlupPlrZjljLrpl7TjgIHlt67ku7fjgIHmnIDkvY7ku7fmoLzvvIjlkKvlm6LotK3ku7cv5LiA5Y+j5Lu377yJXG4gKiBAcGFyYW0geCDllYblk4Hor6bmg4VcbiAqIEBwYXJhbSBwdXNoSW50ZWdyYWxSYXRlIOenr+WIhuaOqOW5v+iOt+eCueavlOS+i1xuICovXG5jb25zdCBkZWxheWVyaW5nR29vZCA9ICggeCwgcHVzaEludGVncmFsUmF0ZSA9IDAgKSA9PiB7XG4gXG4gICAgaWYgKCAheCB8fCBPYmplY3Qua2V5cyggeCApLmxlbmd0aCA9PT0gMCApIHtcbiAgICAgICAgcmV0dXJuIHsgfTtcbiAgICB9XG5cbiAgICAvLyDmnIDkvY7mi7zlm6Lku7fvvIzlr7nlupTnmoTljp/ku7dcbiAgICBsZXQgbG93ZXN0X3Bpbl9vcmlnaW5fcHJpY2UkID0geC5wcmljZTtcblxuICAgIC8vIOWIneWni+WMlu+8muS7t+agvOaVsOe7hO+8iOWQq+Wboui0reS7t+OAgeeJueS7t++8iVxuICAgIGxldCBhbGxQcmljZUFycjogYW55WyBdID0gWyBdO1xuXG4gICAgLy8g5Yid5aeL5YyW77ya5bqT5a2Y5YiX6KGoXG4gICAgbGV0IGFsbFN0b2NrQXJyOiBhbnlbIF0gID0gWyBdO1xuXG4gICAgLy8g5peg5p2h5Lu25rOo5YWlIOS4u+S6p+WTgS/lnovlj7fku7fmoLzjgIHlm6LotK3ku7dcbiAgICBjb25zdCBkZWNvcmF0ZUl0ZW0gPSBnb29kID0+IHtcblxuICAgICAgICBhbGxQcmljZUFyci5wdXNoKCBnb29kLnByaWNlICk7XG4gICAgICAgIFxuICAgICAgICBpZiAoIGdvb2Quc3RvY2sgKSB7XG4gICAgICAgICAgICBhbGxTdG9ja0Fyci5wdXNoKCBnb29kLnN0b2NrICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIGdvb2QuZ3JvdXBQcmljZSApIHtcbiAgICAgICAgICAgIGFsbFByaWNlQXJyLnB1c2goIGdvb2QuZ3JvdXBQcmljZSApO1xuICAgICAgICB9XG5cbiAgICB9O1xuXG4gICAgLy8g5peg5p2h5Lu25rOo5YWlIOeJueS7t+a0u+WKqOeahOS7t+agvOOAgeWboui0reS7t1xuICAgIGNvbnN0IGRlY29yYXRlSXRlbTIgPSBhY3Rpdml0aWVzID0+IHtcbiAgICAgICAgaWYgKCBBcnJheS5pc0FycmF5KCBhY3Rpdml0aWVzICkpIHtcbiAgICAgICAgICAgIGFjdGl2aXRpZXMubWFwKCBhYyA9PiB7XG4gICAgICAgICAgICAgICAgYWxsUHJpY2VBcnIucHVzaCggYWMuYWNfcHJpY2UgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIGFjLmFjX2dyb3VwUHJpY2UgKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbFByaWNlQXJyLnB1c2goIGFjLmFjX2dyb3VwUHJpY2UgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIOaXoOadoeS7tuazqOWFpSDnibnku7fmtLvliqjnmoTku7fmoLzjgIHlm6LotK3ku7dcbiAgICBkZWNvcmF0ZUl0ZW0yKCB4LmFjdGl2aXRpZXMgKTtcblxuICAgIC8vIOayoeacieWei+WPt1xuICAgIGlmICggIXguc3RhbmRhcmRzIHx8IHguc3RhbmRhcmRzLmxlbmd0aCA9PT0gMCApIHtcbiAgICAgICAgZGVjb3JhdGVJdGVtKCB4ICk7XG4gICAgICAgIGxvd2VzdF9waW5fb3JpZ2luX3ByaWNlJCA9IHgucHJpY2U7XG4gICAgLy8g5pyJ5Z6L5Y+3XG4gICAgfSBlbHNlIHtcbiAgICAgICAgeC5zdGFuZGFyZHMubWFwKCBkZWNvcmF0ZUl0ZW0gKTtcblxuICAgICAgICBsZXQgc3RhbmRhcmRTZXQ6IGFueSA9IG51bGw7XG4gICAgICAgIGxldCBsb3dlc3Rfc3RhbmRhcmRfcHJpY2UgPSAwO1xuXG4gICAgICAgIHguc3RhbmRhcmRzLm1hcCggeCA9PiB7XG4gICAgICAgICAgICBpZiAoIHguZ3JvdXBQcmljZSA8IGxvd2VzdF9zdGFuZGFyZF9wcmljZSB8fCBsb3dlc3Rfc3RhbmRhcmRfcHJpY2UgPT09IDAgKSB7XG4gICAgICAgICAgICAgICAgc3RhbmRhcmRTZXQgPSB4O1xuICAgICAgICAgICAgICAgIGxvd2VzdF9zdGFuZGFyZF9wcmljZSA9IHguZ3JvdXBQcmljZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmICggISFzdGFuZGFyZFNldCApIHtcbiAgICAgICAgICAgIGxvd2VzdF9waW5fb3JpZ2luX3ByaWNlJCA9IHN0YW5kYXJkU2V0LnByaWNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8g6YeN5paw5o6S5bqP5Lu35qC85ZKM5bqT5a2YXG4gICAgYWxsUHJpY2VBcnIgPSBhbGxQcmljZUFyci5zb3J0KCggeCwgeSApID0+IHggLSB5ICk7XG4gICAgYWxsU3RvY2tBcnIgPSBhbGxTdG9ja0Fyci5zb3J0KCggeCwgeSApID0+IHggLSB5ICk7XG5cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7IH0sIHgsIHtcblxuICAgICAgICBwaWQ6IHguX2lkLFxuXG4gICAgICAgIC8vIOaYr+WQpuacieaLvOWbolxuICAgICAgICBoYXNQaW46IGhhc1BpbiggeCApLFxuXG4gICAgICAgIC8vIOW6k+WtmOWMuumXtFxuICAgICAgICBzdG9jayQ6IGFsbFN0b2NrQXJyLmxlbmd0aCA9PT0gMCA/XG4gICAgICAgICAgICBhbGxTdG9ja0FyclsgMCBdIDpcbiAgICAgICAgICAgIGFsbFN0b2NrQXJyWyAwIF0gPT09IGFsbFN0b2NrQXJyWyBhbGxTdG9ja0Fyci5sZW5ndGggLSAxIF0gP1xuICAgICAgICAgICAgICAgIGFsbFN0b2NrQXJyWyAwIF0gOlxuICAgICAgICAgICAgICAgIGAke2FsbFN0b2NrQXJyWyAwIF19IH4gJHthbGxTdG9ja0FyclsgYWxsU3RvY2tBcnIubGVuZ3RoIC0gMSBdfWAsXG5cbiAgICAgICAgLy8g5Lu35qC85Yy66Ze0XG4gICAgICAgIHByaWNlJDogYWxsUHJpY2VBcnIubGVuZ3RoID09PSAwID9cbiAgICAgICAgICAgIGFsbFByaWNlQXJyWyAwIF0gOlxuICAgICAgICAgICAgICAgIGFsbFByaWNlQXJyWyAwIF0gPT09IGFsbFByaWNlQXJyWyBhbGxQcmljZUFyci5sZW5ndGggLSAxIF0gPyBcbiAgICAgICAgICAgICAgICAgICAgYWxsUHJpY2VBcnJbIDAgXSA6XG4gICAgICAgICAgICAgICAgICAgIGAke2FsbFByaWNlQXJyWyAwIF19IH4gJHthbGxQcmljZUFyclsgYWxsUHJpY2VBcnIubGVuZ3RoIC0gMSBdfWAsXG5cbiAgICAgICAgLy8g5Y+v6I6356ev5YiG5Yy66Ze0XG4gICAgICAgIGludGVncmFsJDogYWxsUHJpY2VBcnIubGVuZ3RoID09PSAwID9cbiAgICAgICAgICAgIChhbGxQcmljZUFyclsgMCBdICogcHVzaEludGVncmFsUmF0ZSkudG9GaXhlZCggMSApIDpcbiAgICAgICAgICAgICAgICBhbGxQcmljZUFyclsgMCBdID09PSBhbGxQcmljZUFyclsgYWxsUHJpY2VBcnIubGVuZ3RoIC0gMSBdID8gXG4gICAgICAgICAgICAgICAgICAgIChhbGxQcmljZUFyclsgMCBdICogcHVzaEludGVncmFsUmF0ZSkudG9GaXhlZCggMSApIDpcbiAgICAgICAgICAgICAgICAgICAgYCR7KGFsbFByaWNlQXJyWyAwIF0gKiBwdXNoSW50ZWdyYWxSYXRlKS50b0ZpeGVkKCAxICl9IH4gJHsoYWxsUHJpY2VBcnJbIGFsbFByaWNlQXJyLmxlbmd0aCAtIDEgXSAqIHB1c2hJbnRlZ3JhbFJhdGUpLnRvRml4ZWQoIDEgKX1gLFxuXG4gICAgICAgIC8vIOacgOWkp+enr+WIhlxuICAgICAgICBpbnRlZ3JhbDIkOiAoYWxsUHJpY2VBcnJbIGFsbFByaWNlQXJyLmxlbmd0aCAtIDEgXSAqIHB1c2hJbnRlZ3JhbFJhdGUpLnRvRml4ZWQoIDEgKSxcblxuICAgICAgICAvLyDmnIDlpKfluYXluqblt67ku7dcbiAgICAgICAgcHJpY2VHYXA6IGFsbFByaWNlQXJyLmxlbmd0aCA9PT0gMCA/XG4gICAgICAgICAgICAwIDpcbiAgICAgICAgICAgIGAke2FsbFByaWNlQXJyWyBhbGxQcmljZUFyci5sZW5ndGggLSAxIF0gLSBhbGxQcmljZUFyclsgMCBdfWAsXG5cbiAgICAgICAgLy8g5pyA5L2O5Lu35qC877yI5ZCr5Zui6LSt5Lu377yJXG4gICAgICAgIGxvd2VzdF9wcmljZSQ6IGFsbFByaWNlQXJyWyAwIF0sXG5cbiAgICAgICAgLy8g5pyA5L2O5Lu35qC877yI5ZCr5Zui6LSt5Lu377yJ55qE5Y6f5Lu3XG4gICAgICAgIGxvd2VzdF9waW5fb3JpZ2luX3ByaWNlJCxcblxuICAgICAgICAvKiog5piv5ZCm5pyJ5rS75YqoICovXG4gICAgICAgIGhhc0FjdGl2aXR5OiAhIXguYWN0aXZpdHkgfHwgKEFycmF5LmlzQXJyYXkoIHguYWN0aXZpdGllcyApICYmIHguYWN0aXZpdGllcy5sZW5ndGggPiAwKSxcblxuICAgICAgICAvKiog5ou85Zui5L+h5oGvICovXG4gICAgICAgIGdvb2RQaW5zOiBkZWFsR29vZFBpbiggeCApLFxuXG4gICAgICAgIC8qKiDmoIfnrb4gKi9cbiAgICAgICAgdGFnVGV4dDogeC50YWcuam9pbign44CBJyksXG5cbiAgICAgICAgLyoqIOaYr+WQpuWtmOWcqOW6k+WtmOWRiuaApSAqL1xuICAgICAgICBvdXRTdG9jazogYWxsU3RvY2tBcnIuc29tZSggeCA9PiB4IDwgMTAgKVxuICAgIH0pXG5cbn07XG5cbmNvbnN0IGhhc1BpbiA9IGdvb2QgPT4ge1xuICAgIGNvbnN0IHsgYWN0aXZpdGllcywgc3RhbmRhcmRzLCBncm91cFByaWNlIH0gPSBnb29kO1xuICAgIGNvbnN0IHBpbmluZ1N0YW5kYXJkcyA9IHN0YW5kYXJkcy5maWx0ZXIoIHggPT4gISF4Lmdyb3VwUHJpY2UgKTtcbiAgICBjb25zdCBwaW5pbmdBY3RpdmllcyA9ICEhYWN0aXZpdGllcyA/IGFjdGl2aXRpZXMuZmlsdGVyKCB4ID0+ICEheC5hY19ncm91cFByaWNlICkgOiBbIF07XG4gICAgcmV0dXJuICEhZ3JvdXBQcmljZSB8fCBwaW5pbmdTdGFuZGFyZHMubGVuZ3RoID4gMCB8fCBwaW5pbmdBY3Rpdmllcy5sZW5ndGggPiAwO1xufVxuXG4vKiog5aSE55CG5ZWG5ZOB55qE5ou85Zui5beu5Lu377yM6L+U5Zue5ou85Zui5YiX6KGo5ZKM5ou85Zui5beu5Lu35Yy66Ze077yI5ZCr54m55Lu377yJICovXG5jb25zdCBkZWFsR29vZFBpbiA9IGdvb2QgPT4ge1xuICAgIGNvbnN0IHsgYWN0aXZpdGllcywgc3RhbmRhcmRzLCBwcmljZSwgZ3JvdXBQcmljZSB9ID0gZ29vZDtcblxuICAgIC8vIOWNleWTgSBcbiAgICBpZiAoICFzdGFuZGFyZHMgfHwgc3RhbmRhcmRzLmxlbmd0aCA9PT0gMCApIHtcbiAgICAgICAgY29uc3QgYWNUYXJnZXQgPSAhYWN0aXZpdGllcyA/XG4gICAgICAgICAgICAgICAgbnVsbCA6IFxuICAgICAgICAgICAgICAgIGFjdGl2aXRpZXMuZmluZCggYWMgPT4gYWMucGlkID09PSBnb29kLnBpZCApO1xuICAgICAgICBjb25zdCBwID0gYWNUYXJnZXQgPyBhY1RhcmdldC5hY19wcmljZSA6IHByaWNlO1xuICAgICAgICBjb25zdCBncCA9IGFjVGFyZ2V0ID8gYWNUYXJnZXQuYWNfZ3JvdXBQcmljZSA6IGdyb3VwUHJpY2U7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAvLyDmi7zlm6LliJfooahcbiAgICAgICAgICAgIGxpc3Q6IFt7XG4gICAgICAgICAgICAgICAgcHJpY2U6IHAsXG4gICAgICAgICAgICAgICAgZ3JvdXBQcmljZTogZ3BcbiAgICAgICAgICAgIH1dLFxuICAgICAgICAgICAgLy8g5q+P5a+55Y+v5ou85Zui5Z6L5Y+377yM5Y+v5LyY5oOg55qE5Lu35qC85Yy66Ze0XG4gICAgICAgICAgICBlYWNoUHJpY2VSb3VuZDogZ3AgPyAocCAtIGdwKS50b0ZpeGVkKCAyICkgOiAwXG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuXG4gICAgICAgIC8qKiDlnovlj7cgKyDnibnku7cgKi9cbiAgICAgICAgY29uc3QgbWV0YSA9IHN0YW5kYXJkcy5tYXAoIHN0YW5kYXJkID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFjVGFyZ2V0ID0gIWFjdGl2aXRpZXMgP1xuICAgICAgICAgICAgICAgIG51bGwgOiBcbiAgICAgICAgICAgICAgICBhY3Rpdml0aWVzLmZpbmQoIGFjID0+IGFjLnBpZCA9PT0gc3RhbmRhcmQucGlkICYmIGFjLnNpZCA9PT0gc3RhbmRhcmQuX2lkICk7XG4gICAgICAgICAgICBpZiAoKCAhIWFjVGFyZ2V0ICYmICEhYWNUYXJnZXQuYWNfZ3JvdXBQcmljZSApIHx8IHN0YW5kYXJkLmdyb3VwUHJpY2UgKSB7XG4gICAgICAgICAgICAgICAgaWYgKCBhY1RhcmdldCApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaWNlOiBhY1RhcmdldC5hY19wcmljZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwUHJpY2U6IGFjVGFyZ2V0LmFjX2dyb3VwUHJpY2VcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmljZTogc3RhbmRhcmQucHJpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cFByaWNlOiBzdGFuZGFyZC5ncm91cFByaWNlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSkuZmlsdGVyKCB4ID0+ICEheCApO1xuXG4gICAgICAgIGNvbnN0IGRlbHRhcyA9IG1ldGEubWFwKCB4ID0+IFxuICAgICAgICAgICAgKHgucHJpY2UgLSAoIHguZ3JvdXBQcmljZSB8fCAwICkpLnRvRml4ZWQoIDIgKVxuICAgICAgICApLnNvcnQoKCB4LCB5ICkgPT4geSAtIHggKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbGlzdDogbWV0YSxcbiAgICAgICAgICAgIC8vIOavj+WvueWPr+aLvOWbouWei+WPt++8jOWPr+S8mOaDoOeahOS7t+agvOWMuumXtFxuICAgICAgICAgICAgZWFjaFByaWNlUm91bmQ6ICBkZWx0YXNbIGRlbHRhcy5sZW5ndGggLSAxIF0gIT09IGRlbHRhc1sgMCBdID9cbiAgICAgICAgICAgICAgICAgYCR7ZGVsdGFzWyBkZWx0YXMubGVuZ3RoIC0gMSBdfSB+ICR7ZGVsdGFzWyAwIF19YCA6XG4gICAgICAgICAgICAgICAgIGRlbHRhc1sgMCBdXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5leHBvcnQge1xuICAgIGRlbGF5ZXJpbmdHb29kXG59Il19