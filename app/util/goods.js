"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var pushIntegralRate = 0.05;
var delayeringGood = function (x, pushIntegralRate) {
    if (pushIntegralRate === void 0) { pushIntegralRate = 0; }
    if (!x) {
        return null;
    }
    var lowest_pin_origin_price$ = x.price;
    var allPriceArr = [];
    var allStockArr = [];
    var decorateItem = function (good) {
        allPriceArr.push(good.price);
        if (good.stock) {
            allStockArr.push(good.stock);
        }
        if (good.groupPrice) {
            allPriceArr.push(good.groupPrice);
        }
    };
    var decorateItem2 = function (activities) {
        if (Array.isArray(activities)) {
            activities.map(function (ac) {
                allPriceArr.push(ac.ac_price);
                if (ac.ac_groupPrice) {
                    allPriceArr.push(ac.ac_groupPrice);
                }
            });
        }
    };
    decorateItem2(x.activities);
    if (!x.standards || x.standards.length === 0) {
        decorateItem(x);
        lowest_pin_origin_price$ = x.price;
    }
    else {
        x.standards.map(decorateItem);
        var standardSet_1 = null;
        var lowest_standard_price_1 = 0;
        x.standards.map(function (x) {
            if (x.groupPrice < lowest_standard_price_1 || lowest_standard_price_1 === 0) {
                standardSet_1 = x;
                lowest_standard_price_1 = x.groupPrice;
            }
        });
        if (!!standardSet_1) {
            lowest_pin_origin_price$ = standardSet_1.price;
        }
    }
    allPriceArr = allPriceArr.sort(function (x, y) { return x - y; });
    allStockArr = allStockArr.sort(function (x, y) { return x - y; });
    return Object.assign({}, x, {
        pid: x._id,
        hasPin: hasPin(x),
        stock$: allStockArr.length === 0 ?
            allStockArr[0] :
            allStockArr[0] === allStockArr[allStockArr.length - 1] ?
                allStockArr[0] :
                allStockArr[0] + " ~ " + allStockArr[allStockArr.length - 1],
        price$: allPriceArr.length === 0 ?
            allPriceArr[0] :
            allPriceArr[0] === allPriceArr[allPriceArr.length - 1] ?
                allPriceArr[0] :
                allPriceArr[0] + " ~ " + allPriceArr[allPriceArr.length - 1],
        integral$: allPriceArr.length === 0 ?
            (allPriceArr[0] * pushIntegralRate).toFixed(1) :
            allPriceArr[0] === allPriceArr[allPriceArr.length - 1] ?
                (allPriceArr[0] * pushIntegralRate).toFixed(1) :
                (allPriceArr[0] * pushIntegralRate).toFixed(1) + " ~ " + (allPriceArr[allPriceArr.length - 1] * pushIntegralRate).toFixed(1),
        integral2$: (allPriceArr[allPriceArr.length - 1] * pushIntegralRate).toFixed(1),
        priceGap: allPriceArr.length === 0 ?
            0 :
            "" + (allPriceArr[allPriceArr.length - 1] - allPriceArr[0]),
        lowest_price$: allPriceArr[0],
        lowest_pin_origin_price$: lowest_pin_origin_price$,
        hasActivity: !!x.activity || (Array.isArray(x.activities) && x.activities.length > 0),
        goodPins: dealGoodPin(x),
        tagText: x.tag.join('„ÄÅ'),
        outStock: allStockArr.some(function (x) { return x < 10; })
    });
};
exports.delayeringGood = delayeringGood;
var hasPin = function (good) {
    var activities = good.activities, standards = good.standards, groupPrice = good.groupPrice;
    var piningStandards = standards.filter(function (x) { return !!x.groupPrice; });
    var piningActivies = !!activities ? activities.filter(function (x) { return !!x.ac_groupPrice; }) : [];
    return !!groupPrice || piningStandards.length > 0 || piningActivies.length > 0;
};
var dealGoodPin = function (good) {
    var activities = good.activities, standards = good.standards, price = good.price, groupPrice = good.groupPrice;
    if (!standards || standards.length === 0) {
        var acTarget = !activities ?
            null :
            activities.find(function (ac) { return ac.pid === good.pid; });
        var p = acTarget ? acTarget.ac_price : price;
        var gp = acTarget ? acTarget.ac_groupPrice : groupPrice;
        return {
            list: [{
                    price: p,
                    groupPrice: gp
                }],
            eachPriceRound: gp ? (p - gp).toFixed(2) : 0
        };
    }
    else {
        var meta = standards.map(function (standard) {
            var acTarget = !activities ?
                null :
                activities.find(function (ac) { return ac.pid === standard.pid && ac.sid === standard._id; });
            if ((!!acTarget && !!acTarget.ac_groupPrice) || standard.groupPrice) {
                if (acTarget) {
                    return {
                        price: acTarget.ac_price,
                        groupPrice: acTarget.ac_groupPrice
                    };
                }
                else {
                    return {
                        price: standard.price,
                        groupPrice: standard.groupPrice
                    };
                }
            }
            return null;
        }).filter(function (x) { return !!x; });
        var deltas = meta.map(function (x) {
            return (x.price - (x.groupPrice || 0)).toFixed(2);
        }).sort(function (x, y) { return y - x; });
        return {
            list: meta,
            eachPriceRound: deltas[deltas.length - 1] !== deltas[0] ?
                deltas[deltas.length - 1] + " ~ " + deltas[0] :
                deltas[0]
        };
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnb29kcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBTzlCLElBQU0sY0FBYyxHQUFHLFVBQUUsQ0FBQyxFQUFFLGdCQUFvQjtJQUFwQixpQ0FBQSxFQUFBLG9CQUFvQjtJQUU1QyxJQUFLLENBQUMsQ0FBQyxFQUFHO1FBQ04sT0FBTyxJQUFJLENBQUE7S0FDZDtJQUdELElBQUksd0JBQXdCLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUd2QyxJQUFJLFdBQVcsR0FBVyxFQUFHLENBQUM7SUFHOUIsSUFBSSxXQUFXLEdBQVksRUFBRyxDQUFDO0lBRy9CLElBQU0sWUFBWSxHQUFHLFVBQUEsSUFBSTtRQUVyQixXQUFXLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxLQUFLLENBQUUsQ0FBQztRQUUvQixJQUFLLElBQUksQ0FBQyxLQUFLLEVBQUc7WUFDZCxXQUFXLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxLQUFLLENBQUUsQ0FBQztTQUNsQztRQUVELElBQUssSUFBSSxDQUFDLFVBQVUsRUFBRztZQUNuQixXQUFXLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxVQUFVLENBQUUsQ0FBQztTQUN2QztJQUVMLENBQUMsQ0FBQztJQUdGLElBQU0sYUFBYSxHQUFHLFVBQUEsVUFBVTtRQUM1QixJQUFLLEtBQUssQ0FBQyxPQUFPLENBQUUsVUFBVSxDQUFFLEVBQUU7WUFDOUIsVUFBVSxDQUFDLEdBQUcsQ0FBRSxVQUFBLEVBQUU7Z0JBQ2QsV0FBVyxDQUFDLElBQUksQ0FBRSxFQUFFLENBQUMsUUFBUSxDQUFFLENBQUM7Z0JBRWhDLElBQUssRUFBRSxDQUFDLGFBQWEsRUFBRztvQkFDcEIsV0FBVyxDQUFDLElBQUksQ0FBRSxFQUFFLENBQUMsYUFBYSxDQUFFLENBQUM7aUJBQ3hDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7U0FDTjtJ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LFVBQVUsSUFBSSxDQUFDLENBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBRSxDQUFDLENBQUU7UUFBOUMsQ0FBOEMsQ0FDakQsQ0FBQyxJQUFJLENBQUMsVUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFNLE9BQUEsQ0FBQyxHQUFHLENBQUMsRUFBTCxDQUFLLENBQUUsQ0FBQztRQUUzQixPQUFPO1lBQ0gsSUFBSSxFQUFFLElBQUk7WUFFVixjQUFjLEVBQUcsTUFBTSxDQUFFLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFFLEtBQUssTUFBTSxDQUFFLENBQUMsQ0FBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sQ0FBRSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBRSxXQUFNLE1BQU0sQ0FBRSxDQUFDLENBQUksQ0FBQyxDQUFDO2dCQUNuRCxNQUFNLENBQUUsQ0FBQyxDQUFFO1NBQ25CLENBQUM7S0FDTDtBQUNMLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxuLyoqIOenr+WIhuaOqOW5v+avlOS+iyAqL1xuY29uc3QgcHVzaEludGVncmFsUmF0ZSA9IDAuMDU7XG5cbi8qKiBcbiAqIOWVhuWTgSDvvZ4g5Lu35qC85Yy66Ze044CB5bqT5a2Y5Yy66Ze044CB5beu5Lu344CB5pyA5L2O5Lu35qC877yI5ZCr5Zui6LSt5Lu3L+S4gOWPo+S7t++8iVxuICogQHBhcmFtIHgg5ZWG5ZOB6K+m5oOFXG4gKiBAcGFyYW0gcHVzaEludGVncmFsUmF0ZSDnp6/liIbmjqjlub/ojrfngrnmr5TkvotcbiAqL1xuY29uc3QgZGVsYXllcmluZ0dvb2QgPSAoIHgsIHB1c2hJbnRlZ3JhbFJhdGUgPSAwICkgPT4ge1xuIFxuICAgIGlmICggIXggKSB7XG4gICAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgLy8g5pyA5L2O5ou85Zui5Lu377yM5a+55bqU55qE5Y6f5Lu3XG4gICAgbGV0IGxvd2VzdF9waW5fb3JpZ2luX3ByaWNlJCA9IHgucHJpY2U7XG5cbiAgICAvLyDliJ3lp4vljJbvvJrku7fmoLzmlbDnu4TvvIjlkKvlm6LotK3ku7fjgIHnibnku7fvvIlcbiAgICBsZXQgYWxsUHJpY2VBcnI6IGFueVsgXSA9IFsgXTtcblxuICAgIC8vIOWIneWni+WMlu+8muW6k+WtmOWIl+ihqFxuICAgIGxldCBhbGxTdG9ja0FycjogYW55WyBdICA9IFsgXTtcblxuICAgIC8vIOaXoOadoeS7tuazqOWFpSDkuLvkuqflk4Ev5Z6L5Y+35Lu35qC844CB5Zui6LSt5Lu3XG4gICAgY29uc3QgZGVjb3JhdGVJdGVtID0gZ29vZCA9PiB7XG5cbiAgICAgICAgYWxsUHJpY2VBcnIucHVzaCggZ29vZC5wcmljZSApO1xuICAgICAgICBcbiAgICAgICAgaWYgKCBnb29kLnN0b2NrICkge1xuICAgICAgICAgICAgYWxsU3RvY2tBcnIucHVzaCggZ29vZC5zdG9jayApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCBnb29kLmdyb3VwUHJpY2UgKSB7XG4gICAgICAgICAgICBhbGxQcmljZUFyci5wdXNoKCBnb29kLmdyb3VwUHJpY2UgKTtcbiAgICAgICAgfVxuXG4gICAgfTtcblxuICAgIC8vIOaXoOadoeS7tuazqOWFpSDnibnku7fmtLvliqjnmoTku7fmoLzjgIHlm6LotK3ku7dcbiAgICBjb25zdCBkZWNvcmF0ZUl0ZW0yID0gYWN0aXZpdGllcyA9PiB7XG4gICAgICAgIGlmICggQXJyYXkuaXNBcnJheSggYWN0aXZpdGllcyApKSB7XG4gICAgICAgICAgICBhY3Rpdml0aWVzLm1hcCggYWMgPT4ge1xuICAgICAgICAgICAgICAgIGFsbFByaWNlQXJyLnB1c2goIGFjLmFjX3ByaWNlICk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCBhYy5hY19ncm91cFByaWNlICkge1xuICAgICAgICAgICAgICAgICAgICBhbGxQcmljZUFyci5wdXNoKCBhYy5hY19ncm91cFByaWNlICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDml6DmnaHku7bms6jlhaUg54m55Lu35rS75Yqo55qE5Lu35qC844CB5Zui6LSt5Lu3XG4gICAgZGVjb3JhdGVJdGVtMiggeC5hY3Rpdml0aWVzICk7XG5cbiAgICAvLyDmsqHmnInlnovlj7dcbiAgICBpZiAoICF4LnN0YW5kYXJkcyB8fCB4LnN0YW5kYXJkcy5sZW5ndGggPT09IDAgKSB7XG4gICAgICAgIGRlY29yYXRlSXRlbSggeCApO1xuICAgICAgICBsb3dlc3RfcGluX29yaWdpbl9wcmljZSQgPSB4LnByaWNlO1xuICAgIC8vIOacieWei+WPt1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHguc3RhbmRhcmRzLm1hcCggZGVjb3JhdGVJdGVtICk7XG5cbiAgICAgICAgbGV0IHN0YW5kYXJkU2V0OiBhbnkgPSBudWxsO1xuICAgICAgICBsZXQgbG93ZXN0X3N0YW5kYXJkX3ByaWNlID0gMDtcblxuICAgICAgICB4LnN0YW5kYXJkcy5tYXAoIHggPT4ge1xuICAgICAgICAgICAgaWYgKCB4Lmdyb3VwUHJpY2UgPCBsb3dlc3Rfc3RhbmRhcmRfcHJpY2UgfHwgbG93ZXN0X3N0YW5kYXJkX3ByaWNlID09PSAwICkge1xuICAgICAgICAgICAgICAgIHN0YW5kYXJkU2V0ID0geDtcbiAgICAgICAgICAgICAgICBsb3dlc3Rfc3RhbmRhcmRfcHJpY2UgPSB4Lmdyb3VwUHJpY2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoICEhc3RhbmRhcmRTZXQgKSB7XG4gICAgICAgICAgICBsb3dlc3RfcGluX29yaWdpbl9wcmljZSQgPSBzdGFuZGFyZFNldC5wcmljZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIOmHjeaWsOaOkuW6j+S7t+agvOWSjOW6k+WtmFxuICAgIGFsbFByaWNlQXJyID0gYWxsUHJpY2VBcnIuc29ydCgoIHgsIHkgKSA9PiB4IC0geSApO1xuICAgIGFsbFN0b2NrQXJyID0gYWxsU3RvY2tBcnIuc29ydCgoIHgsIHkgKSA9PiB4IC0geSApO1xuXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyB9LCB4LCB7XG5cbiAgICAgICAgcGlkOiB4Ll9pZCxcblxuICAgICAgICAvLyDmmK/lkKbmnInmi7zlm6JcbiAgICAgICAgaGFzUGluOiBoYXNQaW4oIHggKSxcblxuICAgICAgICAvLyDlupPlrZjljLrpl7RcbiAgICAgICAgc3RvY2skOiBhbGxTdG9ja0Fyci5sZW5ndGggPT09IDAgP1xuICAgICAgICAgICAgYWxsU3RvY2tBcnJbIDAgXSA6XG4gICAgICAgICAgICBhbGxTdG9ja0FyclsgMCBdID09PSBhbGxTdG9ja0FyclsgYWxsU3RvY2tBcnIubGVuZ3RoIC0gMSBdID9cbiAgICAgICAgICAgICAgICBhbGxTdG9ja0FyclsgMCBdIDpcbiAgICAgICAgICAgICAgICBgJHthbGxTdG9ja0FyclsgMCBdfSB+ICR7YWxsU3RvY2tBcnJbIGFsbFN0b2NrQXJyLmxlbmd0aCAtIDEgXX1gLFxuXG4gICAgICAgIC8vIOS7t+agvOWMuumXtFxuICAgICAgICBwcmljZSQ6IGFsbFByaWNlQXJyLmxlbmd0aCA9PT0gMCA/XG4gICAgICAgICAgICBhbGxQcmljZUFyclsgMCBdIDpcbiAgICAgICAgICAgICAgICBhbGxQcmljZUFyclsgMCBdID09PSBhbGxQcmljZUFyclsgYWxsUHJpY2VBcnIubGVuZ3RoIC0gMSBdID8gXG4gICAgICAgICAgICAgICAgICAgIGFsbFByaWNlQXJyWyAwIF0gOlxuICAgICAgICAgICAgICAgICAgICBgJHthbGxQcmljZUFyclsgMCBdfSB+ICR7YWxsUHJpY2VBcnJbIGFsbFByaWNlQXJyLmxlbmd0aCAtIDEgXX1gLFxuXG4gICAgICAgIC8vIOWPr+iOt+enr+WIhuWMuumXtFxuICAgICAgICBpbnRlZ3JhbCQ6IGFsbFByaWNlQXJyLmxlbmd0aCA9PT0gMCA/XG4gICAgICAgICAgICAoYWxsUHJpY2VBcnJbIDAgXSAqIHB1c2hJbnRlZ3JhbFJhdGUpLnRvRml4ZWQoIDEgKSA6XG4gICAgICAgICAgICAgICAgYWxsUHJpY2VBcnJbIDAgXSA9PT0gYWxsUHJpY2VBcnJbIGFsbFByaWNlQXJyLmxlbmd0aCAtIDEgXSA/IFxuICAgICAgICAgICAgICAgICAgICAoYWxsUHJpY2VBcnJbIDAgXSAqIHB1c2hJbnRlZ3JhbFJhdGUpLnRvRml4ZWQoIDEgKSA6XG4gICAgICAgICAgICAgICAgICAgIGAkeyhhbGxQcmljZUFyclsgMCBdICogcHVzaEludGVncmFsUmF0ZSkudG9GaXhlZCggMSApfSB+ICR7KGFsbFByaWNlQXJyWyBhbGxQcmljZUFyci5sZW5ndGggLSAxIF0gKiBwdXNoSW50ZWdyYWxSYXRlKS50b0ZpeGVkKCAxICl9YCxcblxuICAgICAgICAvLyDmnIDlpKfnp6/liIZcbiAgICAgICAgaW50ZWdyYWwyJDogKGFsbFByaWNlQXJyWyBhbGxQcmljZUFyci5sZW5ndGggLSAxIF0gKiBwdXNoSW50ZWdyYWxSYXRlKS50b0ZpeGVkKCAxICksXG5cbiAgICAgICAgLy8g5pyA5aSn5bmF5bqm5beu5Lu3XG4gICAgICAgIHByaWNlR2FwOiBhbGxQcmljZUFyci5sZW5ndGggPT09IDAgP1xuICAgICAgICAgICAgMCA6XG4gICAgICAgICAgICBgJHthbGxQcmljZUFyclsgYWxsUHJpY2VBcnIubGVuZ3RoIC0gMSBdIC0gYWxsUHJpY2VBcnJbIDAgXX1gLFxuXG4gICAgICAgIC8vIOacgOS9juS7t+agvO+8iOWQq+Wboui0reS7t++8iVxuICAgICAgICBsb3dlc3RfcHJpY2UkOiBhbGxQcmljZUFyclsgMCBdLFxuXG4gICAgICAgIC8vIOacgOS9juS7t+agvO+8iOWQq+Wboui0reS7t++8ieeahOWOn+S7t1xuICAgICAgICBsb3dlc3RfcGluX29yaWdpbl9wcmljZSQsXG5cbiAgICAgICAgLyoqIOaYr+WQpuaciea0u+WKqCAqL1xuICAgICAgICBoYXNBY3Rpdml0eTogISF4LmFjdGl2aXR5IHx8IChBcnJheS5pc0FycmF5KCB4LmFjdGl2aXRpZXMgKSAmJiB4LmFjdGl2aXRpZXMubGVuZ3RoID4gMCksXG5cbiAgICAgICAgLyoqIOaLvOWbouS/oeaBryAqL1xuICAgICAgICBnb29kUGluczogZGVhbEdvb2RQaW4oIHggKSxcblxuICAgICAgICAvKiog5qCH562+ICovXG4gICAgICAgIHRhZ1RleHQ6IHgudGFnLmpvaW4oJ+OAgScpLFxuXG4gICAgICAgIC8qKiDmmK/lkKblrZjlnKjlupPlrZjlkYrmgKUgKi9cbiAgICAgICAgb3V0U3RvY2s6IGFsbFN0b2NrQXJyLnNvbWUoIHggPT4geCA8IDEwIClcbiAgICB9KVxuXG59O1xuXG5jb25zdCBoYXNQaW4gPSBnb29kID0+IHtcbiAgICBjb25zdCB7IGFjdGl2aXRpZXMsIHN0YW5kYXJkcywgZ3JvdXBQcmljZSB9ID0gZ29vZDtcbiAgICBjb25zdCBwaW5pbmdTdGFuZGFyZHMgPSBzdGFuZGFyZHMuZmlsdGVyKCB4ID0+ICEheC5ncm91cFByaWNlICk7XG4gICAgY29uc3QgcGluaW5nQWN0aXZpZXMgPSAhIWFjdGl2aXRpZXMgPyBhY3Rpdml0aWVzLmZpbHRlciggeCA9PiAhIXguYWNfZ3JvdXBQcmljZSApIDogWyBdO1xuICAgIHJldHVybiAhIWdyb3VwUHJpY2UgfHwgcGluaW5nU3RhbmRhcmRzLmxlbmd0aCA+IDAgfHwgcGluaW5nQWN0aXZpZXMubGVuZ3RoID4gMDtcbn1cblxuLyoqIOWkhOeQhuWVhuWTgeeahOaLvOWbouW3ruS7t++8jOi/lOWbnuaLvOWbouWIl+ihqOWSjOaLvOWbouW3ruS7t+WMuumXtO+8iOWQq+eJueS7t++8iSAqL1xuY29uc3QgZGVhbEdvb2RQaW4gPSBnb29kID0+IHtcbiAgICBjb25zdCB7IGFjdGl2aXRpZXMsIHN0YW5kYXJkcywgcHJpY2UsIGdyb3VwUHJpY2UgfSA9IGdvb2Q7XG5cbiAgICAvLyDljZXlk4EgXG4gICAgaWYgKCAhc3RhbmRhcmRzIHx8IHN0YW5kYXJkcy5sZW5ndGggPT09IDAgKSB7XG4gICAgICAgIGNvbnN0IGFjVGFyZ2V0ID0gIWFjdGl2aXRpZXMgP1xuICAgICAgICAgICAgICAgIG51bGwgOiBcbiAgICAgICAgICAgICAgICBhY3Rpdml0aWVzLmZpbmQoIGFjID0+IGFjLnBpZCA9PT0gZ29vZC5waWQgKTtcbiAgICAgICAgY29uc3QgcCA9IGFjVGFyZ2V0ID8gYWNUYXJnZXQuYWNfcHJpY2UgOiBwcmljZTtcbiAgICAgICAgY29uc3QgZ3AgPSBhY1RhcmdldCA/IGFjVGFyZ2V0LmFjX2dyb3VwUHJpY2UgOiBncm91cFByaWNlO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLy8g5ou85Zui5YiX6KGoXG4gICAgICAgICAgICBsaXN0OiBbe1xuICAgICAgICAgICAgICAgIHByaWNlOiBwLFxuICAgICAgICAgICAgICAgIGdyb3VwUHJpY2U6IGdwXG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICAgIC8vIOavj+WvueWPr+aLvOWbouWei+WPt++8jOWPr+S8mOaDoOeahOS7t+agvOWMuumXtFxuICAgICAgICAgICAgZWFjaFByaWNlUm91bmQ6IGdwID8gKHAgLSBncCkudG9GaXhlZCggMiApIDogMFxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcblxuICAgICAgICAvKiog5Z6L5Y+3ICsg54m55Lu3ICovXG4gICAgICAgIGNvbnN0IG1ldGEgPSBzdGFuZGFyZHMubWFwKCBzdGFuZGFyZCA9PiB7XG4gICAgICAgICAgICBjb25zdCBhY1RhcmdldCA9ICFhY3Rpdml0aWVzID9cbiAgICAgICAgICAgICAgICBudWxsIDogXG4gICAgICAgICAgICAgICAgYWN0aXZpdGllcy5maW5kKCBhYyA9PiBhYy5waWQgPT09IHN0YW5kYXJkLnBpZCAmJiBhYy5zaWQgPT09IHN0YW5kYXJkLl9pZCApO1xuICAgICAgICAgICAgaWYgKCggISFhY1RhcmdldCAmJiAhIWFjVGFyZ2V0LmFjX2dyb3VwUHJpY2UgKSB8fCBzdGFuZGFyZC5ncm91cFByaWNlICkge1xuICAgICAgICAgICAgICAgIGlmICggYWNUYXJnZXQgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmljZTogYWNUYXJnZXQuYWNfcHJpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cFByaWNlOiBhY1RhcmdldC5hY19ncm91cFByaWNlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2U6IHN0YW5kYXJkLnByaWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBQcmljZTogc3RhbmRhcmQuZ3JvdXBQcmljZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH0pLmZpbHRlciggeCA9PiAhIXggKTtcblxuICAgICAgICBjb25zdCBkZWx0YXMgPSBtZXRhLm1hcCggeCA9PiBcbiAgICAgICAgICAgICh4LnByaWNlIC0gKCB4Lmdyb3VwUHJpY2UgfHwgMCApKS50b0ZpeGVkKCAyIClcbiAgICAgICAgKS5zb3J0KCggeCwgeSApID0+IHkgLSB4ICk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGxpc3Q6IG1ldGEsXG4gICAgICAgICAgICAvLyDmr4/lr7nlj6/mi7zlm6Llnovlj7fvvIzlj6/kvJjmg6DnmoTku7fmoLzljLrpl7RcbiAgICAgICAgICAgIGVhY2hQcmljZVJvdW5kOiAgZGVsdGFzWyBkZWx0YXMubGVuZ3RoIC0gMSBdICE9PSBkZWx0YXNbIDAgXSA/XG4gICAgICAgICAgICAgICAgIGAke2RlbHRhc1sgZGVsdGFzLmxlbmd0aCAtIDEgXX0gfiAke2RlbHRhc1sgMCBdfWAgOlxuICAgICAgICAgICAgICAgICBkZWx0YXNbIDAgXVxuICAgICAgICB9O1xuICAgIH1cbn1cblxuZXhwb3J0IHtcbiAgICBkZWxheWVyaW5nR29vZFxufSJdfQ==