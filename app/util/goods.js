"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var delayeringGood = function (x) {
    if (!x) {
        return null;
    }
    var allPriceArr = [];
    var allStockArr = [];
    var decorateItem = function (good) {
        allPriceArr.push(good.price);
        if (good.stock) {
            allStockArr.push(good.stock);
        }
        if (good.groupPrice) {
            allPriceArr.push(good.groupPrice);
        }
    };
    var decorateItem2 = function (activities) {
        if (Array.isArray(activities)) {
            activities.map(function (ac) {
                allPriceArr.push(ac.ac_price);
                if (ac.ac_groupPrice) {
                    allPriceArr.push(ac.ac_groupPrice);
                }
            });
        }
    };
    decorateItem2(x.activities);
    if (!x.standards || x.standards.length === 0) {
        decorateItem(x);
    }
    else {
        x.standards.map(decorateItem);
    }
    allPriceArr = allPriceArr.sort(function (x, y) { return x - y; });
    allStockArr = allStockArr.sort(function (x, y) { return x - y; });
    return Object.assign({}, x, {
        pid: x._id,
        stock$: allStockArr.length === 0 ?
            allStockArr[0] :
            allStockArr[0] === allStockArr[allStockArr.length - 1] ?
                allStockArr[0] :
                allStockArr[0] + " ~ " + allStockArr[allStockArr.length - 1],
        price$: allPriceArr.length === 0 ?
            allPriceArr[0] :
            allPriceArr[0] === allPriceArr[allPriceArr.length - 1] ?
                allPriceArr[0] :
                allPriceArr[0] + " ~ " + allPriceArr[allPriceArr.length - 1],
        priceGap: allPriceArr.length === 0 ?
            0 :
            "" + (allPriceArr[allPriceArr.length - 1] - allPriceArr[0]),
        lowest_price$: allPriceArr[0],
        hasActivity: !!x.activity || (Array.isArray(x.activities) && x.activities.length > 0),
        goodPins: dealGoodPin(x),
        tagText: x.tag.join('„ÄÅ'),
        outStock: allStockArr.some(function (x) { return x < 10; })
    });
};
exports.delayeringGood = delayeringGood;
var dealGoodPin = function (good) {
    var activities = good.activities, standards = good.standards, price = good.price, groupPrice = good.groupPrice;
    if (!standards || standards.length === 0) {
        var acTarget = !activities ?
            null :
            activities.find(function (ac) { return ac.pid === good.pid; });
        var p = acTarget ? acTarget.ac_price : price;
        var gp = acTarget ? acTarget.ac_groupPrice : groupPrice;
        return {
            list: [{
                    price: p,
                    groupPrice: gp
                }],
            eachPriceRound: gp ? p - gp : 0
        };
    }
    else {
        var meta = standards.map(function (standard) {
            var acTarget = !activities ?
                null :
                activities.find(function (ac) { return ac.pid === standard.pid && ac.sid === standard._id; });
            if ((!!acTarget && !!acTarget.ac_groupPrice) || standard.groupPrice) {
                if (acTarget) {
                    return {
                        price: acTarget.ac_price,
                        groupPrice: acTarget.ac_groupPrice
                    };
                }
                else {
                    return {
                        price: standard.price,
                        groupPrice: standard.groupPrice
                    };
                }
            }
            return null;
        }).filter(function (x) { return !!x; });
        var deltas = meta.map(function (x) {
            return x.price - (x.groupPrice || 0);
        }).sort(function (x, y) { return y - x; });
        return {
            list: meta,
            eachPriceRound: deltas[deltas.length - 1] !== deltas[0] ?
                deltas[deltas.length - 1] + " ~ " + deltas[0] :
                deltas[0]
        };
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnb29kcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLElBQU0sY0FBYyxHQUFHLFVBQUEsQ0FBQztJQUVwQixJQUFLLENBQUMsQ0FBQyxFQUFHO1FBQ04sT0FBTyxJQUFJLENBQUE7S0FDZDtJQUdELElBQUksV0FBVyxHQUFXLEVBQUcsQ0FBQztJQUc5QixJQUFJLFdBQVcsR0FBWSxFQUFHLENBQUM7SUFHL0IsSUFBTSxZQUFZLEdBQUcsVUFBQSxJQUFJO1FBRXJCLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDO1FBRS9CLElBQUssSUFBSSxDQUFDLEtBQUssRUFBRztZQUNkLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDO1NBQ2xDO1FBRUQsSUFBSyxJQUFJLENBQUMsVUFBVSxFQUFHO1lBQ25CLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxDQUFDO1NBQ3ZDO0lBRUwsQ0FBQyxDQUFDO0lBR0YsSUFBTSxhQUFhLEdBQUcsVUFBQSxVQUFVO1FBQzVCLElBQUssS0FBSyxDQUFDLE9BQU8sQ0FBRSxVQUFVLENBQUUsRUFBRTtZQUM5QixVQUFVLENBQUMsR0FBRyxDQUFFLFVBQUEsRUFBRTtnQkFDZCxXQUFXLENBQUMsSUFBSSxDQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUUsQ0FBQztnQkFFaEMsSUFBSyxFQUFFLENBQUMsYUFBYSxFQUFHO29CQUNwQixXQUFXLENBQUMsSUFBSSxDQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUUsQ0FBQztpQkFDeEM7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQyxDQUFBO0lBR0QsYUFBYSxDQUFFLENBQUMsQ0FBQyxVQUFVLENBQUUsQ0FBQztJQUc5QixJQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLE1B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SjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBRSxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxDQUFDLEVBQUgsQ0FBRyxDQUFFLENBQUM7UUFFdEIsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRSxVQUFBLENBQUM7WUFDdEIsT0FBQSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUUsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUU7UUFBL0IsQ0FBK0IsQ0FDbEMsQ0FBQyxJQUFJLENBQUMsVUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFNLE9BQUEsQ0FBQyxHQUFHLENBQUMsRUFBTCxDQUFLLENBQUUsQ0FBQztRQUUzQixPQUFPO1lBQ0gsSUFBSSxFQUFFLElBQUk7WUFFVixjQUFjLEVBQUcsTUFBTSxDQUFFLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFFLEtBQUssTUFBTSxDQUFFLENBQUMsQ0FBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sQ0FBRSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBRSxXQUFNLE1BQU0sQ0FBRSxDQUFDLENBQUksQ0FBQyxDQUFDO2dCQUNuRCxNQUFNLENBQUUsQ0FBQyxDQUFFO1NBQ25CLENBQUM7S0FDTDtBQUNMLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxuLyoqIFxuICog5ZWG5ZOBIO+9niDku7fmoLzljLrpl7TjgIHlupPlrZjljLrpl7TjgIHlt67ku7fjgIHmnIDkvY7ku7fmoLzvvIjlkKvlm6LotK3ku7cv5LiA5Y+j5Lu377yJXG4gKi9cbmNvbnN0IGRlbGF5ZXJpbmdHb29kID0geCA9PiB7XG4gXG4gICAgaWYgKCAheCApIHtcbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICAvLyDliJ3lp4vljJbvvJrku7fmoLzmlbDnu4TvvIjlkKvlm6LotK3ku7fjgIHnibnku7fvvIlcbiAgICBsZXQgYWxsUHJpY2VBcnI6IGFueVsgXSA9IFsgXTtcblxuICAgIC8vIOWIneWni+WMlu+8muW6k+WtmOWIl+ihqFxuICAgIGxldCBhbGxTdG9ja0FycjogYW55WyBdICA9IFsgXTtcblxuICAgIC8vIOaXoOadoeS7tuazqOWFpSDkuLvkuqflk4Ev5Z6L5Y+35Lu35qC844CB5Zui6LSt5Lu3XG4gICAgY29uc3QgZGVjb3JhdGVJdGVtID0gZ29vZCA9PiB7XG5cbiAgICAgICAgYWxsUHJpY2VBcnIucHVzaCggZ29vZC5wcmljZSApO1xuICAgICAgICBcbiAgICAgICAgaWYgKCBnb29kLnN0b2NrICkge1xuICAgICAgICAgICAgYWxsU3RvY2tBcnIucHVzaCggZ29vZC5zdG9jayApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCBnb29kLmdyb3VwUHJpY2UgKSB7XG4gICAgICAgICAgICBhbGxQcmljZUFyci5wdXNoKCBnb29kLmdyb3VwUHJpY2UgKTtcbiAgICAgICAgfVxuXG4gICAgfTtcblxuICAgIC8vIOaXoOadoeS7tuazqOWFpSDnibnku7fmtLvliqjnmoTku7fmoLzjgIHlm6LotK3ku7dcbiAgICBjb25zdCBkZWNvcmF0ZUl0ZW0yID0gYWN0aXZpdGllcyA9PiB7XG4gICAgICAgIGlmICggQXJyYXkuaXNBcnJheSggYWN0aXZpdGllcyApKSB7XG4gICAgICAgICAgICBhY3Rpdml0aWVzLm1hcCggYWMgPT4ge1xuICAgICAgICAgICAgICAgIGFsbFByaWNlQXJyLnB1c2goIGFjLmFjX3ByaWNlICk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCBhYy5hY19ncm91cFByaWNlICkge1xuICAgICAgICAgICAgICAgICAgICBhbGxQcmljZUFyci5wdXNoKCBhYy5hY19ncm91cFByaWNlICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyDml6DmnaHku7bms6jlhaUg54m55Lu35rS75Yqo55qE5Lu35qC844CB5Zui6LSt5Lu3XG4gICAgZGVjb3JhdGVJdGVtMiggeC5hY3Rpdml0aWVzICk7XG5cbiAgICAvLyDmsqHmnInlnovlj7dcbiAgICBpZiAoICF4LnN0YW5kYXJkcyB8fCB4LnN0YW5kYXJkcy5sZW5ndGggPT09IDAgKSB7XG4gICAgICAgIGRlY29yYXRlSXRlbSggeCApO1xuICAgIFxuICAgIC8vIOacieWei+WPt1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHguc3RhbmRhcmRzLm1hcCggZGVjb3JhdGVJdGVtICk7XG4gICAgfVxuXG4gICAgLy8g6YeN5paw5o6S5bqP5Lu35qC85ZKM5bqT5a2YXG4gICAgYWxsUHJpY2VBcnIgPSBhbGxQcmljZUFyci5zb3J0KCggeCwgeSApID0+IHggLSB5ICk7XG4gICAgYWxsU3RvY2tBcnIgPSBhbGxTdG9ja0Fyci5zb3J0KCggeCwgeSApID0+IHggLSB5ICk7XG5cblxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHsgfSwgeCwge1xuXG4gICAgICAgIHBpZDogeC5faWQsXG5cbiAgICAgICAgLy8g5bqT5a2Y5Yy66Ze0XG4gICAgICAgIHN0b2NrJDogYWxsU3RvY2tBcnIubGVuZ3RoID09PSAwID9cbiAgICAgICAgICAgIGFsbFN0b2NrQXJyWyAwIF0gOlxuICAgICAgICAgICAgYWxsU3RvY2tBcnJbIDAgXSA9PT0gYWxsU3RvY2tBcnJbIGFsbFN0b2NrQXJyLmxlbmd0aCAtIDEgXSA/XG4gICAgICAgICAgICAgICAgYWxsU3RvY2tBcnJbIDAgXSA6XG4gICAgICAgICAgICAgICAgYCR7YWxsU3RvY2tBcnJbIDAgXX0gfiAke2FsbFN0b2NrQXJyWyBhbGxTdG9ja0Fyci5sZW5ndGggLSAxIF19YCxcblxuICAgICAgICAvLyDku7fmoLzljLrpl7RcbiAgICAgICAgcHJpY2UkOiBhbGxQcmljZUFyci5sZW5ndGggPT09IDAgP1xuICAgICAgICAgICAgYWxsUHJpY2VBcnJbIDAgXSA6XG4gICAgICAgICAgICAgICAgYWxsUHJpY2VBcnJbIDAgXSA9PT0gYWxsUHJpY2VBcnJbIGFsbFByaWNlQXJyLmxlbmd0aCAtIDEgXSA/IFxuICAgICAgICAgICAgICAgICAgICBhbGxQcmljZUFyclsgMCBdIDpcbiAgICAgICAgICAgICAgICAgICAgYCR7YWxsUHJpY2VBcnJbIDAgXX0gfiAke2FsbFByaWNlQXJyWyBhbGxQcmljZUFyci5sZW5ndGggLSAxIF19YCxcblxuICAgICAgICAvLyDmnIDlpKfluYXluqblt67ku7dcbiAgICAgICAgcHJpY2VHYXA6IGFsbFByaWNlQXJyLmxlbmd0aCA9PT0gMCA/XG4gICAgICAgICAgICAwIDpcbiAgICAgICAgICAgIGAke2FsbFByaWNlQXJyWyBhbGxQcmljZUFyci5sZW5ndGggLSAxIF0gLSBhbGxQcmljZUFyclsgMCBdfWAsXG5cbiAgICAgICAgLy8g5pyA5L2O5Lu35qC877yI5ZCr5Zui6LSt5Lu377yJXG4gICAgICAgIGxvd2VzdF9wcmljZSQ6IGFsbFByaWNlQXJyWyAwIF0sXG5cbiAgICAgICAgLyoqIOaYr+WQpuaciea0u+WKqCAqL1xuICAgICAgICBoYXNBY3Rpdml0eTogISF4LmFjdGl2aXR5IHx8IChBcnJheS5pc0FycmF5KCB4LmFjdGl2aXRpZXMgKSAmJiB4LmFjdGl2aXRpZXMubGVuZ3RoID4gMCksXG5cbiAgICAgICAgLyoqIOaLvOWbouS/oeaBryAqL1xuICAgICAgICBnb29kUGluczogZGVhbEdvb2RQaW4oIHggKSxcblxuICAgICAgICAvKiog5qCH562+ICovXG4gICAgICAgIHRhZ1RleHQ6IHgudGFnLmpvaW4oJ+OAgScpLFxuXG4gICAgICAgIC8qKiDmmK/lkKblrZjlnKjlupPlrZjlkYrmgKUgKi9cbiAgICAgICAgb3V0U3RvY2s6IGFsbFN0b2NrQXJyLnNvbWUoIHggPT4geCA8IDEwIClcbiAgICB9KVxuXG59O1xuXG4vKiog5aSE55CG5ZWG5ZOB55qE5ou85Zui5beu5Lu377yM6L+U5Zue5ou85Zui5YiX6KGo5ZKM5ou85Zui5beu5Lu35Yy66Ze077yI5ZCr54m55Lu377yJICovXG5jb25zdCBkZWFsR29vZFBpbiA9IGdvb2QgPT4ge1xuICAgIGNvbnN0IHsgYWN0aXZpdGllcywgc3RhbmRhcmRzLCBwcmljZSwgZ3JvdXBQcmljZSB9ID0gZ29vZDtcblxuICAgIC8vIOWNleWTgSBcbiAgICBpZiAoICFzdGFuZGFyZHMgfHwgc3RhbmRhcmRzLmxlbmd0aCA9PT0gMCApIHtcbiAgICAgICAgY29uc3QgYWNUYXJnZXQgPSAhYWN0aXZpdGllcyA/XG4gICAgICAgICAgICAgICAgbnVsbCA6IFxuICAgICAgICAgICAgICAgIGFjdGl2aXRpZXMuZmluZCggYWMgPT4gYWMucGlkID09PSBnb29kLnBpZCApO1xuICAgICAgICBjb25zdCBwID0gYWNUYXJnZXQgPyBhY1RhcmdldC5hY19wcmljZSA6IHByaWNlO1xuICAgICAgICBjb25zdCBncCA9IGFjVGFyZ2V0ID8gYWNUYXJnZXQuYWNfZ3JvdXBQcmljZSA6IGdyb3VwUHJpY2U7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAvLyDmi7zlm6LliJfooahcbiAgICAgICAgICAgIGxpc3Q6IFt7XG4gICAgICAgICAgICAgICAgcHJpY2U6IHAsXG4gICAgICAgICAgICAgICAgZ3JvdXBQcmljZTogZ3BcbiAgICAgICAgICAgIH1dLFxuICAgICAgICAgICAgLy8g5q+P5a+55Y+v5ou85Zui5Z6L5Y+377yM5Y+v5LyY5oOg55qE5Lu35qC85Yy66Ze0XG4gICAgICAgICAgICBlYWNoUHJpY2VSb3VuZDogZ3AgPyBwIC0gZ3AgOiAwXG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuXG4gICAgICAgIC8qKiDlnovlj7cgKyDnibnku7cgKi9cbiAgICAgICAgY29uc3QgbWV0YSA9IHN0YW5kYXJkcy5tYXAoIHN0YW5kYXJkID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFjVGFyZ2V0ID0gIWFjdGl2aXRpZXMgP1xuICAgICAgICAgICAgICAgIG51bGwgOiBcbiAgICAgICAgICAgICAgICBhY3Rpdml0aWVzLmZpbmQoIGFjID0+IGFjLnBpZCA9PT0gc3RhbmRhcmQucGlkICYmIGFjLnNpZCA9PT0gc3RhbmRhcmQuX2lkICk7XG4gICAgICAgICAgICBpZiAoKCAhIWFjVGFyZ2V0ICYmICEhYWNUYXJnZXQuYWNfZ3JvdXBQcmljZSApIHx8IHN0YW5kYXJkLmdyb3VwUHJpY2UgKSB7XG4gICAgICAgICAgICAgICAgaWYgKCBhY1RhcmdldCApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaWNlOiBhY1RhcmdldC5hY19wcmljZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwUHJpY2U6IGFjVGFyZ2V0LmFjX2dyb3VwUHJpY2VcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmljZTogc3RhbmRhcmQucHJpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cFByaWNlOiBzdGFuZGFyZC5ncm91cFByaWNlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSkuZmlsdGVyKCB4ID0+ICEheCApO1xuXG4gICAgICAgIGNvbnN0IGRlbHRhcyA9IG1ldGEubWFwKCB4ID0+IFxuICAgICAgICAgICAgeC5wcmljZSAtICggeC5ncm91cFByaWNlIHx8IDAgKVxuICAgICAgICApLnNvcnQoKCB4LCB5ICkgPT4geSAtIHggKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbGlzdDogbWV0YSxcbiAgICAgICAgICAgIC8vIOavj+WvueWPr+aLvOWbouWei+WPt++8jOWPr+S8mOaDoOeahOS7t+agvOWMuumXtFxuICAgICAgICAgICAgZWFjaFByaWNlUm91bmQ6ICBkZWx0YXNbIGRlbHRhcy5sZW5ndGggLSAxIF0gIT09IGRlbHRhc1sgMCBdID9cbiAgICAgICAgICAgICAgICAgYCR7ZGVsdGFzWyBkZWx0YXMubGVuZ3RoIC0gMSBdfSB+ICR7ZGVsdGFzWyAwIF19YCA6XG4gICAgICAgICAgICAgICAgIGRlbHRhc1sgMCBdXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5leHBvcnQge1xuICAgIGRlbGF5ZXJpbmdHb29kXG59Il19